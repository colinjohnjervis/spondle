<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Create Event â€“ Spondle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .venue-card {
      border: 1px solid #444;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      background: #111;
      cursor: pointer;
    }
    .venue-card strong { display: block; margin-bottom: 4px; }
    .no-results { text-align: center; color: #888; margin-top: 10px; }
    .venue-form input, .venue-form button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 12px;
      box-sizing: border-box;
    }
    .input-wrapper { position: relative; }
    .clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #aaa;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-black text-white p-6">
  <h1 class="text-3xl font-bold mb-6">Create Event</h1>

  <form id="eventForm" class="space-y-6">

    <input type="text" name="event_name" placeholder="Event Name" required class="w-full p-2 rounded bg-gray-800 text-white" />
    <input type="text" name="category" placeholder="Category" required class="w-full p-2 rounded bg-gray-800 text-white" />
    <input type="text" name="image_url" placeholder="Image URL" class="w-full p-2 rounded bg-gray-800 text-white" />
    <select name="publish_status" required class="w-full p-2 rounded bg-gray-800 text-white">
      <option value="Draft">Draft</option>
      <option value="Published" selected>Published</option>
    </select>
    <textarea name="description" placeholder="Description" class="w-full p-2 rounded bg-gray-800 text-white"></textarea>

    <div class="flex space-x-2">
      <button type="button" class="tab-btn bg-blue-500 px-4 py-2 rounded" data-type="single">Single</button>
      <button type="button" class="tab-btn bg-gray-700 px-4 py-2 rounded" data-type="recurring">Recurring</button>
      <button type="button" class="tab-btn bg-gray-700 px-4 py-2 rounded" data-type="tour">Tour</button>
    </div>

    <div id="tab-content"></div>

    <input type="submit" value="Submit Event" class="w-full p-3 bg-green-500 text-black font-bold rounded cursor-pointer" />
    <div id="error-message" class="text-red-500 mt-4 hidden"></div>
  </form>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://jvuunvnbpdfrttusgelz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY'
    );

    const form = document.getElementById('eventForm');
    const tabContent = document.getElementById('tab-content');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const errorMessage = document.getElementById('error-message');

    const views = {
      single: () => `
        <div class="venue-block">
          <input class="search w-full p-2 rounded bg-gray-800 text-white" type="text" placeholder="Search venue..." />
          <div class="results mt-2"></div>
          <input name="event_date[]" type="date" class="w-full p-2 mt-2 rounded bg-gray-800 text-white" />
          <input name="event_time[]" type="time" class="w-full p-2 mt-2 rounded bg-gray-800 text-white" />
          <input name="tickets_url[]" type="url" class="w-full p-2 mt-2 rounded bg-gray-800 text-white" placeholder="Ticket URL (optional)" />
        </div>
      `,
      recurring: () => `
        <div class="venue-block">
          <input class="search w-full p-2 rounded bg-gray-800 text-white" type="text" placeholder="Search venue..." />
          <div class="results mt-2"></div>
          <label class="block mt-4">Pick multiple dates:</label>
          <input name="event_date[]" type="date" multiple class="w-full p-2 rounded bg-gray-800 text-white" />
          <input name="event_time[]" type="time" class="w-full p-2 mt-2 rounded bg-gray-800 text-white" />
          <input name="tickets_url[]" type="url" class="w-full p-2 mt-2 rounded bg-gray-800 text-white" placeholder="Ticket URL (optional)" />
        </div>
      `,
      tour: () => `
        <div class="tour-blocks space-y-4">
          ${Array.from({ length: 2 }).map(() => `
            <div class="venue-block border p-4 rounded-lg">
              <input class="search w-full p-2 rounded bg-gray-800 text-white" type="text" placeholder="Search venue..." />
              <div class="results mt-2"></div>
              <input name="event_date[]" type="date" class="w-full p-2 mt-2 rounded bg-gray-800 text-white" />
              <input name="event_time[]" type="time" class="w-full p-2 mt-2 rounded bg-gray-800 text-white" />
              <input name="tickets_url[]" type="url" class="w-full p-2 mt-2 rounded bg-gray-800 text-white" placeholder="Ticket URL (optional)" />
            </div>
          `).join('')}
        </div>
      `
    };

    function loadTab(type) {
      tabContent.innerHTML = views[type]();
      wireVenueSearch();

      tabBtns.forEach(b => b.classList.remove('bg-blue-500'));
      document.querySelector(`.tab-btn[data-type="${type}"]`).classList.add('bg-blue-500');
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => loadTab(btn.dataset.type));
    });

    async function wireVenueSearch() {
      const searchBoxes = tabContent.querySelectorAll('.search');
      searchBoxes.forEach(input => {
        const resultsBox = input.nextElementSibling;
        input.addEventListener('input', async () => {
          const keyword = input.value.trim();
          resultsBox.innerHTML = '';
          if (keyword.length < 2) return;
          const { data } = await supabase
            .from('venues')
            .select('id, venue_name, town_city')
            .ilike('venue_name', `%${keyword}%`)
            .limit(5);
          if (data?.length) {
            data.forEach(v => {
              const div = document.createElement('div');
              div.className = 'venue-card';
              div.innerHTML = `<strong>${v.venue_name}</strong><span>${v.town_city}</span>`;
              div.addEventListener('click', () => {
                input.value = v.venue_name;
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'venue_id[]';
                hidden.value = v.id;
                input.parentElement.appendChild(hidden);
                resultsBox.innerHTML = '';
              });
              resultsBox.appendChild(div);
            });
          } else {
            resultsBox.innerHTML = `<div class="no-results">No venues found</div>`;
          }
        });
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMessage.classList.add('hidden');
      errorMessage.textContent = '';

      const formData = new FormData(form);
      const baseData = {
        event_name: formData.get('event_name'),
        category: formData.get('category'),
        publish_status: formData.get('publish_status'),
        image_url: formData.get('image_url'),
        description: formData.get('description')
      };

      const venueIds = formData.getAll('venue_id[]');
      const dates = formData.getAll('event_date[]');
      const times = formData.getAll('event_time[]');
      const ticketLinks = formData.getAll('tickets_url[]');

      for (let i = 0; i < venueIds.length; i++) {
        const event = {
          ...baseData,
          venue_id: venueIds[i],
          event_date: dates[i] || null,
          event_time: times[i] || null,
          tickets_url: ticketLinks[i] || null
        };
        const { error } = await supabase.from('events').insert([event]);
        if (error) {
          errorMessage.textContent = `Failed to save event: ${error.message}`;
          errorMessage.classList.remove('hidden');
          return;
        }
      }

      alert('Event(s) submitted!');
      form.reset();
      loadTab('single');
    });

    loadTab('single'); // Default load
  </script>
</body>
</html>
