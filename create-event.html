<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Event – Spondle (Template)</title>
  <meta name="color-scheme" content="dark" />

  <!-- Tailwind + Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>

  <!-- Flowbite Datepicker (for schedule drop-in later) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.js"></script>

  <!-- (Optional) Your global CSS -->
  <link rel="stylesheet" href="./spondle-layout.css?v=global-9">
  <link rel="stylesheet" href="./styles.css?v=global-9">

<style>
  /* === Lifted 1:1 from image-carousel.html === */
  body { 
    background:#000; 
    color:#fff; 
    font-family:ui-sans-serif,system-ui,sans-serif; 
    min-height:100vh; 
  }

  .card { 
    background:#0f172a; 
    border-radius:16px; 
    box-shadow:0 10px 30px rgba(0,0,0,.45); 
  }

  .input-dark { 
    background:#0b1220; 
    color:#fff; 
    width:100%; 
  }

  .input-dark::placeholder { 
    color:#9ca3af; 
  }

  .input-dark:focus { 
    border-color:#3b82f6 !important; 
    outline:none; 
    box-shadow:0 0 0 1.5px #3b82f6; 
  }

  /* dashed placeholder panels to mirror your demo look */
  .placeholder-panel { 
    border:1px dashed #374151; 
    background:#0b1220; 
    border-radius:12px; 
  }
  
  /* === Restore original schedule.html dropdown styling === */
  #card-schedule .results-pop {
    position: absolute;
    left: -6px;
    right: -6px;
    top: calc(100% + 6px);
    z-index: 60;
    background: #0f172a;
    border-radius: 12px;
    padding: 10px;
  }

  #card-schedule .venue-card {
    background: #111827;
    border: 1px solid #374151;
    border-radius: 12px;
    padding: 12px 14px;
    margin: 8px 0;
    transition: background 0.15s ease;
  }

  #card-schedule .venue-card:hover {
    background: #1b2433;
    cursor: pointer;
  }

  #card-schedule .no-results {
    padding: 12px 14px;
    background: #111827;
    border: 1px solid #374151;
    border-radius: 12px;
    text-align: center;
    color: #9ca3af;
    margin: 8px 0;
    cursor: pointer;
  }

  #card-schedule .no-results:hover {
    background: #1b2433;
  }

  /* === Final fix: clean start below sticky header (no dark band, no overlap) === */
  #spondle-header {
    background: transparent !important;
    box-shadow: none !important;
    border-bottom: none !important;
  }

  body {
    background: #000 !important;
    padding-top: 36px !important; /* ensures content starts below sticky header */
  }
</style>
   
</head>

<body>

  <!-- Header / Sidebar / Overlay hooks -->
  <header id="spondle-header"></header>
  <aside id="spondle-sidebar"></aside>
  <div id="overlay"></div>

  <main class="max-w-2xl mx-auto px-3 sm:px-6 pt-6 pb-10 -mt-2">
    <form id="create-event-form" class="space-y-6">

      <!-- =========================
           SECTION 1: EVENT BASICS
           ========================= -->
      <section class="card w-full px-3 sm:px-6 py-6" id="card-event-basics">
        <h1 class="text-3xl font-bold text-white mb-6">Event Basics</h1>

        <div class="mb-5">
          <label for="event_name" class="block text-sm text-gray-300 mb-2">Event Name</label>
          <input id="event_name" name="event_name" type="text"
                 class="input-dark p-3 rounded-lg border border-gray-700"
                 placeholder="e.g. Friday Night Comedy" />
        </div>

        <div>
          <label for="description" class="block text-sm text-gray-300 mb-2">Description</label>
          <textarea id="description" name="description" rows="6"
                    class="input-dark p-3 rounded-lg border border-gray-700"
                    placeholder="Tell people what this event is about..."></textarea>
        </div>
      </section>

<!-- =========================
     ===== IMAGE CAROUSEL START =====
     SECTION 2: IMAGE CAROUSEL (Category + Carousel)
     ===== IMAGE CAROUSEL END =====
     ========================= -->
<section class="card w-full px-3 sm:px-6 py-6" id="card-image-carousel">
  <h2 class="text-3xl font-bold text-white mb-6">Images &amp; Category</h2>

  <style>
    #card-image-carousel .input-dark { background:#0b1220; color:#fff; width:100%; appearance:auto; }
    #card-image-carousel .input-dark::placeholder { color:#9ca3af; }
    #card-image-carousel .input-dark:focus { border-color:#3b82f6 !important; outline:none; box-shadow:0 0 0 1.5px #3b82f6; }

    #card-image-carousel .nav-btn {
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(0,0,0,.55); border:1px solid #374151;
      width:40px; height:40px; border-radius:9999px;
      display:flex; align-items:center; justify-content:center;
      color:#e5e7eb; z-index:10;
    }
    #card-image-carousel .nav-btn:hover { background:rgba(0,0,0,.75); color:#fff; border-color:#4b5563; }
    #card-image-carousel .nav-left  { left:10px; }
    #card-image-carousel .nav-right { right:10px; }

    #card-image-carousel .dot { width:8px; height:8px; border-radius:9999px; display:inline-block; background:#374151; margin:0 4px; }
    #card-image-carousel .dot-active { background:#3b82f6; }

    #card-image-carousel .slider-wrapper {
      position:relative;
      overflow:hidden;
      border-radius:12px;
      border:1px solid #374151;
      background:#0b1220;
      height:24rem;
    }
    #card-image-carousel .slider {
      display:flex;
      transition:transform 0.6s ease-in-out;
      height:100%;
    }
    #card-image-carousel .slide {
      flex-shrink:0;
      width:100%;
      height:100%;
      position:relative;
    }
    #card-image-carousel .slide img {
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:12px;
    }
  </style>

  <div class="mb-6">
    <label for="category" class="block text-sm text-gray-300 mb-2">Event Category &amp; Image</label>
    <select id="category" class="input-dark p-3 rounded-lg border border-gray-700 appearance-auto">
      <option value="">Select category</option>
      <option value="music">Music</option>
      <option value="comedy">Comedy</option>
      <option value="theatre">Theatre</option>
      <option value="sports">Sports</option>
      <option value="festival">Festival</option>
      <option value="quiz">Quiz Night</option>
    </select>
  </div>

  <div class="relative w-full">
    <div class="slider-wrapper">
      <div id="slider" class="slider">
        <div class="slide">
          <img src="./images/file_000000002f686243b31639a2bca68eca.png" alt="Placeholder" />
        </div>
      </div>
    </div>

    <!-- FIX: added type="button" -->
    <button id="prevBtn" type="button" class="nav-btn nav-left hidden" aria-label="Previous">&#10094;</button>
    <button id="nextBtn" type="button" class="nav-btn nav-right hidden" aria-label="Next">&#10095;</button>
  </div>

  <div id="dots" class="flex items-center justify-center mt-4 min-h-6"></div>

  <script>
    const carouselScope = document.querySelector('#card-image-carousel');
    const catSel = carouselScope.querySelector('#category');
    const slider = carouselScope.querySelector('#slider');
    const dots = carouselScope.querySelector('#dots');
    const prevBtn = carouselScope.querySelector('#prevBtn');
    const nextBtn = carouselScope.querySelector('#nextBtn');

    const IMG_W = 1600, IMG_Q = 70;
    const u = id => `https://images.unsplash.com/photo-${id}?auto=format&fit=crop&w=${IMG_W}&q=${IMG_Q}`;
    const stock = {
      music: [u("1511379938547-c1f69419868d"),u("1506157786151-b8491531f063"),u("1507874457470-272b3c8d8ee2"),u("1470225620780-dba8ba36b745"),u("1497032628192-86f99bcd76bc")],
      comedy: [u("1511671782779-c97d3d27a1d4"),u("1485217988980-11786ced9454"),u("1475724017904-b712052c192a"),u("1515165562835-c3b8c34a47af"),u("1492684223066-81342ee5ff30")],
      theatre: [u("1500530855697-b586d89ba3ee"),u("1485562298395-226cb9c57f45"),u("1442504028989-ab58b5f29a4a"),u("1501785888041-af3ef285b470"),u("1515169067865-5387ec356754")],
      sports: [u("1461896836934-ffe607ba8211"),u("1502877338535-766e1452684a"),u("1505839673365-e3971f8d9184"),u("1521412644187-c49fa049e84d"),u("1508804185872-d7badad00f7d")],
      festival: [u("1533105079780-92b9be482077"),u("1492683513054-55277abccd3c"),u("1500534314209-a25ddb2bd429"),u("1502136969935-8d0710a0d652"),u("1495567720989-cebdbdd97913")],
      quiz: [u("1483721310020-03333e577078"),u("1512428559087-560fa5ceab42"),u("1496307042754-b4aa456c4a2d"),u("1504711434969-e33886168f5c"),u("1514525253161-7a46d19cd819")]
    };

    let currentCategory = "", currentIndex = 0, slides = [];

    function preloadImages(urls){ urls.forEach(src => { const img = new Image(); img.src = src; }); }

    function renderSlides(images) {
      slider.innerHTML = "";
      slides = images.map(src => {
        const div = document.createElement("div");
        div.className = "slide";
        const img = document.createElement("img");
        img.src = src;
        img.alt = "Event image";
        div.appendChild(img);
        slider.appendChild(div);
        return div;
      });
      updateSliderPosition();
    }

    function renderDots(count) {
      dots.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const dot = document.createElement("span");
        dot.className = "dot" + (i === currentIndex ? " dot-active" : "");
        dot.addEventListener("click", () => { currentIndex = i; updateSliderPosition(); });
        dots.appendChild(dot);
      }
    }

    function updateSliderPosition() {
      slider.style.transform = `translateX(-${currentIndex * 100}%)`;
      dots.querySelectorAll(".dot").forEach((d, i) => d.classList.toggle("dot-active", i === currentIndex));
    }

    function setControlsVisible(v) {
      prevBtn.classList.toggle("hidden", !v);
      nextBtn.classList.toggle("hidden", !v);
      dots.classList.toggle("invisible", !v);
    }

    function selectCategory(cat) {
      currentCategory = cat; currentIndex = 0;
      if (!cat) {
        slider.innerHTML = `<div class="slide"><img src="./images/file_000000002f686243b31639a2bca68eca.png" alt="Placeholder" /></div>`;
        setControlsVisible(false); dots.innerHTML = "";
        return;
      }
      const imgs = stock[cat];
      preloadImages(imgs);
      renderSlides(imgs);
      renderDots(imgs.length);
      setControlsVisible(true);
    }

    catSel.addEventListener("change", e => selectCategory(e.target.value));
    prevBtn.addEventListener("click", () => {
      if (!currentCategory) return;
      currentIndex = (currentIndex - 1 + slides.length) % slides.length;
      updateSliderPosition();
    });
    nextBtn.addEventListener("click", () => {
      if (!currentCategory) return;
      currentIndex = (currentIndex + 1) % slides.length;
      updateSliderPosition();
    });

    let startX = 0;
    slider.addEventListener("touchstart", e => { startX = e.touches[0].clientX; }, false);
    slider.addEventListener("touchend", e => {
      if (!currentCategory) return;
      const diff = e.changedTouches[0].clientX - startX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) currentIndex = (currentIndex - 1 + slides.length) % slides.length;
        else currentIndex = (currentIndex + 1) % slides.length;
        updateSliderPosition();
      }
    }, false);

    selectCategory("");
  </script>
</section>
    
<!-- =========================
     SECTION: Schedule
     ========================= -->
<section class="card w-full px-3 sm:px-6 py-6" id="card-schedule">
  <h2 class="text-3xl font-bold text-white mb-6">Schedule</h2>

  <style>
    .pill {
      width: 50%;
      text-align: center;
      font-weight: 600;
      padding: 0.75rem 0;
      border-radius: 9999px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .pill-on {
      background: #3b82f6;
      color: #000;
    }
    .pill-off {
      background: #1e293b;
      color: #9ca3af;
    }
    .pill-off:hover {
      background: #334155;
      color: #fff;
    }
  </style>

  <div class="flex w-full gap-3 mb-6">
    <button id="tabSingle" type="button" class="pill pill-on">Single / Recurring</button>
    <button id="tabTour" type="button" class="pill pill-off">Tour Schedule</button>
  </div>

  <!-- SINGLE / RECURRING -->
  <div id="panelSingle">
    <div class="mb-6 relative">
      <label class="block text-sm text-gray-300 mb-2">Venue</label>
      <div class="input-wrapper relative">
        <input id="srVenueSearch" type="text" placeholder="Search by venue name..."
               class="input-dark p-3 rounded-lg border border-gray-700">
        <button id="srVenueClear" type="button"
                class="absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
        <div id="srResultsPop" class="results-pop hidden">
          <div id="srVenueResults"></div>
          <div id="srNoVenueResults" class="no-results hidden">
            No matches found.<br><span class="text-blue-400 underline">+ Add new venue</span>
          </div>
        </div>
      </div>

      <input id="srVenueId" type="text" readonly
             placeholder="Venue ID will appear here"
             class="input-dark p-3 rounded-lg border border-gray-700 text-blue-400 mt-2">
      <input id="srTicketLink" type="text"
             placeholder="Ticket link (optional) e.g. https://ticketsite.com/event123"
             class="input-dark p-3 rounded-lg border border-gray-700 text-gray-300 mt-2">

      <div id="srNewVenueForm" class="hidden mt-4 space-y-2">
        <input id="srNewName" type="text" placeholder="Venue name"
               class="input-dark p-3 rounded-lg border border-gray-700 w-full">
        <input id="srNewStreet" type="text" placeholder="Street address"
               class="input-dark p-3 rounded-lg border border-gray-700 w-full">
        <input id="srNewPC" type="text" placeholder="Postcode"
               class="input-dark p-3 rounded-lg border border-gray-700 w-full">
        <button id="srCreateVenue"
                class="bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-2 rounded-lg w-full">
          Create Venue
        </button>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4 items-end mb-4">
      <div>
        <label class="block text-sm text-gray-300 mb-2">From</label>
        <input id="fromDate" type="text" readonly
               class="input-dark p-3 rounded-lg border border-gray-700"
               placeholder="DD/MM/YYYY">
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-2">Time</label>
        <select id="fromTime"
                class="input-dark p-3 rounded-lg border border-gray-700"></select>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4 items-end mb-4">
      <div>
        <label class="block text-sm text-gray-300 mb-2">To</label>
        <input id="toDate" type="text" readonly
               class="input-dark p-3 rounded-lg border border-gray-700"
               placeholder="DD/MM/YYYY">
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-2">Time</label>
        <select id="toTime"
                class="input-dark p-3 rounded-lg border border-gray-700"></select>
      </div>
    </div>

    <div class="mb-4">
      <label class="block text-sm text-gray-300 mb-2">Repeat</label>
      <select id="repeatType"
              class="input-dark p-3 rounded-lg border border-gray-700 w-full">
        <option value="none">Does not repeat</option>
        <option value="everyday">Every day</option>
        <option value="everyweek">Every week</option>
        <option value="every2weeks">Every 2 weeks</option>
        <option value="everymonth">Every month</option>
        <option value="everyyear">Every year</option>
      </select>
    </div>

    <div id="repeatUntilWrap" class="hidden mb-4">
      <label class="block text-sm text-gray-300 mb-2">Repeat until</label>
      <input id="repeatUntil" type="text" readonly
             class="input-dark p-3 rounded-lg border border-gray-700"
             placeholder="DD/MM/YYYY">
    </div>
  </div>

  <!-- TOUR SCHEDULE -->
  <div id="panelTour" class="hidden">
    <div id="tourRoot"></div>
    <button id="addTourBlockBtn" type="button"
            class="mt-6 bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-3 rounded-lg w-full">
      + Add another venue/date
    </button>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  // ✅ Reuse global Supabase client
  const supabase = window.supabaseClient 
    || window.supabase.createClient(
      "https://jvuunvnbpdfrttusgelz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dVVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY"
    );

  /* ---------- Helpers ---------- */
  const formatUK = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
  const parseUK  = s => { const [dd,mm,yyyy]=s.split('/').map(n=>parseInt(n,10)); return new Date(yyyy,mm-1,dd); };
  const today = new Date();
  const addMonths = (d,n)=>{const x=new Date(d);x.setMonth(x.getMonth()+n);return x;};
  const fillTimes = sel => { sel.innerHTML=''; for(let m=0;m<24*60;m+=15){ const hh=Math.floor(m/60),mm=m%60; const label=`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; sel.add(new Option(label,label)); }};

/* =====================================================
   Subsection: Date & Time Logic (universal initializer)
   ===================================================== */
function initDateTimePair({
  fromDateEl,
  toDateEl,
  fromTimeEl,
  toTimeEl,
  defaultFromDate = today,
  defaultFromTime = '10:00',
  defaultToTime   = '11:00'
}) {
  // --- Populate time dropdowns if needed ---
  if (fromTimeEl && !fromTimeEl.options.length) fillTimes(fromTimeEl);
  if (toTimeEl && !toTimeEl.options.length) fillTimes(toTimeEl);

  // --- Set default values ---
  if (fromTimeEl) fromTimeEl.value = defaultFromTime;
  if (toTimeEl)   toTimeEl.value   = defaultToTime;
  if (fromDateEl && !fromDateEl.value) fromDateEl.value = formatUK(defaultFromDate);
  if (toDateEl   && !toDateEl.value)   toDateEl.value   = formatUK(defaultFromDate);

  // --- Initialise datepickers ---
  const fromDP = new Datepicker(fromDateEl, {
    autohide: true, defaultDate: defaultFromDate,
    language: 'en-GB', format: 'dd/mm/yyyy'
  });
  const toDP = new Datepicker(toDateEl, {
    autohide: true, defaultDate: defaultFromDate,
    language: 'en-GB', format: 'dd/mm/yyyy'
  });

  // --- Open pickers on click ---
  fromDateEl.onclick = () => fromDP.show();
  toDateEl.onclick   = () => toDP.show();

  // --- Track manual vs programmatic changes ---
  let toDateManuallyEdited = false;
  let toTimeManuallyEdited = false;
  let programmaticToDateSet = false;
  let userIntendsToEditToDate = false;

  // Detect user intention to edit "To" date
  ['mousedown','touchstart','focus'].forEach(evt =>
    toDateEl.addEventListener(evt, () => { userIntendsToEditToDate = true; }, { passive: true })
  );

  // Mark manual edit only when changeDate fires without our programmatic guard
  toDateEl.addEventListener('changeDate', () => {
    if (programmaticToDateSet) {
      programmaticToDateSet = false;
    } else {
      toDateManuallyEdited = true;
    }
    userIntendsToEditToDate = false;
  });

  // Track manual "To" time edits
  toTimeEl.addEventListener('change', () => { toTimeManuallyEdited = true; });

  // --- Date sync logic ---
  fromDateEl.addEventListener('changeDate', () => {
    const f = parseUK(fromDateEl.value);
    const t = parseUK(toDateEl.value);

    // Sync if user hasn't manually edited OR if "to" is now earlier than "from"
    if (!toDateManuallyEdited || t < f) {
      toDateEl.value = fromDateEl.value;
      programmaticToDateSet = true;
      toDP.setDate(f);
    }
  });

  // --- Time sync + overnight handling ---
  fromTimeEl.addEventListener('change', () => {
    const [fh,fm] = fromTimeEl.value.split(':').map(Number);
    const [th,tm] = toTimeEl.value.split(':').map(Number);
    const fmins = fh * 60 + fm;
    const tmins = th * 60 + tm;

    // If user hasn't manually changed "To" time, maintain +1h offset
    if (!toTimeManuallyEdited) {
      const bump = fmins + 60;
      const hh = String(Math.floor(bump / 60) % 24).padStart(2, '0');
      const mm = String(bump % 60).padStart(2, '0');
      toTimeEl.value = `${hh}:${mm}`;

      // If bump passed midnight, move To Date +1
      if (Math.floor(bump / 60) >= 24) {
        const curToDate = parseUK(toDateEl.value);
        curToDate.setDate(curToDate.getDate() + 1);
        toDateEl.value = formatUK(curToDate);
        programmaticToDateSet = true;
        toDP.setDate(curToDate);
      }
      return;
    }

    // If "To" time is <= "From" time, bump +1h to maintain logical order
    if (tmins <= fmins) {
      const bump = fmins + 60;
      const hh = String(Math.floor(bump / 60) % 24).padStart(2, '0');
      const mm = String(bump % 60).padStart(2, '0');
      toTimeEl.value = `${hh}:${mm}`;

      // Overnight bump if needed
      if (Math.floor(bump / 60) >= 24) {
        const curToDate = parseUK(toDateEl.value);
        curToDate.setDate(curToDate.getDate() + 1);
        toDateEl.value = formatUK(curToDate);
        programmaticToDateSet = true;
        toDP.setDate(curToDate);
      }
    }
  });

  // If user sets "To" time manually to before "From" time, assume next day
  toTimeEl.addEventListener('change', () => {
    const [fh,fm] = fromTimeEl.value.split(':').map(Number);
    const [th,tm] = toTimeEl.value.split(':').map(Number);
    const fmins = fh * 60 + fm;
    const tmins = th * 60 + tm;

    if (tmins < fmins) {
      const curToDate = parseUK(toDateEl.value);
      curToDate.setDate(curToDate.getDate() + 1);
      toDateEl.value = formatUK(curToDate);
      programmaticToDateSet = true;
      toDP.setDate(curToDate);
    }
  });

  return { fromDP, toDP };
}
/* ===== End of Date & Time Logic ===== */

  /* ---------- Venue Search (Single/Recurring) ---------- */
  const srSearch = document.getElementById('srVenueSearch');
  const srClear = document.getElementById('srVenueClear');
  const srResultsPop = document.getElementById('srResultsPop');
  const srResults = document.getElementById('srVenueResults');
  const srNoResults = document.getElementById('srNoVenueResults');
  const srVenueId = document.getElementById('srVenueId');
  const srNewForm = document.getElementById('srNewVenueForm');
  const srNewName = document.getElementById('srNewName');
  const srNewStreet = document.getElementById('srNewStreet');
  const srNewPC = document.getElementById('srNewPC');
  const srCreateVenue = document.getElementById('srCreateVenue');
  let srTimeout;

  async function searchVenuesRelevance(query) {
    const clean = query.replace(/[^a-zA-Z0-9\s'-]/g, '').trim();
    if (!clean) return [];
    const { data } = await supabase
      .from('venues')
      .select('id, venue_name, street_name, postcode')
      .ilike('venue_name', `%${clean}%`);
    if (!data) return [];
    const startsWith = data.filter(v => v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
    const others = data.filter(v => !v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
    return [...startsWith, ...others].slice(0, 5);
  }

  function renderSrVenues(list) {
    srResults.innerHTML = ''; srNoResults.classList.add('hidden');
    if (!list.length) { srNoResults.classList.remove('hidden'); return; }
    list.forEach(v => {
      const div = document.createElement('div');
      div.className = 'venue-card';
      div.innerHTML = `<div class="font-semibold">${v.venue_name}</div>
                       <div class="text-gray-300">${[v.street_name, v.postcode].filter(Boolean).join(', ')}</div>`;
      div.onclick = () => { srSearch.value = v.venue_name; srVenueId.value = v.id; srResultsPop.classList.add('hidden'); srNewForm.classList.add('hidden'); };
      srResults.appendChild(div);
    });
  }

  srSearch.oninput = () => {
    clearTimeout(srTimeout);
    const val = srSearch.value.trim();
    if (!val) { srResults.innerHTML=''; srResultsPop.classList.add('hidden'); return; }
    srTimeout = setTimeout(async () => {
      const results = await searchVenuesRelevance(val);
      renderSrVenues(results);
      srResultsPop.classList.remove('hidden');
    }, 250);
  };

  srSearch.onfocus = () => { if (srResults.children.length) srResultsPop.classList.remove('hidden'); };
  srClear.onclick = () => { srSearch.value=''; srVenueId.value=''; srResults.innerHTML=''; srResultsPop.classList.add('hidden'); };
  srNoResults.onclick = () => { srResultsPop.classList.add('hidden'); srNewForm.classList.remove('hidden'); };
  srCreateVenue.onclick = async () => {
    const n = srNewName.value.trim(), s = srNewStreet.value.trim(), p = srNewPC.value.trim();
    if (!n) return;
    const { data } = await supabase.from('venues').insert([{ venue_name: n, street_name: s, postcode: p }]).select('id').single();
    srVenueId.value = data.id; srSearch.value = n; srNewForm.classList.add('hidden');
    srNewName.value=''; srNewStreet.value=''; srNewPC.value='';
  };

  /* ---------- Dates & Repeat (Single/Recurring) ---------- */
  const fromDateEl=document.getElementById('fromDate');
  const toDateEl=document.getElementById('toDate');
  const fromTimeEl=document.getElementById('fromTime');
  const toTimeEl=document.getElementById('toTime');

  // Initialize main pair via the universal initializer
  initDateTimePair({
    fromDateEl, toDateEl, fromTimeEl, toTimeEl,
    defaultFromDate: today,
    defaultFromTime: '10:00',
    defaultToTime: '11:00'
  });

  const repeatTypeEl=document.getElementById('repeatType');
  const repeatUntilWrap=document.getElementById('repeatUntilWrap');
  const repeatUntilEl=document.getElementById('repeatUntil');
  const untilDP=new Datepicker(repeatUntilEl,{autohide:true,language:'en-GB',format:'dd/mm/yyyy'});
  repeatUntilEl.onclick=()=>untilDP.show();

  function toggleRepeatUntil() {
    const hasRepeat = repeatTypeEl.value !== 'none';
    repeatUntilWrap.classList.toggle('hidden', !hasRepeat);
    if (hasRepeat) {
      const start=parseUK(fromDateEl.value);
      const limit=addMonths(start,12);
      untilDP.setOptions({maxDate:limit});
      repeatUntilEl.value=formatUK(start);
    }
  }
  repeatTypeEl.addEventListener('change',toggleRepeatUntil);
  toggleRepeatUntil();

  /* ---------- Tabs & Tour Schedule ---------- */
  const tabSingle=document.getElementById('tabSingle');
  const tabTour=document.getElementById('tabTour');
  const panelSingle=document.getElementById('panelSingle');
  const panelTour=document.getElementById('panelTour');
  const tourRoot=document.getElementById('tourRoot');
  const addTourBtn=document.getElementById('addTourBlockBtn');

  function setTab(which){
    if(which==='single'){
      tabSingle.classList.add('pill-on'); tabSingle.classList.remove('pill-off');
      tabTour.classList.add('pill-off'); tabTour.classList.remove('pill-on');
      panelSingle.classList.remove('hidden'); panelTour.classList.add('hidden');
    } else {
      tabTour.classList.add('pill-on'); tabTour.classList.remove('pill-off');
      tabSingle.classList.add('pill-off'); tabSingle.classList.remove('pill-on');
      panelTour.classList.remove('hidden'); panelSingle.classList.add('hidden');
      if(!panelTour.dataset.init){ addTourBlock(true); panelTour.dataset.init='1'; }
    }
  }
  tabSingle.onclick=()=>setTab('single');
  tabTour.onclick=()=>setTab('tour');

  /* ---------- Tour Schedule Blocks ---------- */
  function addTourBlock(isFirst=false){
    if(tourRoot.children.length){
      const sep=document.createElement('div');
      sep.className='h-px bg-blue-500 my-6';
      tourRoot.appendChild(sep);
    }

    const root=document.createElement('div');
    root.innerHTML=`
      <div class="mb-6 relative">
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm text-gray-300">Venue</label>
          ${!isFirst ? '<button type="button" class="tour-inline-remove removeBtn" title="Remove">×</button>' : ''}
        </div>
        <div class="input-wrapper relative">
          <input type="text" placeholder="Search by venue name..." class="venueSearch input-dark p-3 rounded-lg border border-gray-700 focus:border-blue-500">
          <button type="button" class="clearVenue absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
          <div class="results-pop hidden">
            <div class="venueResults"></div>
            <div class="noVenueResults no-results hidden">No matches found.<br><span class="text-blue-400 underline">+ Add new venue</span></div>
          </div>
        </div>
        <input type="text" readonly placeholder="Venue ID will appear here" class="venueId input-dark p-3 rounded-lg border border-gray-700 text-blue-400 mt-2">
        <input type="text" placeholder="Ticket link (optional) e.g. https://ticketsite.com/event123" class="ticketLink input-dark p-3 rounded-lg border border-gray-700 text-gray-300 mt-2">
        <div class="newVenueForm hidden mt-4 space-y-2">
          <input type="text" placeholder="Venue name" class="newVenueName input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input type="text" placeholder="Street address" class="newVenueStreet input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input type="text" placeholder="Postcode" class="newVenuePostcode input-dark p-3 rounded-lg border border-gray-700 w-full">
          <button class="createVenueBtn bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 items-end">
        <div><label class="block text-sm text-gray-300 mb-2">From</label><input type="text" readonly class="fromDate input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" /></div>
        <div><label class="block text-sm text-gray-300 mb-2">Time</label><select class="fromTime input-dark p-3 rounded-lg border border-gray-700"></select></div>
      </div>
      <div class="grid grid-cols-2 gap-4 items-end mt-6">
        <div><label class="block text-sm text-gray-300 mb-2">To</label><input type="text" readonly class="toDate input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" /></div>
        <div><label class="block text-sm text-gray-300 mb-2">Time</label><select class="toTime input-dark p-3 rounded-lg border border-gray-700"></select></div>
      </div>
    `;
    tourRoot.appendChild(root);
    initTourBlock(root,isFirst);
  }

  addTourBtn.onclick=()=>addTourBlock(false);

  async function searchVenues(q){
    const clean=q.replace(/[^a-zA-Z0-9\s'-]/g,'').trim();
    if(!clean) return [];
    const {data}=await supabase
      .from('venues')
      .select('id, venue_name, street_name, postcode')
      .ilike('venue_name',`%${clean}%`);
    if(!data) return [];
    const startsWith=data.filter(v=>v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
    const others=data.filter(v=>!v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
    return [...startsWith,...others].slice(0,5);
  }

  function initTourBlock(scope,isFirst){
    const removeBtn=scope.querySelector('.removeBtn');
    if(removeBtn){
      removeBtn.onclick=()=>{
        const prev=scope.previousElementSibling;
        if(prev && prev.classList.contains('h-px')) prev.remove();
        scope.remove();
      };
    }

    const vSearch=scope.querySelector('.venueSearch');
    const vId=scope.querySelector('.venueId');
    const results=scope.querySelector('.results-pop');
    const vResults=scope.querySelector('.venueResults');
    const noResults=scope.querySelector('.noVenueResults');
    const newForm=scope.querySelector('.newVenueForm');
    const clearBtn=scope.querySelector('.clearVenue');
    const nName=scope.querySelector('.newVenueName');
    const nStreet=scope.querySelector('.newVenueStreet');
    const nPost=scope.querySelector('.newVenuePostcode');
    const createBtn=scope.querySelector('.createVenueBtn');

    const fromDate=scope.querySelector('.fromDate');
    const toDate=scope.querySelector('.toDate');
    const fromTime=scope.querySelector('.fromTime');
    const toTime=scope.querySelector('.toTime');

    let timeout;

    function open(){results.classList.remove('hidden');}
    function close(){results.classList.add('hidden');}
    function render(list){
      vResults.innerHTML=''; noResults.classList.add('hidden');
      if(!list.length){ noResults.classList.remove('hidden'); return; }
      list.forEach(v=>{
        const div=document.createElement('div');
        div.className='venue-card';
        div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
                       <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
        div.onclick=()=>{ vSearch.value=v.venue_name; vId.value=v.id; close(); newForm.classList.add('hidden'); };
        vResults.appendChild(div);
      });
    }

    vSearch.oninput=()=>{
      clearTimeout(timeout);
      const q=vSearch.value.trim();
      if(!q){ vResults.innerHTML=''; close(); return; }
      timeout=setTimeout(async()=>{ const list=await searchVenues(q); render(list); open(); },250);
    };
    vSearch.onfocus=()=>{ if(vResults.children.length) open(); };
    clearBtn.onclick=()=>{ vSearch.value=''; vId.value=''; vResults.innerHTML=''; close(); newForm.classList.add('hidden'); };
    noResults.onclick=()=>{ close(); newForm.classList.remove('hidden'); };
    createBtn.onclick=async()=>{
      const name=nName.value.trim(), street=nStreet.value.trim(), pc=nPost.value.trim();
      if(!name) return;
      const {data}=await supabase
        .from('venues')
        .insert([{venue_name:name,street_name:street,postcode:pc}])
        .select('id')
        .single();
      vId.value=data.id; vSearch.value=name; newForm.classList.add('hidden');
      nName.value=''; nStreet.value=''; nPost.value='';
    };

    // Initialize this tour block's date/time pair via the universal initializer
    initDateTimePair({
      fromDateEl: fromDate,
      toDateEl: toDate,
      fromTimeEl: fromTime,
      toTimeEl: toTime,
      defaultFromDate: today,
      defaultFromTime: '10:00',
      defaultToTime: '11:00'
    });
  }

  setTab('single');
});
</script>
</section>
      
<!-- =========================
     SECTION 4: FINAL SETTINGS
     (Visibility + Publish + Submit)
     ========================= -->
<section class="card w-full px-3 sm:px-6 py-6" id="card-final-settings">
  <h2 class="text-3xl font-bold text-white mb-6">Final Settings</h2>

  <div class="grid gap-5">
    <div>
      <label for="visibility" class="block text-sm text-gray-300 mb-2">Visibility</label>
      <select id="visibility" name="visibility" class="input-dark p-3 rounded-lg border border-gray-700">
        <option value="public" selected>Public</option>
        <option value="private">Private</option>
      </select>
    </div>

    <div>
      <label for="publish_status" class="block text-sm text-gray-300 mb-2">Publish Status</label>
      <select id="publish_status" name="publish_status" class="input-dark p-3 rounded-lg border border-gray-700">
        <option value="draft" selected>Draft</option>
        <option value="published">Published</option>
      </select>
    </div>

    <div>
      <label class="block text-sm text-gray-300 mb-2">Organiser ID (temporary)</label>
      <input id="organiser_id_display" class="input-dark p-3 rounded-lg border border-gray-700" type="text" value="Loading user…" readonly />
      <input id="organiser_id" name="organiser_id" type="hidden" />
      <p class="text-xs text-gray-400 mt-2">Shown for now; will be hidden/automatic later.</p>
    </div>

    <div class="flex items-center gap-3 pt-2">
      <button id="submitBtn" class="rounded-2xl px-5 py-3 font-medium bg-blue-600 hover:bg-blue-700" type="submit">
        Submit Event
      </button>
      <button id="resetBtn" class="rounded-2xl px-5 py-3 font-medium bg-gray-700 hover:bg-gray-600" type="button">
        Reset
      </button>
    </div>
  </div>
</section>
</form>
</main>

<!-- 1️⃣ Supabase Library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- 2️⃣ Layout -->
<script type="module" src="./spondle-layout.js?v=global-14"></script>
<script>
window.addEventListener("DOMContentLoaded", () => {
  if (window.Layout && typeof window.Layout.init === "function") {
    window.Layout.init({ active: "events" });
  }
});
</script>

<!-- 3️⃣ Supabase Client + Organiser ID -->
<script>
window.SUPABASE_URL = "https://jvuunvnbpdfrttusgelz.supabase.co";
window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY";

window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);

window.addEventListener("DOMContentLoaded", async () => {
  const display = document.getElementById("organiser_id_display");
  const hidden = document.getElementById("organiser_id");

  try {
    // Refresh session first
    const { data: sessionData, error: sessionErr } = await window.supabaseClient.auth.getSession();
    if (sessionErr) {
      display.value = "Session error: " + sessionErr.message;
      return;
    }

    if (!sessionData?.session) {
      display.value = "Not signed in";
      return;
    }

    // Now get user ID
    const { data: { user }, error } = await window.supabaseClient.auth.getUser();
    if (error || !user?.id) {
      display.value = "Auth error: " + (error?.message || "No user");
      return;
    }

    display.value = user.id;
    hidden.value = user.id;
  } catch (err) {
    display.value = "Init error: " + err.message;
  }

  // Form reset logic
  const form = document.getElementById("create-event-form");
  const resetBtn = document.getElementById("resetBtn");
  if (resetBtn && form) resetBtn.addEventListener("click", () => form.reset());
});
</script>

<!-- 4️⃣ Diagnostic (optional – remove later) -->
<script>
window.addEventListener("DOMContentLoaded", async () => {
  try {
    const { data: sessionData } = await window.supabaseClient.auth.getSession();
    const msg = sessionData?.session
      ? `✅ Session active for user: ${sessionData.session.user.id}`
      : "⚠️ No active session detected";
    console.log(msg);
  } catch (err) {
    console.error("Auth diagnostic error:", err.message);
  }
});
</script>
  
<!-- =========================
     SECTION 5: FORM SUBMISSION (Supabase Insert)
     ========================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("create-event-form");
  const submitBtn = document.getElementById("submitBtn");
  const supabase = window.supabaseClient;

  if (!form || !supabase) return;

  submitBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    // --- Gather base form fields ---
    const organiser_id   = document.getElementById("organiser_id").value.trim();
    const event_name     = document.getElementById("event_name").value.trim();
    const description    = document.getElementById("description").value.trim();
    const category       = document.getElementById("category").value.trim();
    const visibility     = document.getElementById("visibility").value.trim();
    const publish_status = document.getElementById("publish_status").value.trim();

    // --- Derive image URL from CURRENT visible slide (via active dot) ---
    const dotsWrap = document.querySelector("#card-image-carousel #dots");
    const dotEls = dotsWrap ? Array.from(dotsWrap.querySelectorAll(".dot")) : [];
    let activeIdx = dotEls.findIndex(d => d.classList.contains("dot-active"));
    if (activeIdx < 0) activeIdx = 0;
    const slideImgs = Array.from(document.querySelectorAll("#card-image-carousel #slider .slide img"));
    const imageUrl = (slideImgs[activeIdx]?.src) || (slideImgs[0]?.src) || "";

    // --- Determine which schedule tab is active ---
    const isTour = document.getElementById("tabTour").classList.contains("pill-on");
    const eventsToInsert = [];

    if (!isTour) {
      // SINGLE / RECURRING
      const venue_id   = document.getElementById("srVenueId").value.trim();
      const ticket_url = document.getElementById("srTicketLink").value.trim();
      const fromDate   = document.getElementById("fromDate").value.trim();
      const toDate     = document.getElementById("toDate").value.trim();
      const fromTime   = document.getElementById("fromTime").value.trim();
      const toTime     = document.getElementById("toTime").value.trim();
      const repeatType = document.getElementById("repeatType").value;
      const repeatUntil = document.getElementById("repeatUntil").value.trim();

      if (!venue_id || !event_name || !category) {
        alert("Please fill out Event Name, Category, and Venue before submitting.");
        return;
      }

      const parseUK = s => {
        const [dd, mm, yyyy] = s.split("/").map(n => parseInt(n, 10));
        return `${yyyy}-${String(mm).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
      };

      const start = new Date(parseUK(fromDate));
      const endRepeat = repeatUntil ? new Date(parseUK(repeatUntil)) : start;

      const pushEvent = d => {
        eventsToInsert.push({
          event_name, description, category, image_url: imageUrl,
          venue_id, event_date: d.toISOString().split("T")[0],
          event_time: fromTime, end_date: toDate ? parseUK(toDate) : null,
          end_time: toTime, ticket_url,
          event_visibility: visibility, publish_status, organiser_id
        });
      };

      if (repeatType === "none") {
        pushEvent(start);
      } else {
        const addDays = (d, n) => { const c = new Date(d); c.setDate(c.getDate() + n); return c; };
        let cur = new Date(start);
        while (cur <= endRepeat) {
          pushEvent(cur);
          switch (repeatType) {
            case "everyday":   cur = addDays(cur, 1); break;
            case "everyweek":  cur = addDays(cur, 7); break;
            case "every2weeks":cur = addDays(cur, 14); break;
            case "everymonth": cur.setMonth(cur.getMonth() + 1); break;
            case "everyyear":  cur.setFullYear(cur.getFullYear() + 1); break;
            default: cur = addDays(cur, 9999);
          }
        }
      }
    } else {
      // TOUR
      const tourBlocks = document.querySelectorAll("#tourRoot > div:not(.h-px)");
      tourBlocks.forEach(block => {
        const venue_id = block.querySelector(".venueId")?.value.trim();
        const ticket_url = block.querySelector(".ticketLink")?.value.trim();
        const fromDate = block.querySelector(".fromDate")?.value.trim();
        const toDate = block.querySelector(".toDate")?.value.trim();
        const fromTime = block.querySelector(".fromTime")?.value.trim();
        const toTime = block.querySelector(".toTime")?.value.trim();
        if (venue_id && fromDate) {
          const parseUK = s => {
            const [dd, mm, yyyy] = s.split("/").map(n => parseInt(n, 10));
            return `${yyyy}-${String(mm).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
          };
          eventsToInsert.push({
            event_name, description, category, image_url: imageUrl,
            venue_id, event_date: parseUK(fromDate),
            event_time: fromTime, end_date: toDate ? parseUK(toDate) : null,
            end_time: toTime, ticket_url,
            event_visibility: visibility, publish_status, organiser_id
          });
        }
      });
    }

    if (!eventsToInsert.length) {
      alert("No valid event data to insert.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting…";

    try {
      const { data, error } = await supabase.from("events").insert(eventsToInsert);
      if (error) throw error;
      alert(`✅ ${eventsToInsert.length} event(s) saved successfully!`);

      // --- Reset form + scroll to top ---
      form.reset();
      window.scrollTo({ top: 0, behavior: "smooth" });

      // --- Properly reset carousel state (no ghost slides) ---
      if (typeof selectCategory === "function") {
        selectCategory(""); // built-in reset (placeholder + disables arrows/dots)
      }

      // --- Restore organiser ID ---
      const display = document.getElementById("organiser_id_display");
      const hidden  = document.getElementById("organiser_id");
      const { data: { user } } = await supabase.auth.getUser();
      if (user?.id) {
        display.value = user.id;
        hidden.value  = user.id;
      } else {
        display.value = "Not signed in";
        hidden.value  = "";
      }

    } catch (err) {
      console.error("Insert error:", err);
      alert("❌ Error saving event(s): " + err.message);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Event";
    }
  });
});
</script>
  
</body>
</html>
