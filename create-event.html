<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Event — Spondle</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Existing shared styles (unchanged) -->
  <link rel="stylesheet" href="./spondle-layout.css?v=global-9">
  <link rel="stylesheet" href="./styles.css?v=global-9">
  <link rel="stylesheet" href="./hearts.css?v=global-9">

  <style>
    /* ======== ONLY for stock image carousel (new) ======== */
    .stock-wrap { position: relative; }
    .stock-rail {
      display:flex; gap:12px; overflow-x:auto; scroll-snap-type:x mandatory;
      padding-bottom:8px;
    }
    .stock-card{
      flex:0 0 100%;
      max-width:100%;
      aspect-ratio: 16/9;
      border-radius:14px; overflow:hidden; position:relative; scroll-snap-align:center;
      border:1px solid #374151; background:#0b0f14;
    }
    .stock-card img{ width:100%; height:100%; object-fit:cover; display:block; }
    .stock-card.selected{ outline:4px solid #22c55e; outline-offset:0; }
    .stock-card .pick{
      position:absolute; right:10px; bottom:10px;
      background:#111827cc; border:1px solid #374151; color:#fff;
      padding:.4rem .7rem; border-radius:999px; font-size:.8rem;
    }
    .stock-arrow{
      position:absolute; top:50%; transform:translateY(-50%);
      width:42px; height:42px; border-radius:999px;
      display:grid; place-items:center;
      background:#9ca3afee; color:#111827;
      border:1px solid #d1d5db;
      z-index:5;
    }
    .stock-arrow.left{ left:-6px; }
    .stock-arrow.right{ right:-6px; }
    /* ======== END stock image styles ======== */

    /* Keep your venue mini-cards (as before) */
    .venue-card{border:1px solid #444;border-radius:12px;padding:12px;margin-bottom:12px;background:#111;cursor:pointer}
    .venue-card strong{display:block;margin-bottom:4px}
    .no-results{text-align:center;color:#888;margin-top:10px}
    .input-wrapper{position:relative}
    .clear-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:#aaa;font-size:18px;cursor:pointer}
  </style>
</head>
<body class="bg-black text-white">
  <div id="layout-root"></div>

  <main class="px-4 sm:px-6 lg:px-8 mt-6 space-y-8">
    <section class="p-6 md:p-8 rounded-lg border border-gray-800 bg-[#0b0f14]">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Create Event</h1>
      <p class="text-gray-400 mt-3 max-w-2xl">Add a new event and choose a stock image if you don’t have one.</p>

      <form id="eventForm" class="space-y-8 mt-8">
        <!-- Basic details -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="block mb-2">Event Name</label>
              <input id="event_name" type="text" required class="w-full p-3 rounded bg-gray-800 border border-gray-600" placeholder="eg. Friday Night Live" />
            </div>

            <div>
              <label class="block mb-2">Description</label>
              <textarea id="description" rows="5" class="w-full p-3 rounded bg-gray-800 border border-gray-600" placeholder="Optional event description..."></textarea>
            </div>

            <div>
              <label class="block mb-2">Category</label>
              <select id="category" class="w-full p-3 rounded bg-gray-800 border border-gray-600">
                <option value="">Select category</option>
                <option value="music">Music</option>
                <option value="comedy">Comedy</option>
                <option value="theatre">Theatre</option>
                <option value="sports">Sports</option>
                <option value="festival">Festival</option>
              </select>
            </div>
          </div>

          <!-- Image URL + Stock picker -->
          <div class="space-y-4">
            <div>
              <label class="block mb-2">Image URL</label>
              <input id="image_url" type="url" class="w-full p-3 rounded bg-gray-800 border border-gray-600" placeholder="https://example.com/image.jpg" />
            </div>

            <div>
              <label class="block mb-2">Or choose a stock image</label>
              <select id="stockImageSelect" class="w-full p-3 rounded bg-gray-800 border border-gray-600">
                <option value="">Select stock category</option>
                <option value="music">Music</option>
                <option value="comedy">Comedy</option>
                <option value="theatre">Theatre</option>
                <option value="sports">Sports</option>
                <option value="festival">Festival</option>
              </select>

              <!-- the carousel (only new UI) -->
              <div class="stock-wrap mt-3">
                <button type="button" class="stock-arrow left" aria-label="Scroll left" id="arrowLeft">◀</button>
                <button type="button" class="stock-arrow right" aria-label="Scroll right" id="arrowRight">▶</button>
                <div id="stockRail" class="stock-rail"></div>
              </div>

              <p class="text-sm text-gray-400 mt-2">Tap a stock image to use it. You can still paste your own URL above.</p>
            </div>
          </div>
        </div>

        <!-- Publish -->
        <div>
          <label class="block mb-2">Publish Status</label>
          <select id="publish_status" class="w-full p-3 rounded bg-gray-800 border border-gray-600">
            <option value="draft">Draft</option>
            <option value="published">Published</option>
          </select>
        </div>

        <!-- Schedule (restored exactly: three buttons + single fields) -->
        <div>
          <label class="block mb-2">Schedule</label>
          <div class="flex gap-3">
            <button type="button" id="schSingle"     class="px-5 py-2 rounded bg-gray-700 text-white" aria-pressed="true">Single</button>
            <button type="button" id="schRecurring"  class="px-5 py-2 rounded bg-gray-700 text-white" aria-pressed="false">Recurring</button>
            <button type="button" id="schTour"       class="px-5 py-2 rounded bg-gray-700 text-white" aria-pressed="false">Tour</button>
          </div>
          <input type="hidden" id="schedule_mode" value="single" />

          <!-- Single -->
          <div id="singleFields" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block mb-2">Event Date</label>
              <input id="event_date" type="date" class="w-full p-3 rounded bg-gray-800 border border-gray-600" />
            </div>
            <div>
              <label class="block mb-2">Event Time</label>
              <input id="event_time" type="time" class="w-full p-3 rounded bg-gray-800 border border-gray-600" />
            </div>
          </div>

          <!-- Recurring / Tour placeholders kept hidden (unchanged) -->
          <div id="recurringFields" class="mt-4 hidden">
            <div class="p-4 rounded bg-gray-800 border border-gray-700 text-gray-400">Recurring configuration (coming soon)</div>
          </div>
          <div id="tourFields" class="mt-4 hidden">
            <div class="p-4 rounded bg-gray-800 border border-gray-700 text-gray-400">Tour configuration (coming soon)</div>
          </div>
        </div>

        <!-- Venue -->
        <div>
          <label class="block mb-2">Venue</label>
          <div class="input-wrapper">
            <input id="venue_search" type="text" placeholder="Search by venue name..." class="w-full p-3 rounded bg-gray-800 border border-gray-600">
            <button type="button" class="clear-btn" title="Clear">&times;</button>
          </div>
          <input id="venue_id" type="text" placeholder="Venue ID will appear here" class="w-full p-3 rounded bg-gray-700 border border-gray-600 text-green-400 mt-2" readonly>
          <div class="venue-list mt-2"></div>
          <div class="no-results hidden">No results</div>
        </div>

        <!-- Ticket URL -->
        <div>
          <label class="block mb-2">Ticket URL (optional)</label>
          <input id="ticket_url" type="url" class="w-full p-3 rounded bg-gray-800 border border-gray-600" placeholder="https://tickets.example.com/..." />
        </div>

        <!-- Submit -->
        <div class="flex flex-col sm:flex-row gap-3 pt-2">
          <button id="submitBtn" type="button" class="px-6 py-3 bg-green-500 text-black font-semibold rounded hover:bg-green-400">Submit Event</button>
        </div>

        <!-- Organiser ID -->
        <div>
          <label class="block mt-6 mb-2 text-sm text-gray-400">Organiser ID (temporary)</label>
          <input type="text" id="organiser_id" readonly class="w-full p-2 bg-gray-700 border border-gray-600 rounded text-green-400 text-sm" placeholder="Fetching..." />
        </div>

        <!-- Banner -->
        <div id="banner" class="hidden mt-4 text-center px-4 py-2 rounded text-sm"></div>
      </form>
    </section>
  </main>

  <script src="./spondle-layout.js?v=global-9" type="module"></script>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      window.Layout?.init({ active: "create" });
    });
  </script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://jvuunvnbpdfrttusgelz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY'
    );

    const qs = (s) => document.querySelector(s);
    const banner = qs('#banner');
    const showBanner = (msg, ok=true)=>{
      banner.textContent = msg;
      banner.className = `mt-4 text-center px-4 py-2 rounded text-sm ${ok?'bg-green-600 text-black':'bg-red-600 text-white'}`;
      banner.style.display = 'block';
    };

    /* Auth / organiser id (unchanged) */
    const { data: { user } } = await supabase.auth.getUser();
    qs('#organiser_id').value = user ? user.id : 'Not logged in';

    /* ===== Stock images (only new logic) ===== */
    const stockImages = {
      music: [
        "https://images.unsplash.com/photo-1511379938547-c1f69419868d?auto=format&fit=crop&w=1400&q=80",
        "https://images.unsplash.com/photo-1507874457470-272b3c8d8ee2?auto=format&fit=crop&w=1400&q=80",
        "https://images.unsplash.com/photo-1504805572947-34fad45aed93?auto=format&fit=crop&w=1400&q=80"
      ],
      comedy: [
        "https://images.unsplash.com/photo-1525182008055-f88b95ff7980?auto=format&fit=crop&w=1400&q=80",
        "https://images.unsplash.com/photo-1508214751196-bcfd4ca60f91?auto=format&fit=crop&w=1400&q=80"
      ],
      theatre: [
        "https://images.unsplash.com/photo-1507925921958-8a62f3d1a50d?auto=format&fit=crop&w=1400&q=80",
        "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?auto=format&fit=crop&w=1400&q=80"
      ],
      sports: [
        "https://images.unsplash.com/photo-1505842465776-3acb9e92c0f0?auto=format&fit=crop&w=1400&q=80",
        "https://images.unsplash.com/photo-1508609349937-5ec4ae374ebf?auto=format&fit=crop&w=1400&q=80"
      ],
      festival: [
        "https://images.unsplash.com/photo-1492684223066-81342ee5ff30?auto=format&fit=crop&w=1400&q=80",
        "https://images.unsplash.com/photo-1464375117522-1311d6a5b81b?auto=format&fit=crop&w=1400&q=80"
      ]
    };

    const stockSelect = qs('#stockImageSelect');
    const stockRail  = qs('#stockRail');
    const imageInput = qs('#image_url');
    const leftBtn    = qs('#arrowLeft');
    const rightBtn   = qs('#arrowRight');

    function renderStock(cat){
      stockRail.innerHTML = '';
      (stockImages[cat] || []).forEach((url, i) => {
        const card = document.createElement('div');
        card.className = 'stock-card';
        card.innerHTML = `<img src="${url}" alt="${cat} ${i+1}"><button type="button" class="pick">Use this</button>`;
        card.querySelector('.pick').addEventListener('click', ()=>{
          imageInput.value = url;
          stockRail.querySelectorAll('.stock-card').forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected');
        });
        stockRail.appendChild(card);
      });
    }
    function scrollByPage(dir){
      const w = stockRail.clientWidth;
      stockRail.scrollBy({ left: dir*w, behavior: 'smooth' });
    }
    leftBtn.addEventListener('click', ()=>scrollByPage(-1));
    rightBtn.addEventListener('click', ()=>scrollByPage(1));
    stockSelect.addEventListener('change', ()=>renderStock(stockSelect.value));

    /* ===== Schedule toggles (restored behaviour) ===== */
    const modeInput = qs('#schedule_mode');
    const singleBtn = qs('#schSingle');
    const recurBtn  = qs('#schRecurring');
    const tourBtn   = qs('#schTour');
    const singleBox = qs('#singleFields');
    const recurBox  = qs('#recurringFields');
    const tourBox   = qs('#tourFields');

    function setMode(mode){
      modeInput.value = mode;
      singleBtn.setAttribute('aria-pressed', String(mode==='single'));
      recurBtn.setAttribute('aria-pressed',  String(mode==='recurring'));
      tourBtn.setAttribute('aria-pressed',   String(mode==='tour'));
      singleBox.classList.toggle('hidden', mode!=='single');
      recurBox.classList.toggle('hidden',  mode!=='recurring');
      tourBox.classList.toggle('hidden',   mode!=='tour');
    }
    singleBtn.addEventListener('click', ()=>setMode('single'));
    recurBtn.addEventListener('click',  ()=>setMode('recurring'));
    tourBtn.addEventListener('click',   ()=>setMode('tour'));
    setMode('single'); // default

    /* ===== Venue quick search (unchanged) ===== */
    (function wireVenueSearch(){
      const searchInput = qs('#venue_search');
      const venueIdInput = qs('#venue_id');
      const venueList = document.querySelector('.venue-list');
      const noResults = document.querySelector('.no-results');
      const clearBtn = document.querySelector('.clear-btn');

      async function doSearch(q){
        venueList.innerHTML = '';
        noResults.classList.add('hidden');
        if(!q) return;
        const { data: venues, error } = await supabase
          .from('venues')
          .select('id,venue_name,street_name,postcode')
          .ilike('venue_name', `%${q}%`)
          .limit(6);
        if(error) return;
        if(!venues || venues.length===0){ noResults.classList.remove('hidden'); return; }
        venues.forEach(v => {
          const card = document.createElement('div');
          card.className = 'venue-card';
          card.innerHTML = `<strong>${v.venue_name}</strong>${v.street_name || ''}${v.postcode ? ', '+v.postcode : ''}`;
          card.addEventListener('click', () => {
            searchInput.value = v.venue_name;
            venueIdInput.value = v.id;
            venueList.innerHTML = '';
            noResults.classList.add('hidden');
          });
          venueList.appendChild(card);
        });
      }
      searchInput.addEventListener('input', (e)=>doSearch(e.target.value.trim()));
      clearBtn.addEventListener('click', ()=>{ searchInput.value=''; venueIdInput.value=''; venueList.innerHTML=''; noResults.classList.add('hidden'); });
    })();

    /* ===== Submit (unchanged) ===== */
    qs('#submitBtn').addEventListener('click', async () => {
      if(!user){ showBanner('You must be logged in to create events.', false); return; }

      const record = {
        organiser_id: user.id,
        event_name: qs('#event_name').value.trim(),
        description: qs('#description').value.trim() || null,
        category: qs('#category').value || null,
        image_url: qs('#image_url').value.trim() || null,
        publish_status: qs('#publish_status').value || 'draft',
        schedule_mode: qs('#schedule_mode').value,
        event_date: qs('#event_date').value || null,
        event_time: qs('#event_time').value || null,
        venue_id: qs('#venue_id').value || null,
        ticket_url: qs('#ticket_url').value.trim() || null,
        created_at: new Date().toISOString()
      };

      if(record.schedule_mode==='single' && (!record.event_date || !record.event_time)){
        showBanner('Please provide event date and time.', false); return;
      }

      const { error } = await supabase.from('events').insert([record]);
      if(error){ showBanner('Failed to create event.', false); return; }

      showBanner('Event created!');
      setTimeout(()=>{ location.href = '/event-dashboard.html'; }, 900);
    });
  </script>
</body>
</html>
