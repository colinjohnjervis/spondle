<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Event â€“ Spondle</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Shared layout + styles -->
  <link rel="stylesheet" href="./spondle-layout.css?v=global-9">
  <link rel="stylesheet" href="./styles.css?v=global-9">
  <link rel="stylesheet" href="./hearts.css?v=global-9">

  <style>
    /* ====== INLINE WIDENING ====== */
    body { background:#000; color:#fff; font-family:ui-sans-serif,system-ui,sans-serif; min-height:100vh; }
    .form-card {
      background:#0f172a;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      padding:1.5rem;
      width:100%;
      max-width:90%; /* widen from xl */
    }
    .input-dark { background:#0b1220; color:#fff; width:100%; border:1px solid #374151; border-radius:12px; padding:12px; }
    .input-dark:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,0.3); }
    .input-dark::placeholder { color:#9ca3af; }
    select.input-dark option { background:#0b1220; color:#fff; }
    label { font-size:0.95rem; color:#e5e7eb; margin-bottom:6px; display:block; }

    .venue-card { background:#111827; border:1px solid #374151; border-radius:12px; padding:12px 14px; margin:8px 0; }
    .venue-card:hover { background:#1b2433; border-color:#3b82f6; cursor:pointer; }
    .no-results { padding:12px 14px; background:#111827; border:1px solid #374151; border-radius:12px; text-align:center; color:#9ca3af; margin:8px 0; cursor:pointer; }
    .no-results:hover { background:#1b2433; border-color:#3b82f6; }

    .img-wrapper { border-radius:0.75rem; overflow:hidden; border:3px solid transparent; transition:border-color 0.25s ease; }
    .img-wrapper.selected { border-color:#3b82f6; }

    .arrow-btn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.4);
      color:rgba(255,255,255,0.9); font-size:22px; width:40px; height:40px; border:none; border-radius:50%; cursor:pointer;
      display:flex; align-items:center; justify-content:center; transition:background 0.2s; }
    .arrow-btn:hover { background:rgba(0,0,0,0.6); }
  </style>
</head>

<body>
  <!-- HEADER + SIDEBAR RESTORED -->
  <script src="./spondle-layout.js?v=global-9" type="module"></script>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      window.Layout?.init({ active: "dashboard" });
    });
  </script>

  <!-- MAIN CONTAINER -->
  <main class="flex items-start justify-center py-10 w-full">
    <div class="form-card">
      <h1 class="text-3xl font-bold text-white mb-6">Create Event</h1>

      <form id="eventForm" class="space-y-6">
        
        <!-- SECTION: BASIC INFO -->
        <div>
          <label>Event Name</label>
          <input type="text" name="event_name" required class="input-dark" placeholder="Enter event name">
        </div>

        <div>
          <label>Description</label>
          <textarea name="description" rows="4" class="input-dark" placeholder="Add event details"></textarea>
        </div>

        <!-- SECTION: CATEGORY + IMAGE -->
        <div>
          <label>Event Category & Image</label>
          <select name="category" required class="input-dark">
            <option value="">Select category</option>
            <option value="music">Music</option>
            <option value="comedy">Comedy</option>
            <option value="theatre">Theatre</option>
            <option value="sports">Sports</option>
            <option value="festival">Festival</option>
            <option value="quiz">Quiz Night</option>
          </select>
        </div>

        <!-- Placeholder image -->
        <div id="placeholderImageWrapper">
          <img 
            src="https://raw.githubusercontent.com/colinjohnjervis/spondle/main/images/file_000000002f686243b31639a2bca68eca.png"
            alt="Spondle placeholder" 
            class="w-full h-96 object-cover rounded-lg">
        </div>

        <!-- Auto carousel -->
        <div id="carouselWrapper" class="hidden"></div>

        <!-- SECTION: SCHEDULE -->
        <div>
          <label class="font-medium">Schedule</label>
          <div class="flex gap-2 mb-4 mt-2">
            <button type="button" class="tab-btn bg-gray-700 px-4 py-2 rounded-full w-1/3" data-type="single">Single</button>
            <button type="button" class="tab-btn bg-gray-700 px-4 py-2 rounded-full w-1/3" data-type="recurring">Recurring</button>
            <button type="button" class="tab-btn bg-gray-700 px-4 py-2 rounded-full w-1/3" data-type="tour">Tour</button>
          </div>
          <input type="hidden" name="event_type" id="eventType" value="single">
          <div id="tabContent"></div>
        </div>

        <!-- SECTION: EVENT VISIBILITY + STATUS -->
        <div>
          <label>Event Visibility</label>
          <select name="event_visibility" class="input-dark">
            <option value="public">Public</option>
          </select>
        </div>

        <div>
          <label>Publish Status</label>
          <select name="publish_status" required class="input-dark">
            <option value="draft">Draft</option>
            <option value="published">Published</option>
          </select>
        </div>

        <!-- SECTION: ORGANISER ID -->
        <div>
          <label>Organiser ID</label>
          <input type="text" id="organiser_id" name="organiser_id" readonly class="input-dark text-blue-400">
        </div>

        <!-- SECTION: SUBMIT -->
        <div class="pt-6 border-t border-gray-700 mt-10">
          <button type="submit" class="bg-blue-500 hover:bg-blue-400 text-black font-semibold px-6 py-3 rounded-lg w-full">
            Create Event
          </button>
        </div>

      </form>
    </div>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./scripts/stock-images.js?v=9"></script>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const supabase = window.supabase.createClient(
      "https://jvuunvnbpdfrttusgelz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY"
    );

    /* ---------- Load logged-in organiser ID ---------- */
    const { data: { user } } = await supabase.auth.getUser();
    if (user) document.getElementById("organiser_id").value = user.id;

    /* ---------- Stock image display ---------- */
    const placeholder = document.getElementById("placeholderImageWrapper");
    const carouselWrapper = document.getElementById("carouselWrapper");
    const categories = document.querySelector("select[name='category']");

    categories.addEventListener("change", () => {
      const cat = categories.value;
      if (!cat) return;
      const list = window.stockImages?.[cat] || [];
      if (list.length) renderCarousel(list);
    });

    function renderCarousel(images) {
      placeholder.classList.add("hidden");
      carouselWrapper.classList.remove("hidden");
      carouselWrapper.innerHTML = `
        <div class="relative w-full">
          <button class="arrow-btn left-2" id="prevBtn">&#10094;</button>
          <div id="carouselImages" class="flex overflow-hidden rounded-xl">
            ${images.map((src,i)=>`
              <div class="min-w-full transition-transform duration-300 ${i===0?'block':'hidden'}">
                <img src="${src}" class="w-full h-96 object-cover rounded-lg" alt="">
              </div>`).join("")}
          </div>
          <button class="arrow-btn right-2" id="nextBtn">&#10095;</button>
        </div>
      `;
      setupCarousel();
    }

    function setupCarousel() {
      const imgs = carouselWrapper.querySelectorAll("#carouselImages > div");
      let index = 0;
      const show = i => imgs.forEach((d,idx)=>d.classList.toggle("hidden", idx!==i));
      carouselWrapper.querySelector("#prevBtn").onclick = () => {
        index = (index - 1 + imgs.length) % imgs.length; show(index);
      };
      carouselWrapper.querySelector("#nextBtn").onclick = () => {
        index = (index + 1) % imgs.length; show(index);
      };
    }

    /* ---------- Tabs for schedule ---------- */
    const tabs = document.querySelectorAll(".tab-btn");
    const tabContent = document.getElementById("tabContent");
    const eventType = document.getElementById("eventType");

    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(b => b.classList.remove("bg-blue-500","text-black"));
        btn.classList.add("bg-blue-500","text-black");
        const type = btn.dataset.type;
        eventType.value = type;
        renderTab(type);
      });
    });

    function renderTab(type) {
      tabContent.innerHTML = "";
      if (type === "single") renderSingleTab();
      else if (type === "recurring") renderRecurringTab();
      else if (type === "tour") renderTourTab();
    }

    /* ---------- Venue Search (used in tabs) ---------- */
    async function searchVenues(query) {
      const clean = query.replace(/[^a-zA-Z0-9\\s'-]/g,'').trim();
      if (!clean) return [];
      const { data } = await supabase
        .from('venues')
        .select('id, venue_name, street_name, postcode')
        .ilike('venue_name', `%${clean}%`);
      if (!data) return [];
      const startsWith = data.filter(v=>v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
      const others = data.filter(v=>!v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
      return [...startsWith, ...others].slice(0,5);
    }

    function venueSearchField() {
      return `
        <div class="mb-6 relative">
          <label>Venue</label>
          <input type="text" class="venueSearch input-dark" placeholder="Search by venue name..." />
          <div class="results-pop hidden">
            <div class="venueResults"></div>
            <div class="no-results hidden">No matches found.<br><span class="text-blue-400 underline">+ Add new venue</span></div>
          </div>
          <input type="text" class="venueId input-dark text-blue-400 mt-2" readonly placeholder="Venue ID will appear here" />
        </div>`;
    }

    function attachVenueLogic(scope) {
      const vSearch = scope.querySelector(".venueSearch");
      const vResultsWrap = scope.querySelector(".results-pop");
      const vResults = scope.querySelector(".venueResults");
      const vNo = scope.querySelector(".no-results");
      const vId = scope.querySelector(".venueId");
      let timeout;
      vSearch.oninput = () => {
        clearTimeout(timeout);
        const val = vSearch.value.trim();
        if (!val) { vResults.innerHTML=''; vResultsWrap.classList.add('hidden'); return; }
        timeout = setTimeout(async () => {
          const results = await searchVenues(val);
          vResults.innerHTML='';
          vNo.classList.add('hidden');
          if (!results.length) vNo.classList.remove('hidden');
          results.forEach(v=>{
            const div=document.createElement('div');
            div.className='venue-card';
            div.innerHTML=\`<div class="font-semibold">\${v.venue_name}</div><div class="text-gray-300">\${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>\`;
            div.onclick=()=>{vSearch.value=v.venue_name;vId.value=v.id;vResultsWrap.classList.add('hidden');};
            vResults.appendChild(div);
          });
          vResultsWrap.classList.remove('hidden');
        },250);
      };
    }

    /* ---------- SINGLE ---------- */
    function renderSingleTab() {
      tabContent.innerHTML = \`
        <section id="singleTab" class="space-y-4">
          \${venueSearchField()}
          <div>
            <label>Date</label>
            <input type="date" name="event_date" class="input-dark">
          </div>
          <div>
            <label>Time</label>
            <input type="time" name="event_time" class="input-dark">
          </div>
        </section>\`;
      attachVenueLogic(tabContent);
    }

    /* ---------- RECURRING ---------- */
    function renderRecurringTab() {
      tabContent.innerHTML = \`
        <section id="recurringTab" class="space-y-4">
          \${venueSearchField()}
          <div>
            <label>Start Date</label>
            <input type="date" class="input-dark" name="recurring_start">
          </div>
          <div>
            <label>End Date</label>
            <input type="date" class="input-dark" name="recurring_end">
          </div>
          <div>
            <label>Repeat</label>
            <select class="input-dark" name="recurring_repeat">
              <option value="none">Does not repeat</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="fortnightly">Every 2 weeks</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
        </section>\`;
      attachVenueLogic(tabContent);
    }

    /* ---------- TOUR ---------- */
    function renderTourTab() {
      tabContent.innerHTML = \`
        <section id="tourTab" class="space-y-6">
          <div id="tourContainer"></div>
          <button type="button" id="addTourBtn" class="bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-2 rounded-lg w-full">
            + Add another venue/date
          </button>
        </section>\`;

      const container = document.getElementById("tourContainer");
      const addBtn = document.getElementById("addTourBtn");

      function addTourBlock() {
        const block = document.createElement("div");
        block.className = "tour-block space-y-4 border border-gray-700 rounded-lg p-4";
        block.innerHTML = \`
          \${venueSearchField()}
          <div class="grid grid-cols-2 gap-4">
            <div><label>Date</label><input type="date" class="input-dark" /></div>
            <div><label>Time</label><input type="time" class="input-dark" /></div>
          </div>\`;
        container.appendChild(block);
        attachVenueLogic(block);
      }

      addBtn.onclick = addTourBlock;
      addTourBlock();
    }

    renderTab("single");

    /* ---------- Form Submit ---------- */
    const form = document.getElementById("eventForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      const { error } = await supabase.from("events").insert([data]);
      if (error) alert("Error saving event: " + error.message);
      else alert("Event created successfully!");
    });
  });
  </script>
</body>
</html>
