<!DOCTYPE html>
<html lang="en">
<head>
  <!-- SECTION: HEAD -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Event â€“ Spondle</title>

  <!-- Tailwind + Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Shared layout -->
  <link rel="stylesheet" href="./spondle-layout.css?v=global-9" />
  <link rel="stylesheet" href="./styles.css?v=global-9" />
  <link rel="stylesheet" href="./hearts.css?v=global-9" />

  <style>
    /* SECTION: PAGE STYLES */
    body {
      background: #000;
      color: #fff;
      font-family: ui-sans-serif, system-ui, sans-serif;
      min-height: 100vh;
    }
    .page-card {
      background: #0f172a;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      width: 100%;
      max-width: 1100px;
    }
    .input-dark {
      background: #0b1220;
      color: #fff;
      width: 100%;
    }
    .input-dark::placeholder { color: #9ca3af; }
    .input-dark:focus {
      border-color: #3b82f6 !important;
      outline: none;
      box-shadow: 0 0 0 1.5px #3b82f6;
    }
    .results-pop {
      position: absolute; left:-6px; right:-6px; top:calc(100% + 6px);
      z-index:60; background:#0f172a; border-radius:12px; padding:10px;
    }
    .venue-card {
      background:#111827; border:1px solid #374151;
      border-radius:12px; padding:12px 14px; margin:8px 0;
    }
    .venue-card:hover { background:#1b2433; cursor:pointer; }
    .no-results {
      padding:12px 14px; background:#111827; border:1px solid #374151;
      border-radius:12px; text-align:center; color:#9ca3af;
      margin:8px 0; cursor:pointer;
    }
    .no-results:hover { background:#1b2433; }
    .pill {
      border-radius:9999px; padding:.6rem 1rem; font-weight:600;
      text-align:center; width:50%;
    }
    .pill-on  { background:#22c55e; color:#000; }
    .pill-off { background:#374151; color:#e5e7eb; }
    .tour-inline-remove {
      font-size:18px; line-height:1; width:28px; height:28px;
      border-radius:9999px; display:flex; align-items:center; justify-content:center;
      background:#0b1220; border:1px solid #374151; color:#cbd5e1;
    }
    .tour-inline-remove:hover { color:#fff; border-color:#4b5563; }
  </style>
</head>

<body class="flex flex-col min-h-screen">
  <!-- SECTION: LAYOUT HEADER + SIDEBAR -->
  <script src="./spondle-layout.js?v=global-9" type="module"></script>
  <script>
    window.addEventListener("DOMContentLoaded", () => {
      window.Layout?.init({ active: "dashboard" });
    });
  </script>

  <!-- SECTION: MAIN -->
  <main class="flex-grow flex items-start justify-center py-10">
    <div class="page-card p-8">
      <h1 class="text-4xl font-bold text-white mb-8">Create Event</h1>

      <form id="eventForm" class="space-y-8">
        <!-- SECTION 1: BASIC DETAILS -->
        <section id="section-basic">
          <label class="block text-sm text-gray-300 mb-2">Event Name</label>
          <input
            type="text"
            name="event_name"
            required
            class="input-dark p-3 rounded-lg border border-gray-700 mb-4"
            placeholder="Enter event name"
          />

          <label class="block text-sm text-gray-300 mb-2">Description</label>
          <textarea
            name="description"
            rows="4"
            class="input-dark p-3 rounded-lg border border-gray-700 w-full mb-4"
            placeholder="Add event details"
          ></textarea>

          <label class="block text-sm text-gray-300 mb-2">Category & Image</label>
          <select
            name="category"
            required
            class="input-dark p-3 rounded-lg border border-gray-700 mb-4"
          >
            <option value="">Select category</option>
            <option value="music">Music</option>
            <option value="comedy">Comedy</option>
            <option value="theatre">Theatre</option>
            <option value="sports">Sports</option>
            <option value="festival">Festival</option>
            <option value="quiz">Quiz Night</option>
          </select>

          <!-- SECTION: PLACEHOLDER IMAGE -->
          <div id="placeholderImageWrapper" class="mb-6">
            <img
              src="https://raw.githubusercontent.com/colinjohnjervis/spondle/main/images/file_000000002f686243b31639a2bca68eca.png"
              alt="Spondle placeholder"
              class="w-full h-[420px] object-cover rounded-lg"
            />
          </div>
        </section>

        <!-- SECTION 2: SCHEDULE -->
        <section id="section-schedule">
          <label class="block text-sm text-gray-300 mb-2">Schedule Type</label>
          <div class="flex space-x-2 mb-6 w-full">
            <button type="button" id="tabSingle" class="pill pill-on">Single / Recurring</button>
            <button type="button" id="tabTour" class="pill pill-off">Tour Schedule</button>
          </div>

          <!-- PANEL: SINGLE/RECURRING -->
          <div id="panelSingle">
            <div class="mb-6 relative">
              <label class="block text-sm text-gray-300 mb-2">Venue</label>
              <div class="input-wrapper relative">
                <input
                  id="srVenueSearch"
                  type="text"
                  placeholder="Search by venue name..."
                  class="input-dark p-3 rounded-lg border border-gray-700"
                />
                <button
                  id="srVenueClear"
                  type="button"
                  class="absolute right-3 top-3 text-gray-400 hover:text-gray-200"
                >&times;</button>
                <div id="srResultsPop" class="results-pop hidden">
                  <div id="srVenueResults"></div>
                  <div id="srNoVenueResults" class="no-results hidden">
                    No matches found.<br /><span class="text-blue-400 underline">+ Add new venue</span>
                  </div>
                </div>
              </div>

              <input
                id="srVenueId"
                type="text"
                readonly
                placeholder="Venue ID will appear here"
                class="input-dark p-3 rounded-lg border border-gray-700 text-blue-400 mt-2"
              />
              <input
                id="srTicketLink"
                type="text"
                placeholder="Ticket link (optional)"
                class="input-dark p-3 rounded-lg border border-gray-700 text-gray-300 mt-2"
              />

              <div id="srNewVenueForm" class="hidden mt-4 space-y-2">
                <input
                  id="srNewName"
                  type="text"
                  placeholder="Venue name"
                  class="input-dark p-3 rounded-lg border border-gray-700 w-full"
                />
                <input
                  id="srNewStreet"
                  type="text"
                  placeholder="Street address"
                  class="input-dark p-3 rounded-lg border border-gray-700 w-full"
                />
                <input
                  id="srNewPC"
                  type="text"
                  placeholder="Postcode"
                  class="input-dark p-3 rounded-lg border border-gray-700 w-full"
                />
                <button
                  id="srCreateVenue"
                  class="bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-2 rounded-lg w-full"
                >Create Venue</button>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 items-end mb-4">
              <div>
                <label class="block text-sm text-gray-300 mb-2">From</label>
                <input id="fromDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
              </div>
              <div>
                <label class="block text-sm text-gray-300 mb-2">Time</label>
                <select id="fromTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 items-end mb-4">
              <div>
                <label class="block text-sm text-gray-300 mb-2">To</label>
                <input id="toDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
              </div>
              <div>
                <label class="block text-sm text-gray-300 mb-2">Time</label>
                <select id="toTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
              </div>
            </div>

            <div class="mb-4">
              <label class="block text-sm text-gray-300 mb-2">Repeat</label>
              <select id="repeatType" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
                <option value="none">Does not repeat</option>
                <option value="everyday">Every day</option>
                <option value="everyweek">Every week</option>
                <option value="every2weeks">Every 2 weeks</option>
                <option value="everymonth">Every month</option>
                <option value="everyyear">Every year</option>
              </select>
            </div>

            <div id="repeatUntilWrap" class="hidden mb-4">
              <label class="block text-sm text-gray-300 mb-2">Repeat until</label>
              <input id="repeatUntil" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
            </div>
          </div>

          <!-- PANEL: TOUR SCHEDULE -->
          <div id="panelTour" class="hidden">
            <div id="tourRoot"></div>
            <button
              id="addTourBlockBtn"
              class="mt-6 bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-3 rounded-lg w-full"
            >+ Add another venue/date</button>
          </div>
        </section>

        <!-- SECTION 3: SUBMIT -->
        <section id="section-submit">
          <div class="border-t border-gray-700 my-8"></div>
          <label class="block text-sm text-gray-300 mb-2">Publish Status</label>
          <select id="publishStatus" class="input-dark p-3 rounded-lg border border-gray-700 mb-6 w-full">
            <option value="draft">Draft</option>
            <option value="published">Published</option>
          </select>

          <button
            type="submit"
            class="w-full bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-3 rounded-lg"
          >Submit Event</button>
        </section>
      </form>
    </div>
  </main>

  <!-- SECTION: SCRIPT -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const supabase = window.supabase.createClient(
      "https://jvuunvnbpdfrttusgelz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY"
    );

    const today = new Date();
    const formatUK = d => `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
    const parseUK  = s => { const [dd,mm,yyyy]=s.split("/").map(n=>parseInt(n,10)); return new Date(yyyy,mm-1,dd); };
    const addMonths = (d,n)=>{const x=new Date(d);x.setMonth(x.getMonth()+n);return x;};
    const fillTimes = sel => { sel.innerHTML=""; for(let m=0;m<24*60;m+=15){ const hh=Math.floor(m/60),mm=m%60; const label=`${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`; sel.add(new Option(label,label)); }};

    const fromDateEl=document.getElementById("fromDate");
    const toDateEl=document.getElementById("toDate");
    const fromTimeEl=document.getElementById("fromTime");
    const toTimeEl=document.getElementById("toTime");
    const repeatTypeEl=document.getElementById("repeatType");
    const repeatUntilWrap=document.getElementById("repeatUntilWrap");
    const repeatUntilEl=document.getElementById("repeatUntil");

    fillTimes(fromTimeEl); fillTimes(toTimeEl);
    fromTimeEl.value="10:00"; toTimeEl.value="11:00";
    fromDateEl.value=formatUK(today); toDateEl.value=formatUK(today);

    const fromDP=new Datepicker(fromDateEl,{autohide:true,defaultDate:today,language:"en-GB",format:"dd/mm/yyyy"});
    const toDP=new Datepicker(toDateEl,{autohide:true,defaultDate:today,language:"en-GB",format:"dd/mm/yyyy"});
    fromDateEl.onclick=()=>fromDP.show(); toDateEl.onclick=()=>toDP.show();

    const untilDP=new Datepicker(repeatUntilEl,{autohide:true,language:"en-GB",format:"dd/mm/yyyy"});
    repeatUntilEl.onclick=()=>untilDP.show();

    function toggleRepeatUntil(){
      const hasRepeat = repeatTypeEl.value !== "none";
      repeatUntilWrap.classList.toggle("hidden", !hasRepeat);
      if(hasRepeat){
        const start=parseUK(fromDateEl.value);
        const limit=addMonths(start,12);
        untilDP.setOptions({maxDate:limit});
        repeatUntilEl.value=formatUK(start);
      }
    }
    repeatTypeEl.addEventListener("change",toggleRepeatUntil);
    toggleRepeatUntil();

    /* ---------- Venue Search Logic ---------- */
    const srSearch=document.getElementById("srVenueSearch");
    const srClear=document.getElementById("srVenueClear");
    const srResultsPop=document.getElementById("srResultsPop");
    const srResults=document.getElementById("srVenueResults");
    const srNoResults=document.getElementById("srNoVenueResults");
    const srVenueId=document.getElementById("srVenueId");
    const srNewForm=document.getElementById("srNewVenueForm");
    const srNewName=document.getElementById("srNewName");
    const srNewStreet=document.getElementById("srNewStreet");
    const srNewPC=document.getElementById("srNewPC");
    const srCreateVenue=document.getElementById("srCreateVenue");
    let srTimeout;

    async function searchVenuesRelevance(query){
      const clean=query.replace(/[^a-zA-Z0-9\\s'-]/g,"").trim();
      if(!clean) return [];
      const {data}=await supabase.from("venues").select("id, venue_name, street_name, postcode").ilike("venue_name",`%${clean}%`);
      if(!data) return [];
      const starts=data.filter(v=>v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
      const others=data.filter(v=>!v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
      return [...starts,...others].slice(0,5);
    }

    function renderSrVenues(list){
      srResults.innerHTML=""; srNoResults.classList.add("hidden");
      if(!list.length){ srNoResults.classList.remove("hidden"); return; }
      list.forEach(v=>{
        const div=document.createElement("div");
        div.className="venue-card";
        div.innerHTML=`<div class='font-semibold'>${v.venue_name}</div><div class='text-gray-300'>${[v.street_name,v.postcode].filter(Boolean).join(", ")}</div>`;
        div.onclick=()=>{ srSearch.value=v.venue_name; srVenueId.value=v.id; srResultsPop.classList.add("hidden"); srNewForm.classList.add("hidden"); };
        srResults.appendChild(div);
      });
    }

    srSearch.oninput=()=>{
      clearTimeout(srTimeout);
      const val=srSearch.value.trim();
      if(!val){ srResults.innerHTML=""; srResultsPop.classList.add("hidden"); return; }
      srTimeout=setTimeout(async()=>{
        const results=await searchVenuesRelevance(val);
        renderSrVenues(results);
        srResultsPop.classList.remove("hidden");
      },250);
    };
    srSearch.onfocus=()=>{ if(srResults.children.length) srResultsPop.classList.remove("hidden"); };
    srClear.onclick=()=>{ srSearch.value=""; srVenueId.value=""; srResults.innerHTML=""; srResultsPop.classList.add("hidden"); };
    srNoResults.onclick=()=>{ srResultsPop.classList.add("hidden"); srNewForm.classList.remove("hidden"); };
    srCreateVenue.onclick=async()=>{
      const n=srNewName.value.trim(), s=srNewStreet.value.trim(), p=srNewPC.value.trim();
      if(!n) return;
      const {data}=await supabase.from("venues").insert([{venue_name:n,street_name:s,postcode:p}]).select("id").single();
      srVenueId.value=data.id; srSearch.value=n; srNewForm.classList.add("hidden");
      srNewName.value=""; srNewStreet.value=""; srNewPC.value="";
    };

    /* ---------- Submit Form ---------- */
    const form=document.getElementById("eventForm");
    form.addEventListener("submit",async(e)=>{
      e.preventDefault();
      const eventData={
        event_name: form.event_name.value,
        description: form.description.value,
        category: form.category.value,
        venue_id: srVenueId.value || null,
        event_date: fromDateEl.value,
        event_time: fromTimeEl.value,
        publish_status: document.getElementById("publishStatus").value
      };
      const {error}=await supabase.from("events").insert([eventData]);
      if(error){ alert("Error saving event: "+error.message); }
      else { alert("Event submitted successfully!"); form.reset(); }
    });
  });
  </script>
</body>
</html>
