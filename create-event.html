<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Event – Spondle</title>

  <!-- Tailwind & Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Layout JS -->
  <script src="./spondle-layout.js?v=global"></script>

  <style>
    body { background:#000; color:#fff; font-family:ui-sans-serif,system-ui,sans-serif; min-height:100vh; }

    main { padding-top:80px; display:flex; justify-content:center; }
    .card {
      background:#0f172a;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      width:95%;
      max-width:1200px;
      padding:2rem;
    }

    .input-dark { background:#0b1220; color:#fff; width:100%; }
    .input-dark::placeholder { color:#9ca3af; }
    .input-dark:focus {
      border-color:#3b82f6 !important;
      outline:none;
      box-shadow:0 0 0 1.5px #3b82f6;
    }

    .pill { border-radius:9999px; padding:.6rem 1rem; font-weight:600; text-align:center; width:50%; }
    .pill-on { background:#22c55e; color:#000; }
    .pill-off { background:#374151; color:#e5e7eb; }

    .results-pop { position:absolute; left:-6px; right:-6px; top:calc(100% + 6px);
      z-index:60; background:#0f172a; border-radius:12px; padding:10px; }
    .venue-card { background:#111827; border:1px solid #374151; border-radius:12px; padding:12px 14px; margin:8px 0; }
    .venue-card:hover { background:#1b2433; cursor:pointer; }
    .no-results { padding:12px 14px; background:#111827; border:1px solid #374151; border-radius:12px; text-align:center; color:#9ca3af; margin:8px 0; cursor:pointer; }
    .no-results:hover { background:#1b2433; }

    #imageBox { width:100%; height:320px; border-radius:14px; overflow:hidden; position:relative; background:#0b1220; }
    #imageBox img { width:100%; height:100%; object-fit:cover; }

    h1,h2 { font-weight:700; color:#fff; }
  </style>
</head>

<body>
  <div id="sp-header"></div>
  <div id="sp-sidebar"></div>
  <div id="sp-overlay"></div>

  <main>
    <div class="card">
      <!-- ================================
           SECTION: TITLE & BASIC INFO
      ================================= -->
      <h1 class="text-3xl font-bold mb-6">Create Event</h1>

      <div class="mb-6">
        <label class="block text-sm text-gray-300 mb-2">Event Name</label>
        <input id="eventName" type="text" placeholder="Enter event name" class="input-dark p-3 rounded-lg border border-gray-700" />
      </div>

      <div class="mb-6">
        <label class="block text-sm text-gray-300 mb-2">Description</label>
        <textarea id="eventDescription" placeholder="Add event details" class="input-dark p-3 rounded-lg border border-gray-700 h-28"></textarea>
      </div>

      <!-- ================================
           SECTION: CATEGORY + IMAGE
      ================================= -->
      <div class="mb-6">
        <label class="block text-sm text-gray-300 mb-2">Event Category & Image</label>
        <select id="eventCategory" class="input-dark p-3 rounded-lg border border-gray-700 mb-4">
          <option>Select category</option>
          <option>Music</option>
          <option>Comedy</option>
          <option>Theatre</option>
          <option>Sports</option>
          <option>Exhibition</option>
          <option>Workshop</option>
          <option>Festival</option>
          <option>Beer Festivals</option>
          <option>Archery</option>
          <option>Frisbee Golf</option>
          <option>Crazy Golf</option>
          <option>Murder Mystery</option>
        </select>
        <div id="imageBox" class="border border-gray-700 flex items-center justify-center">
          <img id="categoryImage" src="./images/placeholder.jpg" alt="Preview" />
          <button id="nextImage" class="absolute bottom-4 right-4 bg-blue-500 hover:bg-blue-400 text-black font-semibold px-3 py-2 rounded-lg">Next</button>
        </div>
      </div>

      <!-- ================================
           SECTION: SCHEDULE TYPE BUTTONS
      ================================= -->
      <div class="flex space-x-2 mb-6">
        <button id="tabSingle" class="pill pill-on">Single</button>
        <button id="tabRecurring" class="pill pill-off">Recurring</button>
        <button id="tabTour" class="pill pill-off">Tour</button>
      </div>

      <div id="panelSingle">
        <!-- (venue search + date/time injected in Part 2) -->
      </div>

      <!-- ================================
           SECTION: RECURRING PANEL
      ================================= -->
      <div id="panelRecurring" class="hidden">
        <div class="mb-6 relative">
          <label class="block text-sm text-gray-300 mb-2">Venue</label>
          <div class="relative">
            <input id="recVenueSearch" type="text" placeholder="Search by venue name..."
                   class="input-dark p-3 rounded-lg border border-gray-700">
            <button type="button" id="recVenueClear"
                    class="absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
            <div id="recResultsPop" class="results-pop hidden">
              <div id="recVenueResults"></div>
              <div id="recNoVenueResults" class="no-results hidden">
                No matches found.<br><span class="text-blue-400 underline">+ Add new venue</span>
              </div>
            </div>
          </div>
          <input id="recVenueId" type="text" readonly placeholder="Venue ID will appear here"
                 class="input-dark p-3 rounded-lg border border-gray-700 text-blue-400 mt-2">
          <input id="recTicketLink" type="text" placeholder="Ticket link (optional) e.g. https://example.com/evt123"
                 class="input-dark p-3 rounded-lg border border-gray-700 text-gray-300 mt-2">
          <div id="recNewVenueForm" class="hidden mt-4 space-y-2">
            <input id="recNewName"   type="text" placeholder="Venue name"     class="input-dark p-3 rounded-lg border border-gray-700 w-full">
            <input id="recNewStreet" type="text" placeholder="Street address" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
            <input id="recNewPC"     type="text" placeholder="Postcode"       class="input-dark p-3 rounded-lg border border-gray-700 w-full">
            <button id="recCreateVenue" class="bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
          </div>
        </div>

        <div class="space-y-3 mb-4" id="recDatesWrap">
          <div class="grid grid-cols-2 gap-4 items-end">
            <div>
              <label class="block text-sm text-gray-300 mb-2">Date</label>
              <input type="date" class="recDate input-dark p-3 rounded-lg border border-gray-700 w-full">
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-2">Time</label>
              <input type="time" class="recTime input-dark p-3 rounded-lg border border-gray-700 w-full">
            </div>
          </div>
        </div>
        <button id="recAddDate" type="button" class="text-blue-400 text-sm">+ Add another date</button>
      </div>

      <!-- ================================
           SECTION: TOUR PANEL (start)
      ================================= -->
      <div id="panelTour" class="hidden">
        <div id="tourRoot" class="space-y-6"></div>
        <button id="addTourBlockBtn"
                class="mt-4 bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-2 rounded-lg w-full">
          + Add another venue/date
        </button>
      </div>

      <!-- ================================
           SECTION: PUBLISH & SUBMIT
      ================================= -->
      <div class="mt-8">
        <label class="block text-sm text-gray-300 mb-2">Publish Status</label>
        <select id="publishStatus" class="input-dark p-3 rounded-lg border border-gray-700 w-full mb-6">
          <option value="draft">Draft</option>
          <option value="published">Published</option>
        </select>

        <button id="submitBtn"
                class="w-full bg-green-500 hover:bg-green-400 text-black font-semibold py-3 rounded-lg">
          Submit Event
        </button>

        <div class="mt-6">
          <label class="block text-sm text-gray-400 mb-2">Organiser ID (temporary)</label>
          <input type="text" id="organiser_id" readonly
                 class="input-dark p-3 rounded-lg border border-gray-700 text-green-400" placeholder="Fetching..." />
        </div>

        <pre id="statusBox"
             class="mt-6 bg-[#0b1220] border border-gray-700 rounded-xl p-4 text-sm whitespace-pre-wrap"></pre>
      </div>
    </div>
  </main>

  <!-- =========================================
       SECTION: PAGE SCRIPTS
  ============================================ -->
  <script>
    /* ---------- Initialise sidebar/header ---------- */
    window.addEventListener('DOMContentLoaded', () => {
      window.Layout?.init?.({ active: 'dashboard' });
    });

    /* ---------- Supabase ---------- */
    const supabase = window.supabase.createClient(
      "https://jvuunvnbpdfrttusgelz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY"
    );

    /* ---------- Helpers ---------- */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const log = (msg, ok=true) => {
      const box = $('#statusBox');
      const icon = ok ? '✅' : '❌';
      box.textContent += `${icon} ${msg}\n`;
    };

    /* ---------- Auth ---------- */
    (async () => {
      const { data: { user }, error } = await supabase.auth.getUser();
      const out = $('#organiser_id');
      if (error || !user) { out.value = 'Not logged in'; log('Auth error: not logged in', false); return; }
      out.value = user.id;
      log(`Logged in as ${user.email ?? user.id}`);
    })();

    /* ---------- Category → Image carousel ---------- */
    const stockImages = {
      'Music': [
        "https://images.unsplash.com/photo-1511379938547-c1f69419868d?auto=format&fit=crop&w=1600&q=80",
        "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?auto=format&fit=crop&w=1600&q=80"
      ],
      'Comedy': [
        "https://raw.githubusercontent.com/colinjohnjervis/spondle/main/images/voles.png",
        "https://raw.githubusercontent.com/colinjohnjervis/spondle/main/images/Screenshot_20251016-112458.png"
      ],
      'Theatre': [
        "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=80"
      ],
      'Sports': [
        "https://images.unsplash.com/photo-1505842465776-3acb9e92c0f0?auto=format&fit=crop&w=1600&q=80"
      ],
      'Festival': [
        "https://images.unsplash.com/photo-1507874457470-272b3c8d8ee2?auto=format&fit=crop&w=1600&q=80"
      ],
      'Beer Festivals': [
        "https://images.unsplash.com/photo-1509042239860-f550ce710b93?auto=format&fit=crop&w=1600&q=80"
      ],
      'Archery': [
        "https://images.unsplash.com/photo-1560697863-8a1c1c1ff717?auto=format&fit=crop&w=1600&q=80"
      ],
      'Frisbee Golf': [
        "https://images.unsplash.com/photo-1516637090014-cb1ab0d08fc7?auto=format&fit=crop&w=1600&q=80"
      ],
      'Crazy Golf': [
        "https://images.unsplash.com/photo-1519999482648-25049ddd37b1?auto=format&fit=crop&w=1600&q=80"
      ],
      'Murder Mystery': [
        "https://images.unsplash.com/photo-1518609878373-06d740f60d8b?auto=format&fit=crop&w=1600&q=80"
      ]
    };

    let carouselIdx = 0;
    let currentImages = [];
    const categorySel = $('#eventCategory');
    const imgEl = $('#categoryImage');
    const setImagesForCategory = () => {
      currentImages = stockImages[categorySel.value] ?? ["./images/placeholder.jpg"];
      carouselIdx = 0;
      imgEl.src = currentImages[0];
    };
    categorySel.addEventListener('change', setImagesForCategory);
    $('#nextImage').addEventListener('click', () => {
      if (!currentImages.length) return;
      carouselIdx = (carouselIdx + 1) % currentImages.length;
      imgEl.src = currentImages[carouselIdx];
    });
    setImagesForCategory();

    /* ---------- Venue search (shared wiring) ---------- */
    function wireVenueSearch(cfg) {
      const { search, clearBtn, pop, list, nores, idOut, newForm, nameIn, streetIn, pcIn, createBtn } = cfg;
      let t;
      async function queryVenues(q) {
        const clean = q.replace(/[^a-zA-Z0-9\s'-]/g, '').trim();
        if (!clean) return [];
        const { data, error } = await supabase
          .from('venues')
          .select('id, venue_name, street_name, postcode')
          .ilike('venue_name', `%${clean}%`)
          .limit(5);
        return error ? [] : data || [];
      }
      function render(items) {
        list.innerHTML = '';
        nores.classList.add('hidden');
        if (!items.length) { nores.classList.remove('hidden'); return; }
        items.forEach(v => {
          const div = document.createElement('div');
          div.className = 'venue-card';
          div.innerHTML = `<div class="font-semibold">${v.venue_name}</div>
                           <div class="text-gray-300">${[v.street_name, v.postcode].filter(Boolean).join(', ')}</div>`;
          div.onclick = () => { search.value = v.venue_name; idOut.value = v.id; pop.classList.add('hidden'); };
          list.appendChild(div);
        });
      }
      search.addEventListener('input', () => {
        clearTimeout(t);
        const q = search.value.trim();
        if (!q) { list.innerHTML=''; pop.classList.add('hidden'); return; }
        t = setTimeout(async () => { const results = await queryVenues(q); render(results); pop.classList.remove('hidden'); }, 220);
      });
      search.addEventListener('focus', () => { if (list.children.length) pop.classList.remove('hidden'); });
      clearBtn.addEventListener('click', () => {
        search.value = ''; idOut.value=''; list.innerHTML=''; pop.classList.add('hidden'); newForm?.classList.add('hidden');
      });
      nores?.addEventListener('click', () => { pop.classList.add('hidden'); newForm?.classList.remove('hidden'); });
      createBtn?.addEventListener('click', async () => {
        const n = nameIn.value.trim(), s = streetIn.value.trim(), p = pcIn.value.trim();
        if (!n) return;
        const { data, error } = await supabase.from('venues')
          .insert([{ venue_name: n, street_name: s, postcode: p }]).select('id').single();
        if (error) { log('Venue create failed', false); return; }
        idOut.value = data.id; search.value = n; newForm.classList.add('hidden');
        nameIn.value = streetIn.value = pcIn.value = '';
      });
    }

    /* Wire Single + Recurring searches */
    wireVenueSearch({
      search: $('#recVenueSearch'), clearBtn: $('#recVenueClear'),
      pop: $('#recResultsPop'), list: $('#recVenueResults'), nores: $('#recNoVenueResults'),
      idOut: $('#recVenueId'), newForm: $('#recNewVenueForm'),
      nameIn: $('#recNewName'), streetIn: $('#recNewStreet'), pcIn: $('#recNewPC'), createBtn: $('#recCreateVenue')
    });

    /* ---------- Tabs ---------- */
    function setTab(which) {
      const s = $('#tabSingle'), r = $('#tabRecurring'), t = $('#tabTour');
      const ps = $('#panelSingle'), pr = $('#panelRecurring'), pt = $('#panelTour');
      [s, r, t].forEach(el => { el.classList.remove('pill-on'); el.classList.add('pill-off'); });
      ps.classList.add('hidden'); pr.classList.add('hidden'); pt.classList.add('hidden');
      if (which==='single'){ s.classList.add('pill-on'); ps.classList.remove('hidden'); }
      if (which==='recurring'){ r.classList.add('pill-on'); pr.classList.remove('hidden'); }
      if (which==='tour'){ t.classList.add('pill-on'); pt.classList.remove('hidden'); }
    }
    $('#tabSingle').addEventListener('click', ()=>setTab('single'));
    $('#tabRecurring').addEventListener('click', ()=>setTab('recurring'));
    $('#tabTour').addEventListener('click', ()=>setTab('tour'));
    setTab('single');

    /* ---------- Submit ---------- */
    async function insertEvents(rows) {
      if (!rows.length) return { error: { message:'No rows to insert' } };
      const { data, error } = await supabase.from('events').insert(rows).select('id');
      return { data, error };
    }

    $('#submitBtn').addEventListener('click', async () => {
      $('#statusBox').textContent = 'Submitting...\n';

      const name = $('#eventName').value.trim();
      const description = $('#eventDescription').value.trim();
      const publish_status = $('#publishStatus').value;
      const organiser_id = $('#organiser_id').value && $('#organiser_id').value!=='Not logged in' ? $('#organiser_id').value : null;
      const image_url = $('#categoryImage').src;

      if (!name) { log('Event name is required', false); return; }
      if (!organiser_id) { log('Must be logged in', false); return; }

      const venue_id = $('#recVenueId').value.trim();
      const ticket_url = $('#recTicketLink').value.trim() || null;
      const date = $$('.recDate')[0]?.value;
      const time = $$('.recTime')[0]?.value;
      if (!venue_id || !date || !time) { log('Venue, date, and time required', false); return; }

      const rows = [{ event_name:name, description, image_url, publish_status, organiser_id,
                      venue_id, ticket_url, event_date:date, event_time:time }];

      const { data, error } = await insertEvents(rows);
      if (error) { log(error.message, false); return; }
      log(`Success: inserted ${data.length} row(s).`);
    });
  </script>
</body>
</html>
