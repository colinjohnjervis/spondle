<!DOCTYPE html>
<html lang="en">
<head>
  <!-- SECTION: HEAD -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Event â€“ Spondle</title>

  <!-- Tailwind + Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Shared layout (sidebar + sticky header) -->
  <link rel="stylesheet" href="./spondle-layout.css?v=global-9">
  <script src="./spondle-layout.js?v=global-9" defer></script>

  <!-- SECTION: PAGE STYLES -->
  <style>
    body{background:#000;color:#fff;font-family:ui-sans-serif,system-ui,sans-serif;min-height:100vh;}
    .card{background:#0f172a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45);width:100%;max-width:1100px;}
    .input-dark{background:#0b1220;color:#fff;width:100%;}
    .input-dark::placeholder{color:#9ca3af;}
    .input-dark:focus{border-color:#3b82f6!important;outline:none;box-shadow:0 0 0 1.5px #3b82f6;}
    .results-pop{position:absolute;left:-6px;right:-6px;top:calc(100% + 6px);z-index:60;background:#0f172a;border-radius:12px;padding:10px;}
    .venue-card{background:#111827;border:1px solid #374151;border-radius:12px;padding:12px 14px;margin:8px 0;}
    .venue-card:hover{background:#1b2433;cursor:pointer;}
    .no-results{padding:12px 14px;background:#111827;border:1px solid #374151;border-radius:12px;text-align:center;color:#9ca3af;margin:8px 0;cursor:pointer;}
    .no-results:hover{background:#1b2433;}
    .pill{border-radius:9999px;padding:.6rem 1rem;font-weight:600;text-align:center;width:50%;}
    .pill-on{background:#22c55e;color:#000;}
    .pill-off{background:#374151;color:#e5e7eb;}
    .tour-inline-remove{font-size:18px;line-height:1;width:28px;height:28px;border-radius:9999px;display:flex;align-items:center;justify-content:center;background:#0b1220;border:1px solid #374151;color:#cbd5e1;}
    .tour-inline-remove:hover{color:#fff;border-color:#4b5563;}
  </style>
</head>

<body>
  <!-- SECTION: STICKY HEADER + SIDEBAR -->
  <header class="sp-header fixed top-0 left-0 right-0 z-50"></header>
  <aside class="sp-sidebar fixed top-0 left-0 z-40"></aside>
  <div class="sp-overlay"></div>

  <!-- SECTION: MAIN CONTENT WRAPPER -->
  <main class="flex justify-center mt-28 mb-10 px-6">
    <div class="card p-8 w-full">
      <h1 class="text-3xl font-bold text-white mb-6">Create Event</h1>

      <!-- SECTION: FORM START -->
      <form id="eventForm" class="space-y-6">
        <input type="hidden" id="organiser_id" name="organiser_id" />

        <!-- SECTION: EVENT NAME -->
        <div>
          <label class="block text-sm text-gray-300 mb-2">Event Name</label>
          <input id="eventName" type="text" name="event_name" required placeholder="Enter event name" class="input-dark p-3 rounded-lg border border-gray-700">
        </div>

        <!-- SECTION: CATEGORY -->
        <div>
          <label class="block text-sm text-gray-300 mb-2">Category</label>
          <select id="eventCategory" name="category" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
            <option value="">Select Category</option>
            <option value="music">Music</option>
            <option value="comedy">Comedy</option>
            <option value="theatre">Theatre</option>
            <option value="sports">Sports</option>
            <option value="festival">Festival</option>
            <option value="quiz">Quiz</option>
          </select>
        </div>

        <!-- SECTION: IMAGE (simple upload + preview) -->
        <div>
          <label class="block text-sm text-gray-300 mb-2">Event Image</label>
          <input id="eventImage" type="file" accept="image/*" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <img id="eventImagePreview" alt="Preview" class="mt-3 w-full h-96 object-cover rounded-lg hidden">
        </div>

        <!-- SECTION: DESCRIPTION -->
        <div>
          <label class="block text-sm text-gray-300 mb-2">Description</label>
          <textarea id="eventDescription" rows="4" placeholder="Describe your event..." class="input-dark p-3 rounded-lg border border-gray-700"></textarea>
        </div>

        <!-- SECTION: SCHEDULE TABS -->
        <div class="flex space-x-2 mb-6 w-full">
          <button type="button" id="tabSingle" class="pill pill-on">Single / Recurring</button>
          <button type="button" id="tabTour" class="pill pill-off">Tour Schedule</button>
        </div>

        <!-- SECTION: SINGLE / RECURRING PANEL -->
        <div id="panelSingle">
          <!-- SECTION: VENUE SEARCH (single/recurring) -->
          <div class="mb-6 relative">
            <label class="block text-sm text-gray-300 mb-2">Venue</label>
            <div class="input-wrapper relative">
              <input id="srVenueSearch" type="text" placeholder="Search by venue name..." class="input-dark p-3 rounded-lg border border-gray-700">
              <button id="srVenueClear" type="button" class="absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
              <div id="srResultsPop" class="results-pop hidden">
                <div id="srVenueResults"></div>
                <div id="srNoVenueResults" class="no-results hidden">
                  No matches found.<br><span class="text-blue-400 underline">+ Add new venue</span>
                </div>
              </div>
            </div>

            <input id="srVenueId" type="text" readonly placeholder="Venue ID will appear here" class="input-dark p-3 rounded-lg border border-gray-700 text-blue-400 mt-2">

            <!-- SECTION: Ticket Link (optional) -->
            <input id="srTicketLink" type="text" placeholder="Ticket link (optional) e.g. https://ticketsite.com/abc" class="input-dark p-3 rounded-lg border border-gray-700 text-gray-300 mt-2">

            <!-- SECTION: NEW VENUE FORM -->
            <div id="srNewVenueForm" class="hidden mt-4 space-y-2">
              <input id="srNewName"   type="text" placeholder="Venue name"     class="input-dark p-3 rounded-lg border border-gray-700 w-full">
              <input id="srNewStreet" type="text" placeholder="Street address" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
              <input id="srNewPC"     type="text" placeholder="Postcode"       class="input-dark p-3 rounded-lg border border-gray-700 w-full">
              <button id="srCreateVenue" class="bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
            </div>
          </div>

          <!-- SECTION: DATE/TIME ROWS -->
          <div class="grid grid-cols-2 gap-4 items-end mb-4">
            <div>
              <label class="block text-sm text-gray-300 mb-2">From</label>
              <input id="fromDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY">
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-2">Time</label>
              <select id="fromTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 items-end mb-4">
            <div>
              <label class="block text-sm text-gray-300 mb-2">To</label>
              <input id="toDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY">
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-2">Time</label>
              <select id="toTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
            </div>
          </div>

          <!-- SECTION: REPEAT -->
          <div class="mb-4">
            <label class="block text-sm text-gray-300 mb-2">Repeat</label>
            <select id="repeatType" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
              <option value="none">Does not repeat</option>
              <option value="everyday">Every day</option>
              <option value="everyweek">Every week</option>
              <option value="every2weeks">Every 2 weeks</option>
              <option value="everymonth">Every month</option>
              <option value="everyyear">Every year</option>
            </select>
          </div>

          <!-- SECTION: REPEAT UNTIL -->
          <div id="repeatUntilWrap" class="hidden mb-4">
            <label class="block text-sm text-gray-300 mb-2">Repeat until</label>
            <input id="repeatUntil" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY">
          </div>
        </div>
        <!-- END SECTION: SINGLE / RECURRING PANEL -->

        <!-- SECTION: TOUR SCHEDULE PANEL -->
        <div id="panelTour" class="hidden">
          <div id="tourRoot"></div>
          <button id="addTourBlockBtn" type="button" class="mt-6 bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-3 rounded-lg w-full">
            + Add another venue/date
          </button>
        </div>
        <!-- END SECTION: TOUR SCHEDULE PANEL -->

        <!-- SECTION: SUBMIT (button at end of form) -->
        <div class="pt-6">
          <button id="submitEvent" type="submit" class="bg-green-500 hover:bg-green-400 text-black font-semibold px-6 py-3 rounded-lg w-full">
            Submit Event
          </button>
        </div>
      </form>
      <!-- SECTION: FORM END -->
    </div>
  </main>

  <!-- SECTION: SCRIPT START -->
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    /* SECTION: Supabase client */
    const supabase = window.supabase.createClient(
      "https://jvuunvnbpdfrttusgelz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY"
    );

    /* SECTION: Layout boot */
    try { window.Layout?.init?.({ active: "dashboard" }); } catch(e){}

    /* SECTION: Get user -> organiser_id */
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) document.getElementById('organiser_id').value = user.id;
    } catch(e) {}

    /* SECTION: Image preview */
    const imgInput = document.getElementById('eventImage');
    const imgPrev  = document.getElementById('eventImagePreview');
    imgInput.addEventListener('change', () => {
      const f = imgInput.files?.[0];
      if (!f) { imgPrev.classList.add('hidden'); return; }
      const url = URL.createObjectURL(f);
      imgPrev.src = url;
      imgPrev.classList.remove('hidden');
    });

    /* SECTION: Helpers (dates/times) */
    const formatUK = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    const parseUK  = s => { const [dd,mm,yyyy]=s.split('/').map(n=>parseInt(n,10)); return new Date(yyyy,mm-1,dd); };
    const today = new Date();
    const addMonths = (d,n)=>{const x=new Date(d);x.setMonth(x.getMonth()+n);return x;};

    /* SECTION: Fill 15-min times */
    const fromTime = document.getElementById('fromTime');
    const toTime   = document.getElementById('toTime');
    const fillTimes = (sel)=>{ sel.innerHTML=''; for(let m=0;m<24*60;m+=15){ const hh=Math.floor(m/60),mm=m%60; const label=`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; sel.add(new Option(label,label)); }};
    fillTimes(fromTime); fillTimes(toTime);
    fromTime.value='19:00'; toTime.value='22:00';

    /* SECTION: Datepickers (Flowbite) */
    const fromDateEl=document.getElementById('fromDate');
    const toDateEl  =document.getElementById('toDate');
    fromDateEl.value=formatUK(today); toDateEl.value=formatUK(today);
    const fromDP=new Datepicker(fromDateEl,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    const toDP  =new Datepicker(toDateEl,  {autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    fromDateEl.onclick=()=>fromDP.show(); toDateEl.onclick=()=>toDP.show();

    /* SECTION: Keep To >= From for date */
    fromDateEl.addEventListener('changeDate',()=>{
      const f=parseUK(fromDateEl.value), t=parseUK(toDateEl.value);
      if(t<f){ toDateEl.value=fromDateEl.value; toDP.setDate(f); }
    });

    /* SECTION: Keep To time > From time */
    fromTime.addEventListener('change', ()=>{
      const [fh,fm]=fromTime.value.split(':').map(Number);
      const [th,tm]=toTime.value.split(':').map(Number);
      const fmins=fh*60+fm, tmins=th*60+tm;
      if(tmins<=fmins){
        const bump=fmins+60; const hh=String(Math.floor(bump/60)%24).padStart(2,'0'); const mm=String(bump%60).padStart(2,'0');
        toTime.value=`${hh}:${mm}`;
      }
    });

    /* SECTION: Repeat until visibility + maxDate 12 months */
    const repeatTypeEl=document.getElementById('repeatType');
    const repeatWrap  =document.getElementById('repeatUntilWrap');
    const repeatUntilEl=document.getElementById('repeatUntil');
    const untilDP=new Datepicker(repeatUntilEl,{autohide:true,language:'en-GB',format:'dd/mm/yyyy'});
    repeatUntilEl.onclick=()=>untilDP.show();
    const toggleRepeat=()=>{
      const hasRepeat = repeatTypeEl.value!=='none';
      repeatWrap.classList.toggle('hidden', !hasRepeat);
      if(hasRepeat){
        const start=parseUK(fromDateEl.value);
        const limit=addMonths(start,12);
        untilDP.setOptions({maxDate:limit});
        repeatUntilEl.value=formatUK(start);
      }
    };
    repeatTypeEl.addEventListener('change',toggleRepeat);
    toggleRepeat();

    /* SECTION: Tabs */
    const tabSingle=document.getElementById('tabSingle');
    const tabTour  =document.getElementById('tabTour');
    const panelSingle=document.getElementById('panelSingle');
    const panelTour  =document.getElementById('panelTour');
    function setTab(which){
      if(which==='single'){
        tabSingle.classList.add('pill-on'); tabSingle.classList.remove('pill-off');
        tabTour.classList.add('pill-off');  tabTour.classList.remove('pill-on');
        panelSingle.classList.remove('hidden'); panelTour.classList.add('hidden');
      } else {
        tabTour.classList.add('pill-on'); tabTour.classList.remove('pill-off');
        tabSingle.classList.add('pill-off'); tabSingle.classList.remove('pill-on');
        panelTour.classList.remove('hidden'); panelSingle.classList.add('hidden');
        if(!panelTour.dataset.init){ addTourBlock(true); panelTour.dataset.init='1'; }
      }
    }
    tabSingle.onclick=()=>setTab('single');
    tabTour.onclick=()=>setTab('tour');

    /* SECTION: Venue search (Single/Recurring) */
    const srSearch = document.getElementById('srVenueSearch');
    const srClear  = document.getElementById('srVenueClear');
    const srResultsPop = document.getElementById('srResultsPop');
    const srResults = document.getElementById('srVenueResults');
    const srNoResults = document.getElementById('srNoVenueResults');
    const srVenueId = document.getElementById('srVenueId');
    const srNewForm = document.getElementById('srNewVenueForm');
    const srNewName = document.getElementById('srNewName');
    const srNewStreet = document.getElementById('srNewStreet');
    const srNewPC = document.getElementById('srNewPC');
    const srCreateVenue = document.getElementById('srCreateVenue');
    let srTimeout;

    async function searchVenuesRelevance(query){
      const clean = query.replace(/[^a-zA-Z0-9\s'-]/g,'').trim();
      if(!clean) return [];
      const { data, error } = await supabase
        .from('venues')
        .select('id, venue_name, street_name, postcode')
        .ilike('venue_name', `%${clean}%`);
      if(error||!data) return [];
      const lower=clean.toLowerCase();
      const starts = data.filter(v=>v.venue_name?.toLowerCase().startsWith(lower));
      const others = data.filter(v=>!v.venue_name?.toLowerCase().startsWith(lower));
      const ordered=[...starts,...others];
      // Final Aâ€“Z for ties:
      ordered.sort((a,b)=>a.venue_name.localeCompare(b.venue_name));
      return ordered.slice(0,5);
    }

    function renderSrVenues(list){
      srResults.innerHTML=''; srNoResults.classList.add('hidden');
      if(!list.length){ srNoResults.classList.remove('hidden'); return; }
      list.forEach(v=>{
        const div=document.createElement('div');
        div.className='venue-card';
        div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
          <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
        div.onclick=()=>{ srSearch.value=v.venue_name; srVenueId.value=v.id; srResultsPop.classList.add('hidden'); srNewForm.classList.add('hidden'); };
        srResults.appendChild(div);
      });
    }

    srSearch.oninput=()=>{
      clearTimeout(srTimeout);
      const val=srSearch.value.trim();
      if(!val){ srResults.innerHTML=''; srResultsPop.classList.add('hidden'); return; }
      srTimeout=setTimeout(async()=>{ const results=await searchVenuesRelevance(val); renderSrVenues(results); srResultsPop.classList.remove('hidden'); },250);
    };
    srSearch.onfocus = () => { if (srResults.children.length) srResultsPop.classList.remove('hidden'); };
    srClear.onclick = () => { srSearch.value=''; srVenueId.value=''; srResults.innerHTML=''; srResultsPop.classList.add('hidden'); };
    srNoResults.onclick = () => { srResultsPop.classList.add('hidden'); srNewForm.classList.remove('hidden'); };
    srCreateVenue.onclick = async () => {
      const n = srNewName.value.trim(), s = srNewStreet.value.trim(), p = srNewPC.value.trim();
      if(!n) return;
      const { data, error } = await supabase.from('venues').insert([{ venue_name:n, street_name:s, postcode:p }]).select('id').single();
      if(error||!data) return;
      srVenueId.value = data.id; srSearch.value = n; srNewForm.classList.add('hidden');
      srNewName.value=''; srNewStreet.value=''; srNewPC.value='';
    };

    /* ======== PART 2 continues below (tour blocks + submit) ======== */

    /* SECTION: Tour schedule blocks */
    const tourRoot = document.getElementById('tourRoot');
    const addTourBtn = document.getElementById('addTourBlockBtn');

    function addTourBlock(isFirst=false){
      if(tourRoot.children.length){
        const sep=document.createElement('div');
        sep.className='h-px bg-blue-500 my-6';
        tourRoot.appendChild(sep);
      }

      const root=document.createElement('div');
      root.innerHTML=`
        <div class="mb-6 relative">
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm text-gray-300">Venue</label>
            ${!isFirst ? '<button type="button" class="tour-inline-remove removeBtn" title="Remove">Ã—</button>' : ''}
          </div>
          <div class="input-wrapper relative">
            <input type="text" placeholder="Search by venue name..." class="venueSearch input-dark p-3 rounded-lg border border-gray-700 focus:border-blue-500">
            <button type="button" class="clearVenue absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
            <div class="results-pop hidden">
              <div class="venueResults"></div>
              <div class="noVenueResults no-results hidden">No matches found.<br><span class="text-blue-400 underline">+ Add new venue</span></div>
            </div>
          </div>
          <input type="text" readonly placeholder="Venue ID will appear here" class="venueId input-dark p-3 rounded-lg border border-gray-700 text-blue-400 mt-2">
          <input type="text" placeholder="Ticket link (optional) e.g. https://ticketsite.com/event123" class="ticketLink input-dark p-3 rounded-lg border border-gray-700 text-gray-300 mt-2">
          <div class="newVenueForm hidden mt-4 space-y-2">
            <input type="text" placeholder="Venue name" class="newVenueName input-dark p-3 rounded-lg border border-gray-700 w-full">
            <input type="text" placeholder="Street address" class="newVenueStreet input-dark p-3 rounded-lg border border-gray-700 w-full">
            <input type="text" placeholder="Postcode" class="newVenuePostcode input-dark p-3 rounded-lg border border-gray-700 w-full">
            <button class="createVenueBtn bg-blue-500 hover:bg-blue-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 items-end">
          <div><label class="block text-sm text-gray-300 mb-2">From</label><input type="text" readonly class="fromDate input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" /></div>
          <div><label class="block text-sm text-gray-300 mb-2">Time</label><select class="fromTime input-dark p-3 rounded-lg border border-gray-700"></select></div>
        </div>
        <div class="grid grid-cols-2 gap-4 items-end mt-6">
          <div><label class="block text-sm text-gray-300 mb-2">To</label><input type="text" readonly class="toDate input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" /></div>
          <div><label class="block text-sm text-gray-300 mb-2">Time</label><select class="toTime input-dark p-3 rounded-lg border border-gray-700"></select></div>
        </div>
      `;
      tourRoot.appendChild(root);
      initTourBlock(root,isFirst);
    }

    addTourBtn.onclick=()=>addTourBlock(false);

    async function searchVenues(q){
      const clean=q.replace(/[^a-zA-Z0-9\s'-]/g,'').trim();
      if(!clean) return [];
      const {data}=await supabase.from('venues').select('id, venue_name, street_name, postcode').ilike('venue_name',`%${clean}%`);
      if(!data) return [];
      const startsWith=data.filter(v=>v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
      const others=data.filter(v=>!v.venue_name.toLowerCase().startsWith(clean.toLowerCase()));
      return [...startsWith,...others].slice(0,5);
    }

    function initTourBlock(scope,isFirst){
      const removeBtn=scope.querySelector('.removeBtn');
      if(removeBtn){
        removeBtn.onclick=()=>{
          const prev=scope.previousElementSibling;
          if(prev && prev.classList.contains('h-px')) prev.remove();
          scope.remove();
        };
      }

      const vSearch=scope.querySelector('.venueSearch');
      const vId=scope.querySelector('.venueId');
      const results=scope.querySelector('.results-pop');
      const vResults=scope.querySelector('.venueResults');
      const noResults=scope.querySelector('.noVenueResults');
      const newForm=scope.querySelector('.newVenueForm');
      const clearBtn=scope.querySelector('.clearVenue');
      const nName=scope.querySelector('.newVenueName');
      const nStreet=scope.querySelector('.newVenueStreet');
      const nPost=scope.querySelector('.newVenuePostcode');
      const createBtn=scope.querySelector('.createVenueBtn');
      const fromDate=scope.querySelector('.fromDate');
      const toDate=scope.querySelector('.toDate');
      const fromTime=scope.querySelector('.fromTime');
      const toTime=scope.querySelector('.toTime');
      let timeout;

      function open(){results.classList.remove('hidden');}
      function close(){results.classList.add('hidden');}
      function render(list){
        vResults.innerHTML=''; noResults.classList.add('hidden');
        if(!list.length){ noResults.classList.remove('hidden'); return; }
        list.forEach(v=>{
          const div=document.createElement('div');
          div.className='venue-card';
          div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
                         <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
          div.onclick=()=>{ vSearch.value=v.venue_name; vId.value=v.id; close(); newForm.classList.add('hidden'); };
          vResults.appendChild(div);
        });
      }

      vSearch.oninput=()=>{
        clearTimeout(timeout);
        const q=vSearch.value.trim();
        if(!q){ vResults.innerHTML=''; close(); return; }
        timeout=setTimeout(async()=>{ const list=await searchVenues(q); render(list); open(); },250);
      };
      vSearch.onfocus=()=>{ if(vResults.children.length) open(); };
      clearBtn.onclick=()=>{ vSearch.value=''; vId.value=''; vResults.innerHTML=''; close(); newForm.classList.add('hidden'); };
      noResults.onclick=()=>{ close(); newForm.classList.remove('hidden'); };
      createBtn.onclick=async()=>{
        const name=nName.value.trim(), street=nStreet.value.trim(), pc=nPost.value.trim();
        if(!name) return;
        const {data}=await supabase.from('venues').insert([{venue_name:name,street_name:street,postcode:pc}]).select('id').single();
        vId.value=data.id; vSearch.value=name; newForm.classList.add('hidden');
        nName.value=''; nStreet.value=''; nPost.value='';
      };

      fromDate.value=formatUK(today); toDate.value=formatUK(today);
      fillTimes(fromTime); fillTimes(toTime);
      fromTime.value='19:00'; toTime.value='22:00';
      const fp=new Datepicker(fromDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
      const tp=new Datepicker(toDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
      fromDate.onclick=()=>fp.show(); toDate.onclick=()=>tp.show();
      fromDate.addEventListener('changeDate',()=>{const f=parseUK(fromDate.value);const t=parseUK(toDate.value);
        if(t<f){toDate.value=fromDate.value;tp.setDate(f);} });
      fromTime.onchange=()=>{const[fh,fm]=fromTime.value.split(':').map(Number);
        const[th,tm]=toTime.value.split(':').map(Number);
        const fmins=fh*60+fm,tmins=th*60+tm;
        if(tmins<=fmins){const bump=fmins+60;
          const hh=String(Math.floor(bump/60)%24).padStart(2,'0');
          const mm=String(bump%60).padStart(2,'0');
          toTime.value=`${hh}:${mm}`;}};
    }

    /* SECTION: Form submission */
    document.getElementById('eventForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const organiser_id=document.getElementById('organiser_id').value;
      const event_name=document.getElementById('eventName').value.trim();
      const category=document.getElementById('eventCategory').value;
      const description=document.getElementById('eventDescription').value.trim();
      const venue_id=document.getElementById('srVenueId').value;
      const event_date=document.getElementById('fromDate').value;
      const event_time=document.getElementById('fromTime').value;

      if(!event_name||!venue_id){ alert("Please fill in all required fields."); return; }

      const { error } = await supabase.from('events').insert([{
        organiser_id, event_name, category, description,
        venue_id, event_date, event_time
      }]);

      if(error){
        alert("Error creating event: "+error.message);
      } else {
        alert("Event created successfully!");
        document.getElementById('eventForm').reset();
        const imgPrev=document.getElementById('eventImagePreview');
        if(imgPrev) imgPrev.classList.add('hidden');
      }
    });

  }); // end DOMContentLoaded
  </script>
</body>
</html>                        
