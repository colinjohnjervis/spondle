<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spondle – Event Plugin Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">
  <div class="max-w-3xl mx-auto">
    <div class="bg-gray-800 p-6 rounded-lg shadow mb-6">
      <h1 class="text-2xl font-bold mb-2">Event Plugin Generator</h1>
      <p class="text-gray-300 mb-4">
        Generate a custom embed code to display your events on your own website.
        Just copy the snippet and paste it into your site’s HTML — nothing else required.
      </p>
      <button id="generateBtn" class="px-4 py-2 bg-green-500 text-black rounded font-semibold hover:opacity-90">
        Generate My Embed Code
      </button>
    </div>

    <div id="embedBox" class="hidden mb-6">
      <h2 class="text-xl font-semibold mb-2">Your Embed Code</h2>
      <textarea id="embedCode" class="w-full p-3 text-sm font-mono bg-gray-900 text-green-400 rounded h-48"></textarea>
      <button id="copyBtn" class="mt-2 px-4 py-2 bg-blue-500 text-black rounded hover:opacity-90">
        Copy to Clipboard
      </button>
    </div>

    <div id="previewSection" class="hidden">
      <h2 class="text-xl font-semibold mb-2">Preview</h2>
      <div id="previewList" class="bg-gray-800 p-4 rounded"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://jvuunvnbpdfrttusgelz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY"
    );

    const generateBtn = document.getElementById("generateBtn");
    const embedBox = document.getElementById("embedBox");
    const embedCode = document.getElementById("embedCode");
    const copyBtn = document.getElementById("copyBtn");
    const previewSection = document.getElementById("previewSection");
    const previewList = document.getElementById("previewList");

    let organiserId = null;

    async function getUser() {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) organiserId = user.id; 
    }

    generateBtn.addEventListener("click", async () => {
      await getUser();
      if (!organiserId) {
        alert("You must be logged in to generate your embed code.");
        return;
      }

      // Build inline snippet
      const snippet = `
<div id="spondle-events"></div>
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  const supabase = createClient("https://jvuunvnbpdfrttusgelz.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY");

  const organiserId = "${organiserId}";
  async function loadEvents() {
    const { data: events, error } = await supabase
      .from("events")
      .select("event_name, event_date, venue_id")
      .eq("organiser_id", organiserId)
      .eq("publish_status", "published")
      .order("event_date", { ascending: true })
      .limit(10);

    const container = document.getElementById("spondle-events");
    if (error) {
      container.innerHTML = "<p>Error loading events.</p>";
      return;
    }
    if (!events || !events.length) {
      container.innerHTML = "<p>No upcoming events.</p>";
      return;
    }

    container.innerHTML = events.map(e =>
      \`<div class="py-1">\${e.event_date} — <strong>\${e.event_name}</strong> @ Venue \${e.venue_id}</div>\`
    ).join("");
  }
  loadEvents();
<\/script>`.trim();

      embedCode.value = snippet;
      embedBox.classList.remove("hidden");
      previewSection.classList.remove("hidden");
      loadPreview();
    });

    copyBtn.addEventListener("click", () => {
      embedCode.select();
      document.execCommand("copy");
      copyBtn.textContent = "Copied!";
      setTimeout(() => (copyBtn.textContent = "Copy to Clipboard"), 2000);
    });

    async function loadPreview() {
      const { data: events, error } = await supabase
        .from("events")
        .select("event_name, event_date, venue_id")
        .eq("organiser_id", organiserId)
        .eq("publish_status", "published")
        .order("event_date", { ascending: true })
        .limit(10);

      if (error) {
        console.error(error);
        previewList.innerHTML = "<p class='text-red-400'>Error loading preview.</p>";
        return;
      }
      if (!events || !events.length) {
        previewList.innerHTML = "<p class='text-gray-400'>No published events to show.</p>";
        return;
      }

      previewList.innerHTML = events.map(e =>
        \`<div class="py-1">\${e.event_date} — <strong>\${e.event_name}</strong> @ Venue \${e.venue_id}</div>\`
      ).join("");
    }
  </script>
</body>
</html>
