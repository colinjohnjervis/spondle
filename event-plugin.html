<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Event Plugin Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 2rem;
      background: #f9f9f9;
      color: #111;
      max-width: 600px;
      margin: auto;
    }
    input, select, textarea, button {
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.6rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #000;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    textarea {
      height: 180px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1><strong>Event Plugin Generator</strong></h1>

  <label for="organiserId">Your Organiser ID</label>
  <input type="text" id="organiserId" placeholder="e.g. 05c1463f-510d-4e40-a5fc-f5aa6138a716" />

  <label for="bgColor">Background Colour (Hex)</label>
  <input type="text" id="bgColor" placeholder="e.g. ffffff" />

  <label for="textColor">Text Colour (Hex)</label>
  <input type="text" id="textColor" placeholder="e.g. 000000" />

  <label for="pluginStyle">Plugin Style</label>
  <select id="pluginStyle">
    <option value="default">Default</option>
    <option value="fixture">Fixture</option>
  </select>

  <button id="generateBtn">Generate Plugin Code</button>

  <h2>Your Copyable Plugin Code</h2>
  <textarea id="codeOutput" readonly>Please enter your organiser ID.</textarea>

  <script>
    const supabase = supabase.createClient(
      'https://jvuunvnbpdfrttusgelz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY'
    );

    const organiserInput = document.getElementById('organiserId');
    const bgInput = document.getElementById('bgColor');
    const textInput = document.getElementById('textColor');
    const styleSelect = document.getElementById('pluginStyle');
    const generateBtn = document.getElementById('generateBtn');
    const codeOutput = document.getElementById('codeOutput');

    async function getUserId() {
      await supabase.auth.getSession(); // Restore session
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        organiserInput.value = user.id;
        updateCode();
      } else {
        organiserInput.placeholder = "Not signed in";
      }
    }

    function updateCode() {
      const organiserId = organiserInput.value.trim();
      const bg = bgInput.value.trim();
      const text = textInput.value.trim();
      const style = styleSelect.value;

      if (!organiserId) {
        codeOutput.value = "Please enter your organiser ID.";
        return;
      }

      const src = `https://spondle-uk.vercel.app/event-plugin-gateway.html?organiser_id=${organiserId}&style=${style}&bg=${bg}&text=${text}`;

      const pluginCode = `
<iframe 
  src="${src}" 
  style="width:100%;border:none;" 
  onload="window.addEventListener('message',function(e){if(e.data.height){document.querySelector('iframe').style.height=e.data.height+'px';}})">
</iframe>`.trim();

      codeOutput.value = pluginCode;
    }

    generateBtn.addEventListener('click', updateCode);
    organiserInput.addEventListener('input', () => codeOutput.value = '');
    bgInput.addEventListener('input', () => codeOutput.value = '');
    textInput.addEventListener('input', () => codeOutput.value = '');
    styleSelect.addEventListener('change', () => codeOutput.value = '');

    getUserId(); // On page load
  </script>
</body>
</html>
