<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Event Plugin Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 720px;
      margin: auto;
    }

    textarea {
      width: 100%;
      height: 180px;
      font-family: monospace;
      font-size: 14px;
      margin-top: 1rem;
    }

    #errorLog {
      color: red;
      margin-top: 1rem;
      display: none;
    }

    button {
      padding: 0.6rem 1.2rem;
      background: black;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 1rem;
    }

    .event-card {
      border: 1px solid #ddd;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
    }

    .event-card h3 {
      margin: 0 0 4px 0;
      font-size: 1.1rem;
    }

    .event-card p {
      margin: 0;
      font-size: 0.9rem;
    }

    #eventList {
      margin-top: 2rem;
    }

    #userStatus {
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: #f4f4f4;
      border-left: 4px solid #444;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Event Plugin</h1>

  <div id="errorLog"></div>
  <div id="userStatus" style="display: none;"></div>
  <div id="pluginTool" style="display: none;">
    <p>This will generate an iframe snippet you can paste into your website.</p>
    <button id="generateBtn">Generate Plugin Code</button>
    <textarea id="pluginCode" placeholder="Your plugin code will appear here..." readonly></textarea>
  </div>

  <div id="eventList" style="display: none;"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient(
      'https://jvuunvnbpdfrttusgelz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY'
    );

    const urlParams = new URLSearchParams(window.location.search);
    const organiserId = urlParams.get('organiser_id');
    const errorBox = document.getElementById("errorLog");
    const eventList = document.getElementById("eventList");

    async function showLiveEvents(id) {
      try {
        errorBox.style.display = "none";
        eventList.innerHTML = "<p>Loading events...</p>";
        eventList.style.display = "block";

        const { data, error } = await supabase
          .from('events')
          .select('title, date, venue:venue_id(name)')
          .eq('organiser_id', id)
          .order('date', { ascending: true });

        if (error) throw error;

        if (!data || data.length === 0) {
          eventList.innerHTML = "<p>No events found.</p>";
          return;
        }

        eventList.innerHTML = data.map(evt => `
          <div class="event-card">
            <h3>${evt.title}</h3>
            <p>${new Date(evt.date).toLocaleDateString()}</p>
            <p>üìç ${evt.venue?.name || 'Unknown venue'}</p>
          </div>
        `).join('');
      } catch (err) {
        errorBox.textContent = "Error loading events: " + (err.message || err);
        errorBox.style.display = "block";
      }
    }

    async function showPluginTool() {
      const pluginTool = document.getElementById("pluginTool");
      const pluginCode = document.getElementById("pluginCode");
      const generateBtn = document.getElementById("generateBtn");
      const userStatus = document.getElementById("userStatus");

      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) throw error;

        if (!user) {
          userStatus.textContent = "‚ùå You are not signed in.";
          userStatus.style.display = "block";
          return;
        }

        const uid = user.id;
        userStatus.textContent = `‚úÖ Logged in as: ${uid}`;
        userStatus.style.display = "block";
        pluginTool.style.display = "block";

        generateBtn.addEventListener("click", () => {
          const iframeCode = `<iframe src="https://spondle-uk.vercel.app/event-plugin.html?organiser_id=${uid}" width="100%" height="400" frameborder="0"></iframe>`;
          pluginCode.value = iframeCode;
        });
      } catch (err) {
        errorBox.textContent = "Error: " + (err.message || err);
        errorBox.style.display = "block";
      }
    }

    // Determine mode
    if (organiserId) {
      // iframe mode (public view)
      showLiveEvents(organiserId);
    } else {
      // plugin generation mode (private user)
      showPluginTool();
    }
  </script>
</body>
</html>
