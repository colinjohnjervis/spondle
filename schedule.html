<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule Setup – Spondle</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{background:#000;color:#fff;font-family:ui-sans-serif,system-ui,sans-serif;min-height:100vh;}
    .card{background:#0f172a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45);}
    .input-dark{background:#0b1220;color:#fff;width:100%;}
    .input-dark::placeholder{color:#9ca3af;}
    .results-pop{position:absolute;left:-6px;right:-6px;top:calc(100% + 6px);z-index:60;background:#0f172a;
      border-radius:12px;padding:10px;}
    .venue-card{background:#111827;border:1px solid #374151;border-radius:12px;padding:12px 14px;margin:8px 0;}
    .venue-card:hover{background:#1b2433;cursor:pointer;}
    .no-results{padding:12px 14px;background:#111827;border:1px solid #374151;border-radius:12px;
      text-align:center;font-size:.95rem;color:#9ca3af;margin:8px 0;cursor:pointer;}
    .no-results:hover{background:#1b2433;}
    .pill{border-radius:9999px;padding:.5rem 1rem;font-weight:600;}
    .pill-on{background:#22c55e;color:#000;}
    .pill-off{background:#374151;color:#e5e7eb;}
  </style>
</head>

<body class="flex items-start justify-center py-10">
  <div class="card w-full max-w-xl p-6">
    <h1 class="text-3xl font-bold text-white mb-6">Schedule Setup</h1>

    <div class="flex space-x-2 mb-6">
      <button id="tabSingle" class="pill pill-on">Single / Recurring</button>
      <button id="tabTour" class="pill pill-off">Tour</button>
    </div>

    <!-- SINGLE / RECURRING PANEL -->
    <div id="panelSingle">
      <!-- Venue Search -->
      <div class="mb-6 relative">
        <label class="block text-sm text-gray-300 mb-2">Venue</label>
        <div class="input-wrapper relative">
          <input id="srVenueSearch" type="text" placeholder="Search by venue name..." class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
          <button id="srVenueClear" type="button" class="absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
          <div id="srResultsPop" class="results-pop hidden">
            <div id="srVenueResults"></div>
            <div id="srNoVenueResults" class="no-results hidden">No matches found.<br><span class="text-green-500 underline">+ Add new venue</span></div>
          </div>
        </div>
        <input id="srVenueId" type="text" readonly placeholder="Venue ID will appear here" class="input-dark p-3 rounded-lg border border-gray-700 text-green-400 mt-2">

        <!-- Inline new venue form -->
        <div id="srNewVenueForm" class="hidden mt-4 space-y-2">
          <input id="srNewName" type="text" placeholder="Venue name" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input id="srNewStreet" type="text" placeholder="Street address" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input id="srNewPC" type="text" placeholder="Postcode" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <button id="srCreateVenue" class="bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
        </div>
      </div>

      <!-- DATE / TIME -->
      <div class="grid grid-cols-2 gap-4 items-end mb-4">
        <div>
          <label class="block text-sm text-gray-300 mb-2">From</label>
          <input id="fromDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY">
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select id="fromTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 items-end mb-4">
        <div>
          <label class="block text-sm text-gray-300 mb-2">To</label>
          <input id="toDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY">
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select id="toTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
        </div>
      </div>

      <!-- REPEAT -->
      <div class="mb-4">
        <label class="block text-sm text-gray-300 mb-2">Repeat</label>
        <select id="repeatType" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <option value="none">Does not repeat</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>

      <div id="repeatPreview" class="hidden bg-[#0b1220] border border-gray-700 rounded-lg p-3 text-sm mt-4"></div>
    </div>

    <!-- TOUR PANEL -->
    <div id="panelTour" class="hidden">
      <div id="tourRoot"></div>
      <button id="addTourBlockBtn" class="mt-6 bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-3 rounded-lg w-full">
        + Add another venue/date
      </button>
    </div>
  </div>
<script>
const supabase = window.supabase.createClient(
  "https://jvuunvnbpdfrttusgelz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

// Helpers
const formatUK = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
const parseUK = s => { const [dd,mm,yyyy]=s.split('/').map(n=>parseInt(n,10)); return new Date(yyyy,mm-1,dd); };
const today = new Date();
function fillTimes(sel){ sel.innerHTML=''; for(let m=0;m<24*60;m+=15){ const hh=Math.floor(m/60),mm=m%60;
  const label=`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; sel.add(new Option(label,label)); }}

// Search venues
async function searchVenues(q){
  const clean=q.replace(/[^a-zA-Z0-9\\s'-]/g,'').trim();
  if(!clean)return[];
  const {data,error}=await supabase.from('venues').select('id,venue_name,street_name,postcode')
    .ilike('venue_name', `%${clean}%`).limit(25);
  if(error){console.error(error);return[];}
  const seen=new Set();return data.filter(v=>!seen.has(v.id)&&seen.add(v.id));
}

// Tabs
const tabSingle=document.getElementById('tabSingle');
const tabTour=document.getElementById('tabTour');
const panelSingle=document.getElementById('panelSingle');
const panelTour=document.getElementById('panelTour');
tabSingle.onclick=()=>setTab('single');
tabTour.onclick=()=>setTab('tour');
function setTab(which){
  if(which==='single'){
    tabSingle.classList.add('pill-on');tabSingle.classList.remove('pill-off');
    tabTour.classList.add('pill-off');tabTour.classList.remove('pill-on');
    panelSingle.classList.remove('hidden');panelTour.classList.add('hidden');
  }else{
    tabTour.classList.add('pill-on');tabTour.classList.remove('pill-off');
    tabSingle.classList.add('pill-off');tabSingle.classList.remove('pill-on');
    panelTour.classList.remove('hidden');panelSingle.classList.add('hidden');
    if(!panelTour.dataset.init){addTourBlock();panelTour.dataset.init='1';}
  }
}

// Initialise Single/Recurring
const srEls={
  search:srVenueSearch,clear:srVenueClear,pop:srResultsPop,list:srVenueResults,
  none:srNoVenueResults,form:srNewVenueForm,id:srVenueId,
  nvName:srNewName,nvStreet:srNewStreet,nvPC:srNewPC,create:srCreateVenue
};
(function initSingle(){
  let timeout;const open=()=>srEls.pop.classList.remove('hidden');const close=()=>srEls.pop.classList.add('hidden');
  function render(list){srEls.list.innerHTML='';srEls.none.classList.add('hidden');
    if(!list.length){srEls.none.classList.remove('hidden');return;}
    list.forEach(v=>{const div=document.createElement('div');div.className='venue-card';
      div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
        <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
      div.onclick=()=>{srEls.search.value=v.venue_name;srEls.id.value=v.id;close();srEls.form.classList.add('hidden');};
      srEls.list.appendChild(div);});}
  srEls.search.oninput=()=>{clearTimeout(timeout);const q=srEls.search.value.trim();
    if(!q){srEls.list.innerHTML='';close();return;}
    timeout=setTimeout(async()=>{const list=await searchVenues(q);render(list);open();},250);}
  srEls.clear.onclick=()=>{srEls.search.value='';srEls.id.value='';srEls.list.innerHTML='';close();srEls.form.classList.add('hidden');};
  srEls.none.onclick=()=>{close();srEls.form.classList.remove('hidden');};
  srEls.create.onclick=async()=>{const name=srEls.nvName.value.trim(),street=srEls.nvStreet.value.trim(),pc=srEls.nvPC.value.trim();
    if(!name)return;const {data,error}=await supabase.from('venues')
    .insert([{venue_name:name,street_name:street,postcode:pc}]).select('id').single();
    if(error){console.error(error);return;}
    srEls.id.value=data.id;srEls.search.value=name;srEls.form.classList.add('hidden');
    srEls.nvName.value='';srEls.nvStreet.value='';srEls.nvPC.value='';};

  // Date/time pickers
  const fromDate=fromDate,toDate=toDate,fromTime=fromTime,toTime=toTime;
  fillTimes(fromTime);fillTimes(toTime);
  fromTime.value='10:00';toTime.value='11:00';
  fromDate.value=formatUK(today);toDate.value=formatUK(today);
  const fp=new Datepicker(fromDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
  const tp=new Datepicker(toDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
  fromDate.onclick=()=>fp.show();toDate.onclick=()=>tp.show();

  // Repeat logic
  const repeatType=repeatType,repeatPreview=repeatPreview;
  repeatType.onchange=()=>{
    if(repeatType.value==='none'){repeatPreview.classList.add('hidden');repeatPreview.innerHTML='';return;}
    const start=parseUK(fromDate.value),end=parseUK(toDate.value);
    const occ=[];if(repeatType.value==='daily'){for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1))occ.push(formatUK(d));}
    else if(repeatType.value==='weekly'){for(let d=new Date(start);d<=end;d.setDate(d.getDate()+7))occ.push(formatUK(d));}
    else{for(let d=new Date(start);d<=end;d.setMonth(d.getMonth()+1))occ.push(formatUK(d));}
    repeatPreview.innerHTML=occ.map(d=>`<div>${d}</div>`).join('');repeatPreview.classList.remove('hidden');
  };
})();

// TOUR TAB (working version preserved)
const tourRoot=document.getElementById('tourRoot');
const addTourBtn=document.getElementById('addTourBlockBtn');
function addTourBlock(){
  if(tourRoot.children.length){const sep=document.createElement('div');sep.className='h-px bg-slate-700 my-6';tourRoot.appendChild(sep);}
  const root=document.createElement('div');
  root.innerHTML=`
    <div class="mb-6 relative">
      <div class="flex items-center justify-between mb-2">
        <label class="block text-sm text-gray-300">Venue</label>
        <button type="button" class="tour-inline-remove removeBtn" title="Remove">×</button>
      </div>
      <div class="input-wrapper relative">
        <input type="text" placeholder="Search by venue name..." class="venueSearch input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
        <button type="button" class="clearVenue absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
        <div class="results-pop hidden">
          <div class="venueResults"></div>
          <div class="noVenueResults no-results hidden">No matches found.<br><span class="text-green-500 underline">+ Add new venue</span></div>
        </div>
      </div>
      <input type="text" readonly placeholder="Venue ID will appear here" class="venueId input-dark p-3 rounded-lg border border-gray-700 text-green-400 mt-2">
      <div class="newVenueForm hidden mt-4 space-y-2">
        <input type="text" placeholder="Venue name" class="newVenueName input-dark p-3 rounded-lg border border-gray-700 w-full">
        <input type="text" placeholder="Street address" class="newVenueStreet input-dark p-3 rounded-lg border border-gray-700 w-full">
        <input type="text" placeholder="Postcode" class="newVenuePostcode input-dark p-3 rounded-lg border border-gray-700 w-full">
        <button class="createVenueBtn bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4 items-end">
      <div>
        <label class="block text-sm text-gray-300 mb-2">From</label>
        <input type="text" readonly class="fromDate input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-2">Time</label>
        <select class="fromTime input-dark p-3 rounded-lg border border-gray-700"></select>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4 items-end mt-6">
      <div>
        <label class="block text-sm text-gray-300 mb-2">To</label>
        <input type="text" readonly class="toDate input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-2">Time</label>
        <select class="toTime input-dark p-3 rounded-lg border border-gray-700"></select>
      </div>
    </div>`;
  tourRoot.appendChild(root);
}
addTourBtn.onclick=()=>addTourBlock();
setTab('single');
</script>
</body>
</html>
