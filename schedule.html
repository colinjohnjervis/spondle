<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule Setup – Spondle</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { background:#000; color:#fff; font-family:ui-sans-serif,system-ui,sans-serif; min-height:100vh; }
    .card { background:#0f172a; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.45); }
    .input-dark { background:#0b1220; color:#fff; width:100%; }
    .input-dark::placeholder { color:#9ca3af; }

    .datepicker[role="dialog"] {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      z-index: 9999 !important;
      width: 92%; max-width: 420px;
      background: #fff !important;
      color: #111 !important;
      border-radius: 16px !important;
      box-shadow: 0 20px 60px rgba(0,0,0,.35) !important;
    }
    .datepicker .days .datepicker-cell {
      width: 44px !important;
      height: 44px !important;
      line-height: 44px !important;
      border-radius: 50% !important;
      margin: 4px !important;
      text-align: center !important;
    }
    .datepicker-cell.selected { background:#22c55e !important; color:#fff !important; }

    .results-pop {
      position:absolute;
      left:-6px;
      right:-6px;
      top:calc(100% + 6px);
      z-index:60;
      background:#0f172a;
      border-radius:12px;
      padding:10px 10px;
    }
    .venue-card {
      background:#111827;
      border:1px solid #374151;
      border-radius:12px;
      padding:12px 14px;
      width:100%;
      box-sizing:border-box;
      margin:8px 0;
    }
    .venue-card:hover { background:#1b2433; cursor:pointer; }
    .no-results {
      padding:12px 14px;
      background:#111827;
      border:1px solid #374151;
      border-radius:12px;
      text-align:center;
      font-size:0.95rem;
      color:#9ca3af;
      margin:8px 0;
      cursor:pointer;
    }
    .no-results:hover { background:#1b2433; }

    .tabs { display:flex; gap:8px; background:#0b1220; padding:6px; border-radius:9999px; width:max-content; }
    .tab-btn { padding:8px 14px; border-radius:9999px; border:1px solid #374151; background:#0f172a; color:#e5e7eb; }
    .tab-btn.active { background:#16a34a; color:#000; border-color:#16a34a; }

    .x-circle { position:absolute; right:8px; top:8px; width:28px; height:28px; border-radius:9999px; border:1px solid #374151; display:flex; align-items:center; justify-content:center; color:#e5e7eb; background:#0b1220; }
    .x-circle:hover { background:#1b2433; }
  </style>
</head>

<body class="flex items-start justify-center py-10">
  <div class="card w-full max-w-3xl p-6">
    <h1 class="text-3xl font-bold text-white mb-4">Schedule Setup</h1>

    <div class="tabs mb-6">
      <button id="tabMain" class="tab-btn active">Single / Recurring</button>
      <button id="tabTour" class="tab-btn">Tour</button>
    </div>

    <!-- Single / Recurring -->
    <div id="panelMain">
      <div class="mb-6 relative">
        <label class="block text-sm text-gray-300 mb-2">Venue</label>
        <div class="input-wrapper relative">
          <input id="venueSearch" type="text" placeholder="Search by venue name..."
                 class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
          <button id="clearVenue" type="button"
                  class="absolute right-3 top-3 text-gray-400 hover:text-gray-200"
                  aria-label="Clear">&times;</button>

          <div id="resultsPop" class="results-pop hidden">
            <div id="venueResults"></div>
            <div id="noVenueResults" class="no-results hidden">
              No matches found.<br><span class="text-green-500 underline">+ Add new venue</span>
            </div>
          </div>
        </div>

        <input id="venueId" type="text" readonly placeholder="Venue ID will appear here"
               class="input-dark p-3 rounded-lg border border-gray-700 text-green-400 mt-2">

        <div id="newVenueForm" class="hidden mt-4 space-y-2">
          <input id="newVenueName" type="text" placeholder="Venue name" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input id="newVenueStreet" type="text" placeholder="Street address" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input id="newVenuePostcode" type="text" placeholder="Postcode" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <button id="createVenueBtn" class="bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm text-gray-300 mb-2">From</label>
          <input id="fromDate" type="text" readonly
                 class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"
                 placeholder="DD/MM/YYYY" />
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select id="fromTime"
                  class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"></select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 items-end mt-6">
        <div>
          <label class="block text-sm text-gray-300 mb-2">To</label>
          <input id="toDate" type="text" readonly
                 class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"
                 placeholder="DD/MM/YYYY" />
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select id="toTime"
                  class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"></select>
        </div>
      </div>

      <div class="mt-6">
        <label class="block text-sm text-gray-300 mb-2">Repeat</label>
        <select id="repeatRule"
                class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
          <option value="none">Does not repeat</option>
          <option value="daily">Every day</option>
          <option value="weekly">Every week</option>
          <option value="biweekly">Every 2 weeks</option>
          <option value="monthly">Every month</option>
          <option value="yearly">Every year</option>
        </select>
      </div>

      <div id="repeatUntilWrap" class="mt-6 hidden">
        <label class="block text-sm text-gray-300 mb-2">Repeat until</label>
        <input id="repeatUntil" type="text" readonly
               class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"
               placeholder="DD/MM/YYYY" />
      </div>
    </div>

    <!-- Tour -->
    <div id="panelTour" class="hidden">
      <div id="tourBlocks" class="space-y-8"></div>

      <button id="addTourBlock" class="mt-6 w-full bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg">
        + Add another venue/date
      </button>
    </div>
  </div>

  <template id="tourBlockTemplate">
    <div class="relative p-4 rounded-xl border border-gray-700 bg-[#0f172a]">
      <button type="button" class="x-circle tour-remove" title="Remove">×</button>

      <div class="mb-6 relative">
        <label class="block text-sm text-gray-300 mb-2">Venue</label>
        <div class="input-wrapper relative">
          <input type="text" placeholder="Search by venue name..."
                 class="venueSearch input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
          <button type="button"
                  class="clearVenue absolute right-3 top-3 text-gray-400 hover:text-gray-200"
                  aria-label="Clear">&times;</button>

          <div class="results-pop hidden">
            <div class="venueResults"></div>
            <div class="noVenueResults no-results hidden">
              No matches found.<br><span class="text-green-500 underline">+ Add new venue</span>
            </div>
          </div>
        </div>

        <input type="text" readonly placeholder="Venue ID will appear here"
               class="venueId input-dark p-3 rounded-lg border border-gray-700 text-green-400 mt-2">

        <div class="newVenueForm hidden mt-4 space-y-2">
          <input type="text" placeholder="Venue name" class="newVenueName input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input type="text" placeholder="Street address" class="newVenueStreet input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input type="text" placeholder="Postcode" class="newVenuePostcode input-dark p-3 rounded-lg border border-gray-700 w-full">
          <button class="createVenueBtn bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm text-gray-300 mb-2">From</label>
          <input type="text" readonly
                 class="fromDate input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"
                 placeholder="DD/MM/YYYY" />
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select class="fromTime input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"></select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 items-end mt-6">
        <div>
          <label class="block text-sm text-gray-300 mb-2">To</label>
          <input type="text" readonly
                 class="toDate input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"
                 placeholder="DD/MM/YYYY" />
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select class="toTime input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"></select>
        </div>
      </div>
    </div>
  </template>

  <script>
    const supabase = window.supabase.createClient(
      'https://jvuunvnbpdfrttusgelz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dWVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY'
    );

    const tabMain = document.getElementById('tabMain');
    const tabTour = document.getElementById('tabTour');
    const panelMain = document.getElementById('panelMain');
    const panelTour = document.getElementById('panelTour');

    function setTab(active) {
      if (active === 'main') {
        tabMain.classList.add('active'); tabTour.classList.remove('active');
        panelMain.classList.remove('hidden'); panelTour.classList.add('hidden');
      } else {
        tabTour.classList.add('active'); tabMain.classList.remove('active');
        panelTour.classList.remove('hidden'); panelMain.classList.add('hidden');
      }
    }
    tabMain.onclick = () => setTab('main');
    tabTour.onclick = () => setTab('tour');

    const venueSearch=document.getElementById('venueSearch');
    const venueId=document.getElementById('venueId');
    const resultsPop=document.getElementById('resultsPop');
    const venueResults=document.getElementById('venueResults');
    const noVenueResults=document.getElementById('noVenueResults');
    const newVenueForm=document.getElementById('newVenueForm');
    const clearBtn=document.getElementById('clearVenue');
    const createVenueBtn=document.getElementById('createVenueBtn');
    const newVenueName=document.getElementById('newVenueName');
    const newVenueStreet=document.getElementById('newVenueStreet');
    const newVenuePostcode=document.getElementById('newVenuePostcode');
    let searchTimeout;

    function openResults(){resultsPop.classList.remove('hidden');}
    function closeResults(){resultsPop.classList.add('hidden');}

    async function searchVenues(query){
      const clean=query.replace(/[^a-zA-Z0-9\s'-]/g,'').trim();
      if(!clean)return[];
      const{data,error}=await supabase.from('venues')
        .select('id,venue_name,street_name,postcode')
        .ilike('venue_name',`%${clean}%`).limit(25);
      if(error){console.error(error);return[];}
      const seen=new Set();
      const unique=data.filter(v=>{if(seen.has(v.id))return false;seen.add(v.id);return true;});
      const lower=clean.toLowerCase();
      const starts=unique.filter(v=>v.venue_name?.toLowerCase().startsWith(lower));
      const contains=unique.filter(v=>!v.venue_name?.toLowerCase().startsWith(lower));
      return[...starts,...contains].slice(0,5);
    }

    function renderVenues(items){
      venueResults.innerHTML='';
      noVenueResults.classList.add('hidden');
      if(!items.length){noVenueResults.classList.remove('hidden');return;}
      items.forEach(v=>{
        const div=document.createElement('div');
        div.className='venue-card';
        div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
                       <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
        div.onclick=()=>{
          venueSearch.value=v.venue_name;
          venueId.value=v.id;
          closeResults();
          newVenueForm.classList.add('hidden');
        };
        venueResults.appendChild(div);
      });
    }

    venueSearch.oninput=()=>{
      clearTimeout(searchTimeout);
      const q=venueSearch.value.trim();
      if(!q){venueResults.innerHTML='';closeResults();return;}
      searchTimeout=setTimeout(async()=>{
        const list=await searchVenues(q);
        renderVenues(list);
        openResults();
      },250);
    };
    venueSearch.onfocus=()=>{if(venueResults.children.length)openResults();};

    clearBtn.onclick=()=>{
      venueSearch.value='';
      venueId.value='';
      venueResults.innerHTML='';
      closeResults();
      newVenueForm.classList.add('hidden');
    };

    document.addEventListener('click',e=>{ if(!e.target.closest('.input-wrapper')) closeResults(); });
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeResults(); });

    noVenueResults.onclick=()=>{
      closeResults();
      newVenueForm.classList.remove('hidden');
    };

    createVenueBtn.onclick=async()=>{
      const name=newVenueName.value.trim();
      const street=newVenueStreet.value.trim();
      const postcode=newVenuePostcode.value.trim();
      if(!name)return;
      const{data,error}=await supabase.from('venues')
        .insert([{venue_name:name,street_name:street,postcode:postcode}])
        .select('id')
        .single();
      if(error){console.error(error);return;}
      venueId.value=data.id;
      venueSearch.value=name;
      newVenueForm.classList.add('hidden');
      newVenueName.value=''; newVenueStreet.value=''; newVenuePostcode.value='';
    };

    const formatUK=d=>`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    const parseUK=s=>{const[dd,mm,yyyy]=s.split('/').map(n=>parseInt(n,10));return new Date(yyyy,mm-1,dd);};
    const today=new Date();
    const fromDateEl=document.getElementById('fromDate');
    const toDateEl=document.getElementById('toDate');
    fromDateEl.value=formatUK(today);
    toDateEl.value=formatUK(today);
    const fromTimeEl=document.getElementById('fromTime');
    const toTimeEl=document.getElementById('toTime');

    function fillTimes(sel){
      sel.innerHTML='';
      for(let m=0;m<24*60;m+=15){
        const hh=Math.floor(m/60), mm=m%60;
        const d=new Date(2000,0,1,hh,mm);
        const label=d.toLocaleTimeString('en-GB',{hour:'numeric',minute:'2-digit'});
        const val=`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
        sel.add(new Option(label,val));
      }
    }
    fillTimes(fromTimeEl);fillTimes(toTimeEl);
    fromTimeEl.value='10:00';toTimeEl.value='11:00';

    const fromPicker=new Datepicker(fromDateEl,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    const toPicker=new Datepicker(toDateEl,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    fromDateEl.onclick=()=>fromPicker.show();toDateEl.onclick=()=>toPicker.show();

    fromDateEl.addEventListener('changeDate',()=>{
      const f=parseUK(fromDateEl.value);const t=parseUK(toDateEl.value);
      if(t<f){toDateEl.value=fromDateEl.value;toPicker.setDate(f);}
    });
    fromTimeEl.onchange=()=>{
      const[fh,fm]=fromTimeEl.value.split(':').map(Number);
      const[th,tm]=toTimeEl.value.split(':').map(Number);
      const fmins=fh*60+fm,tmins=th*60+tm;
      if(tmins<=fmins){
        const bump=fmins+60;
        const hh=String(Math.floor(bump/60)%24).padStart(2,'0');
        const mm=String(bump%60).padStart(2,'0');
        toTimeEl.value=`${hh}:${mm}`;
      }
    };

    const repeatSelect=document.getElementById('repeatRule');
    const repeatUntilWrap=document.getElementById('repeatUntilWrap');
    const repeatUntilInput=document.getElementById('repeatUntil');

    const repeatUntilPicker=new Datepicker(repeatUntilInput,{
      autohide:true,
      language:'en-GB',
      format:'dd/mm/yyyy',
      minDate: today,
      maxDate: new Date(today.getFullYear()+1, today.getMonth(), today.getDate())
    });
    repeatUntilInput.onclick=()=>repeatUntilPicker.show();

    repeatSelect.addEventListener('change',()=>{
      if(repeatSelect.value!=='none'){
        repeatUntilWrap.classList.remove('hidden');
      } else {
        repeatUntilWrap.classList.add('hidden');
        repeatUntilInput.value='';
      }
    });

    const tourBlocks = document.getElementById('tourBlocks');
    const addTourBlock = document.getElementById('addTourBlock');
    const tpl = document.getElementById('tourBlockTemplate');

    function initTourBlock(root){
      const vSearch = root.querySelector('.venueSearch');
      const vId = root.querySelector('.venueId');
      const results = root.querySelector('.results-pop');
      const vResults = root.querySelector('.venueResults');
      const noResults = root.querySelector('.noVenueResults');
      const newForm = root.querySelector('.newVenueForm');
      const clearBtn = root.querySelector('.clearVenue');
      const removeBtn = root.querySelector('.tour-remove');

      let timeout;

      function open(){results.classList.remove('hidden');}
      function close(){results.classList.add('hidden');}

      async function doSearch(q){
        const clean=q.replace(/[^a-zA-Z0-9\s'-]/g,'').trim();
        if(!clean)return[];
        const {data,error}=await supabase.from('venues')
          .select('id,venue_name,street_name,postcode')
          .ilike('venue_name',`%${clean}%`).limit(25);
        if(error){console.error(error);return[];}
        const seen=new Set(); const unique=data.filter(v=>{if(seen.has(v.id))return false;seen.add(v.id);return true;});
        const lower=clean.toLowerCase();
        const starts=unique.filter(v=>v.venue_name?.toLowerCase().startsWith(lower));
        const contain
