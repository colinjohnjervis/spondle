<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule Setup â€“ Spondle</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { background:#000; color:#fff; font-family:ui-sans-serif,system-ui,sans-serif; min-height:100vh; }
    .card { background:#0f172a; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.45); }
    .input-dark { background:#0b1220; color:#fff; width:100%; }
    .input-dark::placeholder { color:#9ca3af; }

    .results-pop { position:absolute; left:-6px; right:-6px; top:calc(100% + 6px);
      z-index:60; background:#0f172a; border-radius:12px; padding:10px; }
    .venue-card { background:#111827; border:1px solid #374151; border-radius:12px; padding:12px 14px; margin:8px 0; }
    .venue-card:hover { background:#1b2433; cursor:pointer; }
    .no-results { padding:12px 14px; background:#111827; border:1px solid #374151; border-radius:12px; text-align:center; color:#9ca3af; margin:8px 0; cursor:pointer; }
    .no-results:hover { background:#1b2433; }

    .pill { border-radius:9999px; padding:.5rem 1rem; font-weight:600; }
    .pill-on { background:#22c55e; color:#000; }
    .pill-off { background:#374151; color:#e5e7eb; }

    #debugBox { background:#111827; color:#9ca3af; font-size:.85rem; padding:.75rem; border-radius:8px; margin-top:1rem; border:1px solid #374151; }
  </style>
</head>

<body class="flex items-start justify-center py-10">
  <div class="card w-full max-w-xl p-6">
    <h1 class="text-3xl font-bold text-white mb-6">Schedule Setup</h1>

    <div class="flex space-x-2 mb-6">
      <button id="tabSingle" class="pill pill-on">Single / Recurring</button>
      <button id="tabTour" class="pill pill-off">Tour</button>
    </div>

    <!-- SINGLE / RECURRING -->
    <div id="panelSingle">
      <!-- Venue Search -->
      <div class="mb-6 relative">
        <label class="block text-sm text-gray-300 mb-2">Venue</label>
        <div class="input-wrapper relative">
          <input id="srVenueSearch" type="text" placeholder="Search by venue name..." class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
          <button id="srVenueClear" type="button" class="absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
          <div id="srResultsPop" class="results-pop hidden">
            <div id="srVenueResults"></div>
            <div id="srNoVenueResults" class="no-results hidden">No matches found.<br><span class="text-green-500 underline">+ Add new venue</span></div>
          </div>
        </div>
        <input id="srVenueId" type="text" readonly placeholder="Venue ID will appear here" class="input-dark p-3 rounded-lg border border-gray-700 text-green-400 mt-2">

        <!-- Inline new venue form -->
        <div id="srNewVenueForm" class="hidden mt-4 space-y-2">
          <input id="srNewName"   type="text" placeholder="Venue name"     class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input id="srNewStreet" type="text" placeholder="Street address" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input id="srNewPC"     type="text" placeholder="Postcode"       class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <button id="srCreateVenue" class="bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
        </div>
      </div>

      <!-- From / To -->
      <div class="grid grid-cols-2 gap-4 items-end mb-4">
        <div>
          <label class="block text-sm text-gray-300 mb-2">From</label>
          <input id="fromDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY">
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select id="fromTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 items-end mb-4">
        <div>
          <label class="block text-sm text-gray-300 mb-2">To</label>
          <input id="toDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY">
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select id="toTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
        </div>
      </div>

      <!-- Repeat -->
      <div class="mb-4">
        <label class="block text-sm text-gray-300 mb-2">Repeat</label>
        <select id="repeatType" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <option value="none">Does not repeat</option>
          <option value="everyday">Every day</option>
          <option value="everyweek">Every week</option>
          <option value="every2weeks">Every 2 weeks</option>
          <option value="everymonth">Every month</option>
          <option value="everyyear">Every year</option>
        </select>
      </div>

      <!-- Repeat until (only visible when repeating) -->
      <div id="repeatUntilWrap" class="hidden mb-2">
        <label class="block text-sm text-gray-300 mb-2">Repeat until</label>
        <input id="repeatUntil" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY">
      </div>

      <div id="repeatPreview" class="hidden bg-[#0b1220] border border-gray-700 rounded-lg p-3 text-sm mt-3"></div>
    </div>

    <!-- TOUR -->
    <div id="panelTour" class="hidden">
      <div id="tourRoot"></div>
      <button id="addTourBlockBtn" class="mt-6 bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-3 rounded-lg w-full">
        + Add another venue/date
      </button>
    </div>

    <!-- On-screen debug box (no DevTools needed) -->
    <div id="debugBox">Debug output will appear here...</div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ---------- Debug helper ---------- */
  const debug = (msg) => {
    const box = document.getElementById('debugBox');
    const line = document.createElement('div');
    line.textContent = msg;
    box.prepend(line);
  };

  /* ---------- Supabase ---------- */
  const supabase = window.supabase.createClient(
    "https://jvuunvnbpdfrttusgelz.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  );
  debug("âœ… Supabase initialised");

  /* ---------- Helpers ---------- */
  const formatUK = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
  const parseUK = s => { const [dd,mm,yyyy]=s.split('/').map(n=>parseInt(n,10)); return new Date(yyyy,mm-1,dd); };
  const today = new Date();
  function fillTimes(sel){ sel.innerHTML=''; for(let m=0;m<24*60;m+=15){ const hh=Math.floor(m/60),mm=m%60;
    const label=`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; sel.add(new Option(label,label)); }}

  /* ---------- Venue search ---------- */
  async function searchVenues(q){
    const clean=q.replace(/[^a-zA-Z0-9\s'-]/g,'').trim();
    if(!clean){ return []; }
    debug(`ðŸ” Search: "${clean}"`);
    const {data,error}=await supabase
      .from('venues')
      .select('id, venue_name, street_name, postcode')
      .ilike('venue_name', `%${clean}%`)
      .limit(25);
    if(error){ debug(`âŒ Supabase error: ${error.message}`); return []; }
    debug(`âœ… Results: ${data.length}`);
    return data || [];
  }

  /* ---------- Tabs ---------- */
  const tabSingle=document.getElementById('tabSingle');
  const tabTour=document.getElementById('tabTour');
  const panelSingle=document.getElementById('panelSingle');
  const panelTour=document.getElementById('panelTour');

  function setTab(which){
    if(which==='single'){
      tabSingle.classList.add('pill-on'); tabSingle.classList.remove('pill-off');
      tabTour.classList.add('pill-off'); tabTour.classList.remove('pill-on');
      panelSingle.classList.remove('hidden'); panelTour.classList.add('hidden');
    }else{
      tabTour.classList.add('pill-on'); tabTour.classList.remove('pill-off');
      tabSingle.classList.add('pill-off'); tabSingle.classList.remove('pill-on');
      panelTour.classList.remove('hidden'); panelSingle.classList.add('hidden');
      if(!panelTour.dataset.init){ addTourBlock(); panelTour.dataset.init='1'; }
    }
  }
  tabSingle.onclick=()=>setTab('single');
  tabTour.onclick=()=>setTab('tour');

  /* ---------- Single/Recurring initialisation ---------- */
  (function initSingleRecurring(){
    // Venue
    const vSearch=document.getElementById('srVenueSearch');
    const vClear =document.getElementById('srVenueClear');
    const vPop  =document.getElementById('srResultsPop');
    const vList =document.getElementById('srVenueResults');
    const vNone =document.getElementById('srNoVenueResults');
    const vForm =document.getElementById('srNewVenueForm');
    const vId   =document.getElementById('srVenueId');
    const nName =document.getElementById('srNewName');
    const nStreet=document.getElementById('srNewStreet');
    const nPost =document.getElementById('srNewPC');
    const nCreate=document.getElementById('srCreateVenue');

    function openPop(){ vPop.classList.remove('hidden'); }
    function closePop(){ vPop.classList.add('hidden'); }

    let tmr;
    function render(list){
      vList.innerHTML=''; vNone.classList.add('hidden');
      if(!list.length){ vNone.classList.remove('hidden'); return; }
      list.forEach(v=>{
        const div=document.createElement('div');
        div.className='venue-card';
        div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
                       <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
        div.onclick=()=>{ vSearch.value=v.venue_name; vId.value=v.id; closePop(); vForm.classList.add('hidden'); };
        vList.appendChild(div);
      });
    }

    vSearch.oninput=()=>{
      clearTimeout(tmr);
      const q=vSearch.value.trim();
      if(!q){ vList.innerHTML=''; closePop(); return; }
      tmr=setTimeout(async()=>{ render(await searchVenues(q)); openPop(); }, 200);
    };
    vSearch.onfocus=()=>{ if(vList.children.length || !vForm.classList.contains('hidden')) openPop(); };
    vClear.onclick=()=>{ vSearch.value=''; vId.value=''; vList.innerHTML=''; closePop(); vForm.classList.add('hidden'); };
    vNone.onclick=()=>{ closePop(); vForm.classList.remove('hidden'); };

    nCreate.onclick=async()=>{
      const name=nName.value.trim(), street=nStreet.value.trim(), pc=nPost.value.trim();
      if(!name){ debug('â„¹ï¸ Enter a venue name'); return; }
      const {data,error}=await supabase.from('venues')
        .insert([{venue_name:name,street_name:street,postcode:pc}]).select('id').single();
      if(error){ debug(`âŒ Create venue error: ${error.message}`); return; }
      vId.value=data.id; vSearch.value=name; vForm.classList.add('hidden');
      nName.value=''; nStreet.value=''; nPost.value='';
      debug(`âœ… Venue created: ${data.id}`);
    };

    // Dates & times
    const fromDateEl=document.getElementById('fromDate');
    const toDateEl  =document.getElementById('toDate');
    const fromTimeEl=document.getElementById('fromTime');
    const toTimeEl  =document.getElementById('toTime');

    fillTimes(fromTimeEl); fillTimes(toTimeEl);
    fromTimeEl.value='10:00'; toTimeEl.value='11:00';

    fromDateEl.value=formatUK(today);
    toDateEl.value=formatUK(today);

    const fromDP=new Datepicker(fromDateEl,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    const toDP  =new Datepicker(toDateEl,  {autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    fromDateEl.onclick=()=>fromDP.show();
    toDateEl.onclick=()=>toDP.show();

    fromDateEl.addEventListener('changeDate',()=>{
      const f=parseUK(fromDateEl.value), t=parseUK(toDateEl.value);
      if(t<f){ toDateEl.value=fromDateEl.value; toDP.setDate(f); }
    });

    fromTimeEl.onchange=()=>{
      const [fh,fm]=fromTimeEl.value.split(':').map(Number);
      const [th,tm]=toTimeEl.value.split(':').map(Number);
      const f=fh*60+fm, t=th*60+tm;
      if(t<=f){
        const bump=f+60;
        toTimeEl.value=`${String(Math.floor(bump/60)%24).padStart(2,'0')}:${String(bump%60).padStart(2,'0')}`;
      }
    };

    // Repeat
    const repeatTypeEl=document.getElementById('repeatType');
    const repeatUntilWrap=document.getElementById('repeatUntilWrap');
    const repeatUntilEl=document.getElementById('repeatUntil');
    const repeatPreview=document.getElementById('repeatPreview');
    const untilDP=new Datepicker(repeatUntilEl,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    repeatUntilEl.onclick=()=>untilDP.show();

    function updateRepeatUI(){
      const repeating = repeatTypeEl.value!=='none';
      repeatUntilWrap.classList.toggle('hidden', !repeating);
      if(repeating && !repeatUntilEl.value) repeatUntilEl.value = formatUK(parseUK(fromDateEl.value));
      updatePreview();
    }
    repeatTypeEl.addEventListener('change', updateRepeatUI);

    function generateOccurrences(){
      const start=parseUK(fromDateEl.value);
      const end = repeatTypeEl.value==='none' ? parseUK(toDateEl.value) : parseUK(repeatUntilEl.value || fromDateEl.value);
      if(isNaN(start)||isNaN(end) || end<start) return [];

      const list=[];
      const stepDays=(d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };

      switch(repeatTypeEl.value){
        case 'none': list.push(start); break;
        case 'everyday':
          for(let d=new Date(start); d<=end && list.length<100; d=stepDays(d,1)) list.push(new Date(d)); break;
        case 'everyweek':
          for(let d=new Date(start); d<=end && list.length<100; d=stepDays(d,7)) list.push(new Date(d)); break;
        case 'every2weeks':
          for(let d=new Date(start); d<=end && list.length<100; d=stepDays(d,14)) list.push(new Date(d)); break;
        case 'everymonth':
          for(let d=new Date(start); d<=end && list.length<100; d.setMonth(d.getMonth()+1)) list.push(new Date(d)); break;
        case 'everyyear':
          for(let d=new Date(start); d<=end && list.length<100; d.setFullYear(d.getFullYear()+1)) list.push(new Date(d)); break;
      }
      return list;
    }

    function updatePreview(){
      const occ=generateOccurrences();
      if(!occ.length){ repeatPreview.classList.add('hidden'); repeatPreview.innerHTML=''; return; }
      repeatPreview.innerHTML = occ.map(d=>`<div>${formatUK(d)}</div>`).join('');
      repeatPreview.classList.remove('hidden');
    }

    repeatUntilEl.addEventListener('changeDate', updatePreview);
    fromDateEl.addEventListener('changeDate', updatePreview);

    updateRepeatUI(); // initialise
  })();

  /* ---------- TOUR (preserved working version) ---------- */
  const tourRoot=document.getElementById('tourRoot');
  const addTourBtn=document.getElementById('addTourBlockBtn');

  function addTourBlock(){
    if(tourRoot.children.length){
      const sep=document.createElement('div');
      sep.className='h-px bg-slate-700 my-6';
      tourRoot.appendChild(sep);
    }

    const root=document.createElement('div');
    root.innerHTML=`
      <div class="mb-6 relative">
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm text-gray-300">Venue</label>
          <button type="button" class="tour-inline-remove removeBtn" title="Remove">Ã—</button>
        </div>
        <div class="input-wrapper relative">
          <input type="text" placeholder="Search by venue name..." class="venueSearch input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
          <button type="button" class="clearVenue absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
          <div class="results-pop hidden">
            <div class="venueResults"></div>
            <div class="noVenueResults no-results hidden">No matches found.<br><span class="text-green-500 underline">+ Add new venue</span></div>
          </div>
        </div>
        <input type="text" readonly placeholder="Venue ID will appear here" class="venueId input-dark p-3 rounded-lg border border-gray-700 text-green-400 mt-2">
        <div class="newVenueForm hidden mt-4 space-y-2">
          <input type="text" placeholder="Venue name" class="newVenueName input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input type="text" placeholder="Street address" class="newVenueStreet input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input type="text" placeholder="Postcode" class="newVenuePostcode input-dark p-3 rounded-lg border border-gray-700 w-full">
          <button class="createVenueBtn bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm text-gray-300 mb-2">From</label>
          <input type="text" readonly class="fromDate input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select class="fromTime input-dark p-3 rounded-lg border border-gray-700"></select>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 items-end mt-6">
        <div>
          <label class="block text-sm text-gray-300 mb-2">To</label>
          <input type="text" readonly class="toDate input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Time</label>
          <select class="toTime input-dark p-3 rounded-lg border border-gray-700"></select>
        </div>
      </div>
    `;
    tourRoot.appendChild(root);
    initTourBlock(root);
  }

  addTourBtn.onclick=()=>addTourBlock();

  function initTourBlock(scope){
    const vSearch=scope.querySelector('.venueSearch');
    const vId=scope.querySelector('.venueId');
    const results=scope.querySelector('.results-pop');
    const vResults=scope.querySelector('.venueResults');
    const noResults=scope.querySelector('.noVenueResults');
    const newForm=scope.querySelector('.newVenueForm');
    const clearBtn=scope.querySelector('.clearVenue');
    const removeBtn=scope.querySelector('.removeBtn');
    const nName=scope.querySelector('.newVenueName');
    const nStreet=scope.querySelector('.newVenueStreet');
    const nPost=scope.querySelector('.newVenuePostcode');
    const createBtn=scope.querySelector('.createVenueBtn');
    const fromDate=scope.querySelector('.fromDate');
    const toDate=scope.querySelector('.toDate');
    const fromTime=scope.querySelector('.fromTime');
    const toTime=scope.querySelector('.toTime');
    let timeout;

    function open(){results.classList.remove('hidden');}
    function close(){results.classList.add('hidden');}

    function render(list){
      vResults.innerHTML=''; noResults.classList.add('hidden');
      if(!list.length){ noResults.classList.remove('hidden'); return; }
      list.forEach(v=>{
        const div=document.createElement('div');
        div.className='venue-card';
        div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
          <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
        div.onclick=()=>{ vSearch.value=v.venue_name; vId.value=v.id; close(); newForm.classList.add('hidden'); };
        vResults.appendChild(div);
      });
    }

    vSearch.oninput=()=>{
      clearTimeout(timeout);
      const q=vSearch.value.trim();
      if(!q){ vResults.innerHTML=''; close(); return; }
      timeout=setTimeout(async()=>{ const list=await searchVenues(q); render(list); open(); },250);
    };
    vSearch.onfocus=()=>{ if(vResults.children.length) open(); };
    clearBtn.onclick=()=>{ vSearch.value=''; vId.value=''; vResults.innerHTML=''; close(); newForm.classList.add('hidden'); };
    scope.addEventListener('click', e=>{ if(!e.target.closest('.input-wrapper')) close(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
    noResults.onclick=()=>{ close(); newForm.classList.remove('hidden'); };

    createBtn.onclick=async()=>{
      const name=nName.value.trim(), street=nStreet.value.trim(), pc=nPost.value.trim();
      if(!name) return;
      const {data,error}=await supabase.from('venues')
        .insert([{venue_name:name,street_name:street,postcode:pc}]).select('id').single();
      if(error){ debug(`âŒ Create venue (tour) error: ${error.message}`); return; }
      vId.value=data.id; vSearch.value=name; newForm.classList.add('hidden');
      nName.value=''; nStreet.value=''; nPost.value='';
      debug(`âœ… Venue created (tour): ${data.id}`);
    };

    fromDate.value=formatUK(today); toDate.value=formatUK(today);
    fillTimes(fromTime); fillTimes(toTime); fromTime.value='10:00'; toTime.value='11:00';
    const fp=new Datepicker(fromDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    const tp=new Datepicker(toDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
    fromDate.onclick=()=>fp.show(); toDate.onclick=()=>tp.show();
    fromDate.addEventListener('changeDate',()=>{const f=parseUK(fromDate.value);const t=parseUK(toDate.value);if(t<f){toDate.value=fromDate.value;tp.setDate(f);}});
    fromTime.onchange=()=>{const[fh,fm]=fromTime.value.split(':').map(Number);const[th,tm]=toTime.value.split(':').map(Number);
      const fmins=fh*60+fm,tmins=th*60+tm;if(tmins<=fmins){const bump=fmins+60;
        const hh=String(Math.floor(bump/60)%24).padStart(2,'0');const mm=String(bump%60).padStart(2,'0');toTime.value=`${hh}:${mm}`;}};

    removeBtn.onclick=()=>{const prev=scope.previousElementSibling;if(prev&&prev.classList.contains('h-px'))prev.remove();scope.remove();};
  }

  /* ---------- Default tab ---------- */
  setTab('single');
});
</script>
</body>
</html>
