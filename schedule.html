<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule Setup – Spondle</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite-datepicker/1.3.3/datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { background:#000; color:#fff; font-family:ui-sans-serif,system-ui,sans-serif; min-height:100vh; }
    .card { background:#0f172a; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.45); }
    .input-dark { background:#0b1220; color:#fff; width:100%; }
    .input-dark::placeholder { color:#9ca3af; }

    .datepicker[role="dialog"] {
      position: fixed !important;
      top: 50% !important; left: 50% !important;
      transform: translate(-50%, -50%) !important;
      z-index: 9999 !important; width: 92%; max-width: 420px;
      background: #fff !important; color: #111 !important;
      border-radius: 16px !important; box-shadow: 0 20px 60px rgba(0,0,0,.35) !important;
    }
    .datepicker .days .datepicker-cell {
      width: 44px !important; height: 44px !important;
      line-height: 44px !important; border-radius: 50% !important;
      margin: 4px !important; text-align: center !important;
    }
    .datepicker-cell.selected { background:#22c55e !important; color:#fff !important; }

    .results-pop { position:absolute; left:-6px; right:-6px; top:calc(100% + 6px);
      z-index:60; background:#0f172a; border-radius:12px; padding:10px; }
    .venue-card { background:#111827; border:1px solid #374151; border-radius:12px;
      padding:12px 14px; width:100%; box-sizing:border-box; margin:8px 0; }
    .venue-card:hover { background:#1b2433; cursor:pointer; }
    .no-results { padding:12px 14px; background:#111827; border:1px solid #374151;
      border-radius:12px; text-align:center; font-size:0.95rem; color:#9ca3af; margin:8px 0; cursor:pointer; }
    .no-results:hover { background:#1b2433; }

    .tour-inline-remove {
      font-size:18px; line-height:1; width:28px; height:28px;
      border-radius:9999px; display:flex; align-items:center; justify-content:center;
      background:#0b1220; border:1px solid #374151; color:#cbd5e1;
    }
    .tour-inline-remove:hover { color:#fff; border-color:#4b5563; }

    .pill { border-radius:9999px; padding:.5rem 1rem; font-weight:600; }
    .pill-on { background:#22c55e; color:#000; }
    .pill-off { background:#374151; color:#e5e7eb; }

    .weekday { border:1px solid #4b5563; border-radius:10px; padding:.4rem .6rem; font-weight:600; }
    .weekday.selected { background:#22c55e; color:#000; border-color:#22c55e; }
  </style>
</head>

<body class="flex items-start justify-center py-10">
  <div class="card w-full max-w-xl p-6">
    <h1 class="text-3xl font-bold text-white mb-6">Schedule Setup</h1>

    <div class="flex space-x-2 mb-6">
      <button id="tabSingle" class="pill pill-on">Single / Recurring</button>
      <button id="tabTour"   class="pill pill-off">Tour</button>
    </div>

    <!-- Single/Recurring Panel -->
    <div id="panelSingle">
      <!-- Venue search + create (shared look/feel with Tour) -->
      <div class="mb-6 relative">
        <label class="block text-sm text-gray-300 mb-2">Venue</label>
        <div class="input-wrapper relative">
          <input id="srVenueSearch" type="text" placeholder="Search by venue name..." class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
          <button id="srVenueClear" type="button" class="absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
          <div id="srResultsPop" class="results-pop hidden">
            <div id="srVenueResults"></div>
            <div id="srNoVenueResults" class="no-results hidden">No matches found.<br><span class="text-green-500 underline">+ Add new venue</span></div>
          </div>
        </div>
        <input id="srVenueId" type="text" readonly placeholder="Venue ID will appear here" class="input-dark p-3 rounded-lg border border-gray-700 text-green-400 mt-2">

        <!-- Inline new venue form -->
        <div id="srNewVenueForm" class="hidden mt-4 space-y-2">
          <input id="srNewName"   type="text" placeholder="Venue name"     class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input id="srNewStreet" type="text" placeholder="Street address" class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <input id="srNewPC"     type="text" placeholder="Postcode"       class="input-dark p-3 rounded-lg border border-gray-700 w-full">
          <button id="srCreateVenue" class="bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
        </div>
      </div>

      <!-- Single / Recurring toggle -->
      <div class="mb-4">
        <div class="inline-flex bg-[#0b1220] rounded-xl border border-gray-700 overflow-hidden">
          <button id="modeSingleBtn"   class="px-4 py-2 font-semibold pill-on">Single</button>
          <button id="modeRecurringBtn" class="px-4 py-2 font-semibold pill-off">Recurring</button>
        </div>
      </div>

      <!-- SINGLE MODE -->
      <div id="singleBlock">
        <div class="grid grid-cols-2 gap-4 items-end">
          <div>
            <label class="block text-sm text-gray-300 mb-2">Date</label>
            <input id="singleDate" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500" placeholder="DD/MM/YYYY" />
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-2">Time</label>
            <select id="singleTime" class="input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"></select>
          </div>
        </div>
      </div>

      <!-- RECURRING MODE -->
      <div id="recurringBlock" class="hidden">
        <div class="grid grid-cols-2 gap-4 items-end">
          <div>
            <label class="block text-sm text-gray-300 mb-2">Start date</label>
            <input id="recStart" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-2">End date</label>
            <input id="recEnd" type="text" readonly class="input-dark p-3 rounded-lg border border-gray-700" placeholder="DD/MM/YYYY" />
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-sm text-gray-300 mb-2">Time</label>
            <select id="recTime" class="input-dark p-3 rounded-lg border border-gray-700"></select>
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-2">Frequency</label>
            <select id="recFreq" class="input-dark p-3 rounded-lg border border-gray-700">
              <option value="daily">Daily</option>
              <option value="weekly" selected>Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
        </div>

        <!-- Weekly day picker -->
        <div id="weeklyRow" class="mt-4">
          <label class="block text-sm text-gray-300 mb-2">Repeat on</label>
          <div class="flex flex-wrap gap-2">
            <button type="button" class="weekday" data-dow="1">Mon</button>
            <button type="button" class="weekday" data-dow="2">Tue</button>
            <button type="button" class="weekday" data-dow="3">Wed</button>
            <button type="button" class="weekday" data-dow="4">Thu</button>
            <button type="button" class="weekday" data-dow="5">Fri</button>
            <button type="button" class="weekday" data-dow="6">Sat</button>
            <button type="button" class="weekday" data-dow="0">Sun</button>
          </div>
          <p class="text-xs text-gray-400 mt-2">Tip: select one or more days.</p>
        </div>

        <button id="recGenerate" class="mt-6 bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-3 rounded-lg w-full">Generate dates</button>

        <div id="recPreviewWrap" class="hidden mt-4">
          <div class="text-sm text-gray-300 mb-2">Generated dates (<span id="recCount">0</span>):</div>
          <div id="recPreview" class="bg-[#0b1220] border border-gray-700 rounded-lg p-3 text-sm max-h-48 overflow-auto"></div>
        </div>
      </div>
    </div>

    <!-- Tour Panel -->
    <div id="panelTour" class="hidden">
      <div id="tourRoot"></div>
      <button id="addTourBlockBtn"
        class="mt-6 bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-3 rounded-lg w-full">
        + Add another venue/date
      </button>
    </div>
  </div>

  <script>
/* ---------- Supabase client ---------- */
const supabase = window.supabase.createClient(
  "https://jvuunvnbpdfrttusgelz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);

/* ---------- Helpers ---------- */
const formatUK = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
const parseUK = s => { const [dd,mm,yyyy]=s.split('/').map(n=>parseInt(n,10)); return new Date(yyyy,mm-1,dd); };
const today = new Date();
function fillTimes(sel){ sel.innerHTML=''; for(let m=0;m<24*60;m+=15){ const hh=Math.floor(m/60), mm=m%60;
  const label=`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; sel.add(new Option(label,label)); }}

/* ---------- Venue search (shared) ---------- */
async function searchVenues(q){
  const clean=q.replace(/[^a-zA-Z0-9\s'-]/g,'').trim();
  if(!clean) return [];
  const {data,error}=await supabase.from('venues')
    .select('id,venue_name,street_name,postcode')
    .ilike('venue_name', `%${clean}%`).limit(25);
  if(error){ console.error(error); return []; }
  const seen=new Set();
  const unique=data.filter(v=>{ if(seen.has(v.id))return false; seen.add(v.id); return true;});
  const lower=clean.toLowerCase();
  const starts=unique.filter(v=>v.venue_name?.toLowerCase().startsWith(lower));
  const contains=unique.filter(v=>!v.venue_name?.toLowerCase().startsWith(lower));
  return [...starts,...contains].slice(0,5);
}

/* ---------- Tabs ---------- */
const tabSingle=document.getElementById('tabSingle');
const tabTour=document.getElementById('tabTour');
const panelSingle=document.getElementById('panelSingle');
const panelTour=document.getElementById('panelTour');

tabSingle.onclick=()=>setTab('single');
tabTour.onclick=()=>setTab('tour');

function setTab(which){
  const on = (btn) => btn.classList.add('pill-on'), off = (btn)=>btn.classList.remove('pill-on');
  const off2= (btn)=>btn.classList.add('pill-off'), on2=(btn)=>btn.classList.remove('pill-off');
  if(which==='single'){
    on(tabSingle); on2(tabSingle);
    off(tabTour); off2(tabTour);
    panelSingle.classList.remove('hidden');
    panelTour.classList.add('hidden');
  }else{
    on(tabTour); on2(tabTour);
    off(tabSingle); off2(tabSingle);
    panelTour.classList.remove('hidden');
    panelSingle.classList.add('hidden');
    if(!panelTour.dataset.init){ addTourBlock(); panelTour.dataset.init='1'; }
  }
}

/* ---------- Single/Recurring wiring ---------- */
const srEls = {
  search:  document.getElementById('srVenueSearch'),
  clear:   document.getElementById('srVenueClear'),
  pop:     document.getElementById('srResultsPop'),
  list:    document.getElementById('srVenueResults'),
  none:    document.getElementById('srNoVenueResults'),
  form:    document.getElementById('srNewVenueForm'),
  id:      document.getElementById('srVenueId'),
  nvName:  document.getElementById('srNewName'),
  nvStreet:document.getElementById('srNewStreet'),
  nvPC:    document.getElementById('srNewPC'),
  create:  document.getElementById('srCreateVenue'),
};

(function initSingleRecurring(){
  // venue search/create
  let timeout;
  const open = ()=>srEls.pop.classList.remove('hidden');
  const close= ()=>srEls.pop.classList.add('hidden');
  function render(list){
    srEls.list.innerHTML=''; srEls.none.classList.add('hidden');
    if(!list.length){ srEls.none.classList.remove('hidden'); return; }
    list.forEach(v=>{
      const div=document.createElement('div');
      div.className='venue-card';
      div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
        <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
      div.onclick=()=>{ srEls.search.value=v.venue_name; srEls.id.value=v.id; close(); srEls.form.classList.add('hidden'); };
      srEls.list.appendChild(div);
    });
  }
  srEls.search.oninput=()=>{
    clearTimeout(timeout);
    const q=srEls.search.value.trim();
    if(!q){ srEls.list.innerHTML=''; close(); return; }
    timeout=setTimeout(async()=>{ const list=await searchVenues(q); render(list); open(); },250);
  };
  srEls.search.onfocus=()=>{ if(srEls.list.children.length) open(); };
  srEls.clear.onclick=()=>{ srEls.search.value=''; srEls.id.value=''; srEls.list.innerHTML=''; close(); srEls.form.classList.add('hidden'); };
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
  srEls.none.onclick=()=>{ close(); srEls.form.classList.remove('hidden'); };
  srEls.create.onclick=async()=>{
    const name=srEls.nvName.value.trim(), street=srEls.nvStreet.value.trim(), pc=srEls.nvPC.value.trim();
    if(!name) return;
    const {data,error}=await supabase.from('venues')
      .insert([{venue_name:name,street_name:street,postcode:pc}]).select('id').single();
    if(error){ console.error(error); return; }
    srEls.id.value=data.id; srEls.search.value=name; srEls.form.classList.add('hidden');
    srEls.nvName.value=''; srEls.nvStreet.value=''; srEls.nvPC.value='';
  };

  // mode toggle
  const singleBlock = document.getElementById('singleBlock');
  const recurringBlock = document.getElementById('recurringBlock');
  const btnSingle = document.getElementById('modeSingleBtn');
  const btnRec   = document.getElementById('modeRecurringBtn');

  btnSingle.onclick=()=>{ singleBlock.classList.remove('hidden'); recurringBlock.classList.add('hidden'); btnSingle.classList.add('pill-on'); btnRec.classList.remove('pill-on'); };
  btnRec.onclick   =()=>{ singleBlock.classList.add('hidden');   recurringBlock.classList.remove('hidden'); btnRec.classList.add('pill-on');    btnSingle.classList.remove('pill-on'); };

  // SINGLE date/time
  const singleDate = document.getElementById('singleDate');
  const singleTime = document.getElementById('singleTime');
  fillTimes(singleTime); singleTime.value='19:30';
  singleDate.value = formatUK(today);
  const sdp=new Datepicker(singleDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
  singleDate.onclick=()=>sdp.show();

  // RECURRING controls
  const recStart=document.getElementById('recStart');
  const recEnd  =document.getElementById('recEnd');
  const recTime =document.getElementById('recTime');
  const recFreq =document.getElementById('recFreq');
  const weeklyRow=document.getElementById('weeklyRow');
  const recGenerate=document.getElementById('recGenerate');
  const recPreviewWrap=document.getElementById('recPreviewWrap');
  const recPreview=document.getElementById('recPreview');
  const recCount=document.getElementById('recCount');

  fillTimes(recTime); recTime.value='19:30';
  recStart.value=formatUK(today);
  recEnd.value=formatUK(today);
  const rsdp=new Datepicker(recStart,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
  const redp=new Datepicker(recEnd,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
  recStart.onclick=()=>rsdp.show();
  recEnd.onclick=()=>redp.show();

  recFreq.onchange=()=>{ weeklyRow.style.display = recFreq.value==='weekly' ? '' : 'none'; };
  recFreq.dispatchEvent(new Event('change'));

  // weekday chips
  const wdBtns=[...weeklyRow.querySelectorAll('.weekday')];
  wdBtns.forEach(b=>b.addEventListener('click',()=>b.classList.toggle('selected')));

  // Generate dates (Option A behaviour - materialise instances)
  recGenerate.onclick=()=>{
    const start=parseUK(recStart.value), end=parseUK(recEnd.value);
    if(isNaN(start)||isNaN(end) || end<start){ alert('Please pick a valid start and end date.'); return; }

    // build a set of occurrences
    const occurrences=[];
    const [hh,mm] = recTime.value.split(':').map(Number);

    const pushWithTime = (d)=>{
      const dt=new Date(d.getFullYear(), d.getMonth(), d.getDate(), hh, mm, 0, 0);
      occurrences.push(dt);
    };

    if(recFreq.value==='daily'){
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) pushWithTime(d);
    }else if(recFreq.value==='weekly'){
      const selectedDOW = wdBtns.filter(b=>b.classList.contains('selected')).map(b=>parseInt(b.dataset.dow,10));
      if(!selectedDOW.length){ alert('Please select one or more weekdays.'); return; }
      for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){
        if(selectedDOW.includes(d.getDay())) pushWithTime(d);
      }
    }else{ // monthly (same day-of-month between range)
      const dom=start.getDate();
      for(let d=new Date(start); d<=end; d.setMonth(d.getMonth()+1)){
        const candidate=new Date(d.getFullYear(), d.getMonth(), dom);
        if(candidate>=start && candidate<=end) pushWithTime(candidate);
      }
    }

    // preview
    recPreview.innerHTML = occurrences.map(dt=>`<div>${formatUK(dt)} @ ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}</div>`).join('');
    recCount.textContent = occurrences.length;
    recPreviewWrap.classList.remove('hidden');

    // store for later submit if/when needed
    window.__SR_OCCURRENCES__ = occurrences;
  };
})();

/* ---------- TOUR (kept as your working version) ---------- */
const panelTour=document.getElementById('panelTour');
const tourRoot=document.getElementById('tourRoot');
const addTourBtn=document.getElementById('addTourBlockBtn');

function addTourBlock(){
  if(tourRoot.children.length){
    const sep=document.createElement('div');
    sep.className='h-px bg-slate-700 my-6';
    tourRoot.appendChild(sep);
  }

  const root=document.createElement('div');
  root.innerHTML=`
    <div class="mb-6 relative">
      <div class="flex items-center justify-between mb-2">
        <label class="block text-sm text-gray-300">Venue</label>
        <button type="button" class="tour-inline-remove removeBtn" title="Remove">×</button>
      </div>
      <div class="input-wrapper relative">
        <input type="text" placeholder="Search by venue name..." class="venueSearch input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500">
        <button type="button" class="clearVenue absolute right-3 top-3 text-gray-400 hover:text-gray-200">&times;</button>
        <div class="results-pop hidden">
          <div class="venueResults"></div>
          <div class="noVenueResults no-results hidden">No matches found.<br><span class="text-green-500 underline">+ Add new venue</span></div>
        </div>
      </div>
      <input type="text" readonly placeholder="Venue ID will appear here" class="venueId input-dark p-3 rounded-lg border border-gray-700 text-green-400 mt-2">
      <div class="newVenueForm hidden mt-4 space-y-2">
        <input type="text" placeholder="Venue name" class="newVenueName input-dark p-3 rounded-lg border border-gray-700 w-full">
        <input type="text" placeholder="Street address" class="newVenueStreet input-dark p-3 rounded-lg border border-gray-700 w-full">
        <input type="text" placeholder="Postcode" class="newVenuePostcode input-dark p-3 rounded-lg border border-gray-700 w-full">
        <button class="createVenueBtn bg-green-500 hover:bg-green-400 text-black font-semibold px-4 py-2 rounded-lg w-full">Create Venue</button>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4 items-end">
      <div>
        <label class="block text-sm text-gray-300 mb-2">From</label>
        <input type="text" readonly class="fromDate input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500" placeholder="DD/MM/YYYY" />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-2">Time</label>
        <select class="fromTime input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"></select>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4 items-end mt-6">
      <div>
        <label class="block text-sm text-gray-300 mb-2">To</label>
        <input type="text" readonly class="toDate input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500" placeholder="DD/MM/YYYY" />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-2">Time</label>
        <select class="toTime input-dark p-3 rounded-lg border border-gray-700 focus:border-green-500 focus:ring-green-500"></select>
      </div>
    </div>
  `;
  tourRoot.appendChild(root);
  initTourBlock(root);
}

addTourBtn.onclick=()=>addTourBlock();

function initTourBlock(scope){
  const vSearch=scope.querySelector('.venueSearch');
  const vId=scope.querySelector('.venueId');
  const results=scope.querySelector('.results-pop');
  const vResults=scope.querySelector('.venueResults');
  const noResults=scope.querySelector('.noVenueResults');
  const newForm=scope.querySelector('.newVenueForm');
  const clearBtn=scope.querySelector('.clearVenue');
  const removeBtn=scope.querySelector('.removeBtn');
  const nName=scope.querySelector('.newVenueName');
  const nStreet=scope.querySelector('.newVenueStreet');
  const nPost=scope.querySelector('.newVenuePostcode');
  const createBtn=scope.querySelector('.createVenueBtn');
  const fromDate=scope.querySelector('.fromDate');
  const toDate=scope.querySelector('.toDate');
  const fromTime=scope.querySelector('.fromTime');
  const toTime=scope.querySelector('.toTime');
  let timeout;

  function open(){results.classList.remove('hidden');}
  function close(){results.classList.add('hidden');}

  function render(list){
    vResults.innerHTML=''; noResults.classList.add('hidden');
    if(!list.length){ noResults.classList.remove('hidden'); return; }
    list.forEach(v=>{
      const div=document.createElement('div');
      div.className='venue-card';
      div.innerHTML=`<div class="font-semibold">${v.venue_name}</div>
        <div class="text-gray-300">${[v.street_name,v.postcode].filter(Boolean).join(', ')}</div>`;
      div.onclick=()=>{ vSearch.value=v.venue_name; vId.value=v.id; close(); newForm.classList.add('hidden'); };
      vResults.appendChild(div);
    });
  }

  vSearch.oninput=()=>{
    clearTimeout(timeout);
    const q=vSearch.value.trim();
    if(!q){ vResults.innerHTML=''; close(); return; }
    timeout=setTimeout(async()=>{ const list=await searchVenues(q); render(list); open(); },250);
  };
  vSearch.onfocus=()=>{ if(vResults.children.length) open(); };
  clearBtn.onclick=()=>{ vSearch.value=''; vId.value=''; vResults.innerHTML=''; close(); newForm.classList.add('hidden'); };
  scope.addEventListener('click', e=>{ if(!e.target.closest('.input-wrapper')) close(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
  noResults.onclick=()=>{ close(); newForm.classList.remove('hidden'); };

  createBtn.onclick=async()=>{
    const name=nName.value.trim(), street=nStreet.value.trim(), pc=nPost.value.trim();
    if(!name) return;
    const {data,error}=await supabase.from('venues')
      .insert([{venue_name:name,street_name:street,postcode:pc}]).select('id').single();
    if(error){ console.error(error); return; }
    vId.value=data.id; vSearch.value=name; newForm.classList.add('hidden');
    nName.value=''; nStreet.value=''; nPost.value='';
  };

  fromDate.value=formatUK(today); toDate.value=formatUK(today);
  fillTimes(fromTime); fillTimes(toTime); fromTime.value='10:00'; toTime.value='11:00';
  const fp=new Datepicker(fromDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
  const tp=new Datepicker(toDate,{autohide:true,defaultDate:today,language:'en-GB',format:'dd/mm/yyyy'});
  fromDate.onclick=()=>fp.show(); toDate.onclick=()=>tp.show();
  fromDate.addEventListener('changeDate',()=>{const f=parseUK(fromDate.value);const t=parseUK(toDate.value);if(t<f){toDate.value=fromDate.value;tp.setDate(f);}});
  fromTime.onchange=()=>{const[fh,fm]=fromTime.value.split(':').map(Number);const[th,tm]=toTime.value.split(':').map(Number);
    const fmins=fh*60+fm,tmins=th*60+tm;if(tmins<=fmins){const bump=fmins+60;
      const hh=String(Math.floor(bump/60)%24).padStart(2,'0');const mm=String(bump%60).padStart(2,'0');toTime.value=`${hh}:${mm}`;}};

  removeBtn.onclick=()=>{const prev=scope.previousElementSibling;if(prev&&prev.classList.contains('h-px'))prev.remove();scope.remove();};
}

/* ---------- Default tab ---------- */
setTab('single');
</script>
</body>
</html>
