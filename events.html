<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Spondle â€” Events (DEBUG v4)</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    /* Loud debug banner */
    #debug-v4 {
      background: #ffd54a;
      color: #1b1b1b;
      padding: 8px 12px;
      font-weight: 800;
      letter-spacing: .3px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="debug-v4">
    DEBUG v4 â€¢ If you canâ€™t see this banner, the new events.html isnâ€™t being served
  </div>

  <header>
    <div class="container nav">
      <div class="brand"><span class="logo"></span><a href="index.html">Spondle</a></div>
      <div class="actions">
        <a class="btn primary" href="events.html">Explore Events</a>
        <a class="btn" href="organisers.html">For Organisers</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h1>Explore Events</h1>
      <p class="tagline">Use the search and filters to narrow things down. (Prototype â€” client-side only)</p>
    </section>

    <!-- Filter & Sort bar -->
    <section class="section hero-card" style="display:grid;gap:10px">
      <div style="display:grid;gap:10px">
        <input class="input" id="q" placeholder="Search title, venue, cityâ€¦"/>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px">
          <select class="input" id="category">
            <option value="">All categories</option>
            <option>Live Music</option>
            <option>Comedy</option>
            <option>Food & Drink</option>
            <option>Film</option>
            <option>Community</option>
            <option>Networking</option>
            <option>Sports</option>
            <option>Arts & Culture</option>
          </select>
          <select class="input" id="city">
            <option value="">All cities</option>
            <option>Bristol</option>
            <option>Manchester</option>
            <option>Cardiff</option>
            <option>Leeds</option>
            <option>London</option>
            <option>Brighton</option>
            <option>Birmingham</option>
            <option>Glasgow</option>
            <option>Liverpool</option>
          </select>
          <select class="input" id="price">
            <option value="">Any price</option>
            <option value="free">Free</option>
            <option value="paid">Paid</option>
          </select>
          <input class="input" id="postcode" placeholder="Postcode (future)" />
          <select class="input" id="radius">
            <option>5 miles</option>
            <option>10 miles</option>
            <option selected>25 miles</option>
            <option>50 miles</option>
            <option>Nationwide</option>
          </select>
        </div>
      </div>

      <div class="cta-row" style="align-items:center;justify-content:space-between">
        <div class="cta-row">
          <button class="btn primary" id="apply">Apply filters</button>
          <button class="btn" id="reset">Reset</button>
          <span id="count" class="muted"></span>
        </div>
        <div class="cta-row">
          <label for="sort" class="muted" style="align-self:center">Sort:</label>
          <select class="input" id="sort" style="width:200px">
            <option value="">Relevance</option>
            <option value="dateAsc">Date â€” soonest first</option>
            <option value="priceAsc">Price â€” low to high</option>
            <option value="priceDesc">Price â€” high to low</option>
            <option value="titleAsc">Title â€” A to Z</option>
            <option value="cityAsc">City â€” A to Z</option>
          </select>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="grid" id="grid"></div>
      <p id="empty" class="tagline" style="display:none">
        No events match your filters. Try clearing them.
      </p>
    </section>
  </main>

  <footer>
    <div class="container foot">
      <div>Â© <span id="y"></span> Spondle</div>
    </div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    console.log('DEBUG v4 loaded');
  </script>
  <script src="auth.js"></script>

  <script>
    const EVENTS = [
      {id:"sample-1", title:"The Harbourside Sessions", city:"Bristol", dateLabel:"12 Sep", venue:"The Louisiana", time:"19:30â€“22:30", price:"Free Entry", category:"Live Music"},
      {id:"sample-2", title:"Friday Night Laughs", city:"Manchester", dateLabel:"14 Sep", venue:"Northern Quarter", time:"20:00â€“22:00", price:"Â£12", category:"Comedy"},
      {id:"sample-3", title:"Riverside Street Food", city:"Cardiff", dateLabel:"15 Sep", venue:"Market Square", time:"11:00â€“17:00", price:"Family", category:"Community"},
      {id:"sample-4", title:"Craft Beer Festival", city:"Leeds", dateLabel:"18 Sep", venue:"City Brewery Hall", time:"12:00â€“23:00", price:"Â£20", category:"Food & Drink"},
      {id:"sample-5", title:"Vintage Vinyl Market", city:"London", dateLabel:"20 Sep", venue:"Camden Market", time:"10:00â€“18:00", price:"Free Entry", category:"Market"},
      {id:"sample-6", title:"Outdoor Cinema Night", city:"Brighton", dateLabel:"22 Sep", venue:"Brighton Seafront", time:"20:30â€“23:00", price:"Â£10", category:"Film"},
      {id:"sample-7", title:"Tech Meetup & Networking", city:"Birmingham", dateLabel:"25 Sep", venue:"TechHub Central", time:"18:00â€“21:00", price:"Free", category:"Networking"},
      {id:"sample-8", title:"Charity Fun Run", city:"Glasgow", dateLabel:"27 Sep", venue:"Kelvingrove Park", time:"09:00â€“12:00", price:"Â£15 Donation", category:"Sports"},
      {id:"sample-9", title:"Open Mic Poetry Night", city:"Liverpool", dateLabel:"30 Sep", venue:"The Verse Bar", time:"19:00â€“22:00", price:"Free Entry", category:"Arts & Culture"},
    ];

    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    const empty = document.getElementById('empty');

    const $ = id => document.getElementById(id);

    const CURRENT_YEAR = new Date().getFullYear();
    const MONTHS = ["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];
    const parseDateLabel = (label="")=>{
      const m = label.trim().toLowerCase().match(/^(\d{1,2})\s+([a-z]{3})/i);
      if(!m) return null;
      const d=+m[1];
      const mon=MONTHS.indexOf(m[2].slice(0,3));
      if(mon<0) return null;
      return new Date(CURRENT_YEAR,mon,d);
    };

    const parsePrice = (p="")=>{
      const s=String(p).toLowerCase();
      if(s.includes("free")) return 0;
      const m=s.match(/Â£\s*([\d]+(\.\d+)?)/);
      return m?parseFloat(m[1]):Number.POSITIVE_INFINITY;
    };

    const SORTS = {
      "":{cmp:null},
      "dateAsc":{cmp:(a,b)=>(parseDateLabel(a.dateLabel)?.getTime()??9e15)-(parseDateLabel(b.dateLabel)?.getTime()??9e15)},
      "priceAsc":{cmp:(a,b)=>parsePrice(a.price)-parsePrice(b.price)},
      "priceDesc":{cmp:(a,b)=>parsePrice(b.price)-parsePrice(a.price)},
      "titleAsc":{cmp:(a,b)=>(a.title||"").localeCompare(b.title||"")},
      "cityAsc":{cmp:(a,b)=>(a.city||"").localeCompare(b.city||"")}
    };

    function applyFilters(){
      const q = $('q').value.trim().toLowerCase();
      const cat = $('category').value;
      const city = $('city').value;
      const price = $('price').value;
      const sortKey = $('sort').value;

      let list = EVENTS.slice();
      if(q){
        list = list.filter(e => (e.title||'').toLowerCase().includes(q) ||
                                (e.venue||'').toLowerCase().includes(q) ||
                                (e.city||'').toLowerCase().includes(q) ||
                                (e.category||'').toLowerCase().includes(q));
      }
      if(cat)  list = list.filter(e => (e.category||'').toLowerCase() === cat.toLowerCase());
      if(city) list = list.filter(e => (e.city||'').toLowerCase() === city.toLowerCase());
      if(price==='free') list = list.filter(e => (e.price||'').toLowerCase().includes('free'));
      else if(price==='paid') list = list.filter(e => !((e.price||'').toLowerCase().includes('free')));

      const entry = SORTS[sortKey] || SORTS[""];
      if(entry.cmp) list = list.slice().sort(entry.cmp);

      render(list);
      updateURL();
    }

    function render(list){
      if(!list.length){
        grid.innerHTML='';
        empty.style.display='block';
        count.textContent='0 results';
        return;
      }
      empty.style.display='none';
      count.textContent = `${list.length} result${list.length>1?'s':''}`;

      grid.innerHTML = list.map(ev=>{
        return `
          <article class="card">
            <a href="event.html?id=${ev.id}" style="display:block;color:inherit">
              <div class="thumb">
                <span class="badge">${ev.city || ''} â€¢ ${ev.dateLabel || ''}</span>
                ðŸŽ« ${ev.category || ''}
              </div>
              <div class="content">
                <h3>${ev.title}</h3>
                <p class="meta">${ev.venue || ''}${ev.time ? ' â€¢ '+ev.time : ''}</p>
                <div class="row">
                  <span class="chip">${ev.price || 'Free'}</span>
                  <span class="muted">Details â†’</span>
                </div>
                <div class="cta-row" style="margin-top:10px">
                  <button class="btn">â™¡ Save</button>
                </div>
              </div>
            </a>
          </article>
        `;
      }).join('');
    }

    function updateURL(){
      const params = new URLSearchParams();
      const q = $('q').value.trim(); if (q) params.set('q', q);
      const cat = $('category').value; if (cat) params.set('category', cat);
      const city = $('city').value; if (city) params.set('city', city);
      const price = $('price').value; if (price) params.set('price', price);
      const postcode = $('postcode').value.trim(); if (postcode) params.set('postcode', postcode);
      const radius = $('radius').value; if (radius) params.set('radius', radius);
      const sortKey = $('sort').value; if (sortKey) params.set('sort', sortKey);
      history.replaceState(null, '', location.pathname + (params.toString()?`?${params}`:''));
    }

    document.getElementById('apply').addEventListener('click', applyFilters);
    document.getElementById('reset').addEventListener('click', ()=>{
      ['q','category','city','price','postcode','radius','sort'].forEach(id=>{
        const el=$(id);
        if(el.tagName==='SELECT') el.selectedIndex=0; else el.value='';
      });
      applyFilters();
    });
    document.getElementById('sort').addEventListener('change', applyFilters);

    applyFilters();
  </script>
</body>
</html>
