<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Spondle â€” Events</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand"><span class="logo"></span><a href="index.html">Spondle</a></div>
      <div class="actions">
        <a class="btn primary" href="events.html">Explore Events</a>
        <a class="btn" href="organisers.html">For Organisers</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h1>Explore Events</h1>
      <p class="tagline">Use the search and filters to narrow things down. (Prototype â€” client-side only)</p>
    </section>

    <!-- Filter & Sort bar -->
    <section class="section hero-card" style="display:grid;gap:10px">
      <div style="display:grid;gap:10px">
        <input class="input" id="q" placeholder="Search title, venue, cityâ€¦"/>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px">
          <select class="input" id="category">
            <option value="">All categories</option>
            <option>Live Music</option>
            <option>Comedy</option>
            <option>Food & Drink</option>
            <option>Film</option>
            <option>Community</option>
            <option>Networking</option>
            <option>Sports</option>
            <option>Arts & Culture</option>
          </select>
          <select class="input" id="city">
            <option value="">All cities</option>
            <option>Bristol</option><option>Manchester</option><option>Cardiff</option><option>Leeds</option>
            <option>London</option><option>Brighton</option><option>Birmingham</option><option>Glasgow</option><option>Liverpool</option>
          </select>
          <select class="input" id="price">
            <option value="">Any price</option>
            <option value="free">Free</option>
            <option value="paid">Paid</option>
          </select>
          <!-- Future fields (placeholders) -->
          <input class="input" id="postcode" placeholder="Postcode (future)" />
          <select class="input" id="radius">
            <option>5 miles</option><option>10 miles</option><option selected>25 miles</option><option>50 miles</option><option>Nationwide</option>
          </select>
        </div>
      </div>

      <div class="cta-row" style="align-items:center;justify-content:space-between">
        <div class="cta-row">
          <button class="btn primary" id="apply">Apply filters</button>
          <button class="btn" id="reset">Reset</button>
          <span id="count" class="muted"></span>
        </div>

        <!-- Sort dropdown -->
        <div class="cta-row">
          <label for="sort" class="muted" style="align-self:center">Sort:</label>
          <select class="input" id="sort" style="width:200px">
            <option value="">Relevance</option>
            <option value="dateAsc">Date â€” soonest first</option>
            <option value="priceAsc">Price â€” low to high</option>
            <option value="priceDesc">Price â€” high to low</option>
            <option value="titleAsc">Title â€” A to Z</option>
            <option value="cityAsc">City â€” A to Z</option>
          </select>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="grid" id="grid"></div>
      <p id="empty" class="tagline" style="display:none">No events match your filters. Try clearing them.</p>
    </section>
  </main>

  <footer>
    <div class="container foot"><div>Â© <span id="y"></span> Spondle</div></div>
  </footer>

  <script>
    document.getElementById('y').textContent = new Date().getFullYear();

    // --- Sample data (same IDs as event.html) ---
    const EVENTS = [
      {id:"sample-1", title:"The Harbourside Sessions", city:"Bristol",   dateLabel:"12 Sep", venue:"The Louisiana",       time:"19:30â€“22:30", price:"Free Entry",    category:"Live Music"},
      {id:"sample-2", title:"Friday Night Laughs",       city:"Manchester",dateLabel:"14 Sep", venue:"Northern Quarter",     time:"20:00â€“22:00", price:"Â£12",            category:"Comedy"},
      {id:"sample-3", title:"Riverside Street Food",     city:"Cardiff",   dateLabel:"15 Sep", venue:"Market Square",        time:"11:00â€“17:00", price:"Family",         category:"Community"},
      {id:"sample-4", title:"Craft Beer Festival",       city:"Leeds",     dateLabel:"18 Sep", venue:"City Brewery Hall",    time:"12:00â€“23:00", price:"Â£20",            category:"Food & Drink"},
      {id:"sample-5", title:"Vintage Vinyl Market",      city:"London",    dateLabel:"20 Sep", venue:"Camden Market",        time:"10:00â€“18:00", price:"Free Entry",     category:"Market"},
      {id:"sample-6", title:"Outdoor Cinema Night",      city:"Brighton",  dateLabel:"22 Sep", venue:"Brighton Seafront",    time:"20:30â€“23:00", price:"Â£10",            category:"Film"},
      {id:"sample-7", title:"Tech Meetup & Networking",  city:"Birmingham",dateLabel:"25 Sep", venue:"TechHub Central",      time:"18:00â€“21:00", price:"Free",           category:"Networking"},
      {id:"sample-8", title:"Charity Fun Run",           city:"Glasgow",   dateLabel:"27 Sep", venue:"Kelvingrove Park",     time:"09:00â€“12:00", price:"Â£15 Donation",   category:"Sports"},
      {id:"sample-9", title:"Open Mic Poetry Night",     city:"Liverpool", dateLabel:"30 Sep", venue:"The Verse Bar",        time:"19:00â€“22:00", price:"Free Entry",     category:"Arts & Culture"},
    ];

    // --- Elements ---
    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    const empty = document.getElementById('empty');
    const $ = id => document.getElementById(id);

    // --- URL params â†’ form prefill ---
    const url = new URL(location.href);
    const qp = Object.fromEntries(url.searchParams.entries());
    if (qp.q) $('q').value = qp.q;
    if (qp.category) $('category').value = qp.category;
    if (qp.city) $('city').value = qp.city;
    if (qp.price) $('price').value = qp.price;
    if (qp.postcode) $('postcode').value = qp.postcode;
    if (qp.radius) $('radius').value = qp.radius;
    if (qp.sort) $('sort').value = qp.sort;

    // --- Helpers: parsing & normalization ---
    const CURRENT_YEAR = new Date().getFullYear();
    const MONTHS = ["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];

    function parseDateLabel(label="") {
      // expects formats like "12 Sep" â†’ Date(CURRENT_YEAR, 8, 12)
      const m = label.trim().toLowerCase().match(/^(\d{1,2})\s+([a-z]{3})/i);
      if (!m) return null;
      const d = parseInt(m[1], 10);
      const mon = MONTHS.indexOf(m[2].slice(0,3).toLowerCase());
      if (mon < 0) return null;
      return new Date(CURRENT_YEAR, mon, d);
    }

    function parsePrice(p="") {
      const s = String(p).toLowerCase();
      if (s.includes("free")) return 0;
      const match = s.match(/Â£\s*([\d]+(\.\d+)?)/);
      if (match) return parseFloat(match[1]);
      // Unknown / non-numeric prices go to the end when sorting ascending
      return Number.POSITIVE_INFINITY;
    }

    // --- SORTS registry (extensible) ---
    // Add new keys here later (e.g., 'distanceAsc') and a comparator.
    const SORTS = {
      "":            { label: "Relevance",       cmp: null }, // null means keep filtered order
      "dateAsc":     { label: "Date â€” soonest",  cmp: (a,b)=> (parseDateLabel(a.dateLabel)?.getTime() ?? 9e15) - (parseDateLabel(b.dateLabel)?.getTime() ?? 9e15) },
      "priceAsc":    { label: "Price â€” lowâ†’high",cmp: (a,b)=> parsePrice(a.price) - parsePrice(b.price) },
      "priceDesc":   { label: "Price â€” highâ†’low",cmp: (a,b)=> parsePrice(b.price) - parsePrice(a.price) },
      "titleAsc":    { label: "Title â€” Aâ†’Z",     cmp: (a,b)=> (a.title||"").localeCompare(b.title||"") },
      "cityAsc":     { label: "City â€” Aâ†’Z",      cmp: (a,b)=> (a.city||"").localeCompare(b.city||"") },
      // "distanceAsc": { label: "Distance â€” nearâ†’far", cmp: (a,b)=> (a._distance||1e9) - (b._distance||1e9) } // future
    };

    // --- Filtering logic ---
    function applyFilters(){
      const q = $('q').value.trim().toLowerCase();
      const cat = $('category').value;
      const city = $('city').value;
      const price = $('price').value; // '', 'free', 'paid'
      const sortKey = $('sort').value;

      let list = EVENTS.slice();

      if (q) {
        list = list.filter(e => (
          (e.title||'').toLowerCase().includes(q) ||
          (e.venue||'').toLowerCase().includes(q) ||
          (e.city||'').toLowerCase().includes(q) ||
          (e.category||'').toLowerCase().includes(q)
        ));
      }
      if (cat) list = list.filter(e => (e.category||'').toLowerCase() === cat.toLowerCase());
      if (city) list = list.filter(e => (e.city||'').toLowerCase() === city.toLowerCase());
      if (price === 'free') {
        list = list.filter(e => (e.price||'').toLowerCase().includes('free'));
      } else if (price === 'paid') {
        list = list.filter(e => !((e.price||'').toLowerCase().includes('free')));
      }

      // Apply sort if comparator exists
      const entry = SORTS[sortKey] || SORTS[""];
      if (entry.cmp) list = list.slice().sort(entry.cmp);

      render(list);
      updateURL();
    }

    function render(list){
      if (!list.length) {
        grid.innerHTML = '';
        empty.style.display = 'block';
        count.textContent = '0 results';
        return;
      }
      empty.style.display = 'none';
      count.textContent = `${list.length} result${list.length>1?'s':''}`;

      grid.innerHTML = list.map(ev => {
        const emoji = categoryEmoji(ev.category);
        return `
          <article class="card">
            <a href="event.html?id=${ev.id}" style="display:block;color:inherit">
              <div class="thumb"><span class="badge">${ev.city || ''} â€¢ ${ev.dateLabel || ''}</span>${emoji} ${ev.category || ''}</div>
              <div class="content">
                <h3>${ev.title}</h3>
                <p class="meta">${ev.venue || ''}${ev.time ? ' â€¢ '+ev.time : ''}</p>
                <div class="row"><span class="chip">${ev.price || 'Free'}</span><span class="muted">Details â†’</span></div>
              </div>
            </a>
          </article>
        `;
      }).join('');
    }

    function categoryEmoji(cat=''){
      const c = cat.toLowerCase();
      if (c.includes('music')) return 'ðŸŽµ';
      if (c.includes('comedy')) return 'ðŸŽ­';
      if (c.includes('food')) return 'ðŸº';
      if (c.includes('film')) return 'ðŸŽ¬';
      if (c.includes('community')) return 'ðŸž';
      if (c.includes('network')) return 'ðŸ’»';
      if (c.includes('sport')) return 'ðŸƒâ€â™‚ï¸';
      if (c.includes('arts')) return 'ðŸ“–';
      if (c.includes('market')) return 'ðŸ›ï¸';
      return 'ðŸŽ«';
    }

    function updateURL(){
      const params = new URLSearchParams();
      const q = $('q').value.trim(); if (q) params.set('q', q);
      const cat = $('category').value; if (cat) params.set('category', cat);
      const city = $('city').value; if (city) params.set('city', city);
      const price = $('price').value; if (price) params.set('price', price);
      const postcode = $('postcode').value.trim(); if (postcode) params.set('postcode', postcode);
      const radius = $('radius').value; if (radius) params.set('radius', radius);
      const sortKey = $('sort').value; if (sortKey) params.set('sort', sortKey);
      const newURL = location.pathname + (params.toString() ? `?${params}` : '');
      history.replaceState(null, '', newURL);
    }

    // Events
    $('apply').addEventListener('click', applyFilters);
    $('reset').addEventListener('click', () => {
      ['q','category','city','price','postcode','radius','sort'].forEach(id => {
        const el = $(id);
        if (el.tagName==='SELECT') el.selectedIndex = 0; else el.value='';
      });
      applyFilters();
    });
    $('sort').addEventListener('change', applyFilters);

    // Initial render with any pre-filled params
    applyFilters();
  </script>
</body>
</html>
