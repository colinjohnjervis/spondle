<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Dashboard â€” Spondle</title>
  <meta name="color-scheme" content="dark" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="./spondle-layout.css?v=1004">
  <link rel="stylesheet" href="./styles.css?v=1004">
</head>
<body class="bg-black text-white">
  <!-- Header + Sidebar -->
  <div id="layout-root"></div>

  <main class="px-4 sm:px-6 lg:px-8 mt-6 space-y-8">
    <section class="panel p-6 md:p-8">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Event Dashboard</h1>
      <p class="text-[color:var(--muted)] mt-3 max-w-2xl">
        Manage and review your published and draft events.
      </p>

      <!-- Buttons -->
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="/create-event.html"
           class="px-6 py-3 bg-green-500 text-black font-semibold rounded-md hover:bg-green-400 transition">
          + Create Event
        </a>
      </div>

      <!-- Month-Year Filter -->
      <div class="mt-6">
        <label for="monthFilter" class="block text-sm text-gray-400 mb-1">Filter by Month/Year</label>
        <select id="monthFilter" class="w-full sm:w-64 p-2 bg-gray-800 border border-gray-600 rounded">
          <!-- Options populated dynamically -->
        </select>
      </div>

      <!-- Tabs -->
      <div class="border-b border-gray-700 mt-8 mb-4">
        <nav class="-mb-px flex space-x-6" id="dashboard-tabs">
          <button data-tab="published" class="tab-button border-b-2 border-green-500 text-green-500 px-3 py-2 text-sm font-medium">Published</button>
          <button data-tab="drafts" class="tab-button text-gray-400 hover:text-gray-200 px-3 py-2 text-sm font-medium">Drafts</button>
        </nav>
      </div>

      <!-- Published -->
      <div id="published" class="tab-panel grid gap-4 sm:grid-cols-2 lg:grid-cols-3 mt-6"></div>

      <!-- Drafts -->
      <div id="drafts" class="tab-panel hidden grid gap-4 sm:grid-cols-2 lg:grid-cols-3 mt-6"></div>
    </section>
  </main>

  <!-- JS -->
  <script src="./spondle-layout.js?v=1004" type="module"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      "https://jvuunvnbpdfrttusgelz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2dXVudm5icGRmcnR0dXNnZWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk0NjksImV4cCI6MjA3MzA1NTQ2OX0.i5-X-GsirwcZl0CdAfGsA6qM4ml5itnekPh0RoDCPVY"
    );

    let allEvents = [];

    // Tab switching
    document.querySelectorAll(".tab-button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-button").forEach(b => {
          b.classList.remove("border-green-500","text-green-500");
          b.classList.add("text-gray-400");
        });
        btn.classList.add("border-green-500","text-green-500");
        btn.classList.remove("text-gray-400");

        document.querySelectorAll(".tab-panel").forEach(panel => panel.classList.add("hidden"));
        document.getElementById(btn.dataset.tab).classList.remove("hidden");

        renderLists();
      });
    });

    function formatDate(d) {
      const date = new Date(d);
      if (isNaN(date)) return "";
      return date.toLocaleDateString("en-GB", {
        weekday: "long", day: "numeric", month: "long", year: "numeric"
      });
    }

    function renderEventTile(event) {
      const venueName = event.venues?.venue_name || "Venue TBA";
      const townCity = event.venues?.location?.town_city || "";
      const venueDisplay = townCity ? `${venueName}, ${townCity}` : venueName;
      const imageUrl = event.image_url || "https://spondle-uk.vercel.app/images/placeholder.jpg";

      return `
        <div class="relative rounded-xl overflow-hidden shadow bg-gray-900 hover:opacity-90 transition">
          <a href="/edit-event.html?id=${event.id}" class="absolute top-3 right-3 z-10 text-gray-200 hover:text-white" title="Edit Event">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15.232 5.232l3.536 3.536M9 13l6.768-6.768a2 2 0 112.828 2.828L11.828 15.828a2 2 0 01-.828.515L7 17l1.657-4.001a2 2 0 01.515-.767z" />
            </svg>
          </a>
          <img src="${imageUrl}" alt="${event.event_name}" class="w-full h-80 object-cover">
          <div class="p-4">
            <h3 class="text-lg font-semibold mb-1">${event.event_name}</h3>
            <p class="text-sm text-gray-400 mb-1">${formatDate(event.event_date)}</p>
            <p class="text-sm text-gray-400">${venueDisplay}</p>
          </div>
        </div>
      `;
    }

    function populateMonthFilter(events) {
      const select = document.getElementById("monthFilter");
      const months = new Set(events.map(e => {
        const d = new Date(e.event_date);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      }));

      const sorted = Array.from(months).sort();
      select.innerHTML = `<option value="all">All Events</option>` +
        sorted.map(val => {
          const [y,m] = val.split("-");
          const label = new Date(y, m-1).toLocaleDateString("en-GB", { month:"long", year:"numeric" });
          return `<option value="${val}">${label}</option>`;
        }).join("");

      const now = new Date();
      const current = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      if (sorted.includes(current)) select.value = current;
    }

    function filterEvents(events) {
      const val = document.getElementById("monthFilter").value;
      if (val === "all") return events;
      return events.filter(e => {
        const d = new Date(e.event_date);
        const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        return ym === val;
      });
    }

    function renderLists() {
      const filtered = filterEvents(allEvents);
      filtered.sort((a, b) => new Date(a.event_date) - new Date(b.event_date));

      const drafts = filtered.filter(e => e.publish_status === "draft");
      const published = filtered.filter(e => e.publish_status === "published");

      document.getElementById("drafts").innerHTML = drafts.length
        ? drafts.map(renderEventTile).join("")
        : `<p class='text-gray-400 col-span-full'>No draft events found.</p>`;

      document.getElementById("published").innerHTML = published.length
        ? published.map(renderEventTile).join("")
        : `<p class='text-gray-400 col-span-full'>No published events found.</p>`;
    }

    async function loadEvents() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data: events, error } = await supabase
        .from("events")
        .select(`
          id,
          event_name,
          event_date,
          publish_status,
          image_url,
          venues (
            venue_name,
            location:location_id (town_city)
          )
        `)
        .eq("organiser_id", user.id);

      if (error) {
        console.error(error);
        return;
      }

      allEvents = events.sort((a, b) => new Date(a.event_date) - new Date(b.event_date));
      populateMonthFilter(events);
      renderLists();
    }

    document.getElementById("monthFilter").addEventListener("change", renderLists);

    window.addEventListener("DOMContentLoaded", async () => {
      window.Layout?.init({ active: "dashboard" });
      await loadEvents();
    });
  </script>
</body>
</html>
