<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spondle (canary A1)</title>

  <link rel="stylesheet" href="app.v15.css" />
  <link rel="stylesheet" href="app.v17.css" />

  <style>
    :root{ --header-offset: 72px; } /* fallback; updated at runtime */

    .grid { display:grid; gap:14px; }
    @media (min-width:680px){ .grid{ grid-template-columns:1fr 1fr; } }
    @media (min-width:980px){ .grid{ grid-template-columns:1fr 1fr 1fr; } }

    .loadmore-wrap{ display:flex; justify-content:center; margin:18px 0 8px; }
    .btn-ghost{ background:transparent; border:1px solid var(--card-border,#2a2f3a);
      color:var(--text,#dfe7ff); padding:10px 16px; border-radius:10px; }

    /* Favourite hearts */
    .heart{ font-size:18px; line-height:1; }
    .heart.is-saved{ color:var(--accent,#7de1c3); }

    /* ★ The important bit: keep scrolled cards below sticky header */
    .card{ scroll-margin-top: var(--header-offset); }
    .featured{ scroll-margin-top: var(--header-offset); }
  </style>
</head>
<body>
  <!-- ===== Fixed Header ===== -->
  <header class="site-header" id="siteHeader">
    <div class="nav-wrap">
      <a class="brand" href="index.html">
        <span class="brand-dot" aria-hidden="true"></span>
        <span class="brand-name">Spondle</span>
        <span class="beta-pill">Beta</span>
      </a>
      <nav class="main-nav" aria-label="Primary">
        <a class="nav-tab is-active" href="index.html">Explore<br/>Events</a>
        <a class="nav-tab" href="favourites.html">Favourites <span id="favBadge" class="badge" hidden>0</span></a>
        <a class="nav-tab" href="organisers.html">For<br/>Organisers</a>
      </nav>
    </div>
  </header>

  <!-- Spacer for fixed header -->
  <div class="header-spacer" id="headerSpacer"></div>

  <!-- ===== Page Content ===== -->
  <main class="page">
    <section class="hero">
      <h1>Spondle (canary A1)</h1>
      <p>Discover gigs, comedy, food markets, film nights, community events and more — across the UK.</p>
      <div class="hero-actions">
        <a class="btn primary" href="events.html">Search events</a>
        <a class="btn" href="organisers.html">List your event</a>
      </div>
    </section>

    <!-- Featured card -->
    <section class="section">
      <h2 class="section-title">Popular right now</h2>
      <a class="card featured" href="event.html?id=harbourside-sessions">
        <div class="card-top">
          <span class="chip">Bristol • 12 Sep</span>
          <button class="heart" type="button" aria-label="Save this event" data-id="harbourside-sessions">♡</button>
        </div>
        <h3 class="card-title">The Harbourside Sessions</h3>
        <p class="meta">The Louisiana • 19:30–22:30</p>
        <span class="price-chip">Free Entry</span>
      </a>
    </section>

    <!-- Latest events grid with Load More -->
    <section class="section" id="latestSection">
      <h2 class="section-title">Latest events</h2>
      <div id="homeGrid" class="grid" aria-live="polite"></div>
      <div class="loadmore-wrap" id="lmWrap">
        <button id="loadMoreBtn" class="btn-ghost" type="button">Load more</button>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <small>© 2025 Spondle • build v32b</small>
  </footer>

  <script src="script.js" defer></script>

  <script>
    // ---------- FAVOURITES ----------
    const FKEY = 'spondle:favs';
    function readFavs(){ try { return JSON.parse(localStorage.getItem(FKEY) || '[]'); } catch { return []; } }
    function writeFavs(list){ localStorage.setItem(FKEY, JSON.stringify(list)); }
    function isSaved(id){ return readFavs().includes(id); }
    function setHeartVisual(btn, saved){
      btn.textContent = saved ? '♥' : '♡';
      btn.classList.toggle('is-saved', !!saved);
    }
    function updateBadge(){
      const b = document.getElementById('favBadge');
      const n = readFavs().length;
      if (n > 0){ b.textContent = n; b.hidden = false; } else { b.hidden = true; }
    }
    function toggleFav(id, btn){
      const favs = readFavs();
      const i = favs.indexOf(id);
      if (i >= 0) favs.splice(i,1); else favs.push(id);
      writeFavs(favs);
      setHeartVisual(btn, i < 0);
      updateBadge();
    }

    // Stop card navigation when heart is tapped
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button.heart');
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      const id = btn.dataset.id;
      if (!id) return;
      toggleFav(id, btn);
    });

    updateBadge();

    // ---------- Sticky header spacer + dynamic scroll offset ----------
    function setHeaderSpacer() {
      const header = document.getElementById('siteHeader');
      const spacer = document.getElementById('headerSpacer');
      if (!header || !spacer) return;
      const h = header.offsetHeight;
      spacer.style.height = h + 'px';
      // expose to CSS so scroll-margin-top matches header height
      document.documentElement.style.setProperty('--header-offset', (h + 8) + 'px');
    }
    window.addEventListener('load', setHeaderSpacer, { once:true });
    window.addEventListener('resize', setHeaderSpacer);

    // ---------- SAMPLE DATA + LOAD MORE ----------
    function getEventsSample(){
      if (window.SAMPLE_EVENTS && Array.isArray(window.SAMPLE_EVENTS)) return window.SAMPLE_EVENTS;
      const cities = ["Bristol","Manchester","Edinburgh","Cardiff","Leeds","London","Bath","Oxford"];
      const cats = ["Live Music","Comedy","Food & Drink","Theatre","Community","Film","Talks","Family"];
      const venues = ["The Fleece","The Louisiana","The Stand","The Apple","Academy","Arts Centre","Playhouse","Union"];
      const out = [];
      for (let i=0;i<60;i++){
        out.push({
          id: "e"+(1000+i),
          city: cities[i%cities.length],
          date: `${10+(i%20)} Oct`,
          category: cats[i%cats.length],
          title: `${cats[i%cats.length]} Night #${i+1}`,
          venue: venues[i%venues.length],
          time: "19:30–22:30",
          priceLabel: (i%5===0) ? "Free Entry" : "£" + (6 + (i%12))
        });
      }
      return out;
    }
    function cardHTML(ev){
      const saved = isSaved(ev.id);
      const heart = saved ? '♥' : '♡';
      const savedClass = saved ? ' is-saved' : '';
      return `
      <a class="card" href="event.html?id=${encodeURIComponent(ev.id)}">
        <div class="card-top">
          <span class="chip">${ev.city} • ${ev.date}</span>
          <button class="heart${savedClass}" type="button" aria-label="Save this event" data-id="${ev.id}">${heart}</button>
        </div>
        <h3 class="card-title">${ev.title}</h3>
        <p class="meta">${ev.venue} • ${ev.time}</p>
        <span class="price-chip">${ev.priceLabel}</span>
      </a>`;
    }

    const ALL = getEventsSample();
    const BATCH = 12;
    let shown = 0;

    function renderNextBatch(scrollToFirstNew=true){
      const grid = document.getElementById('homeGrid');
      const next = ALL.slice(shown, shown + BATCH);
      if (next.length === 0) return;

      const html = next.map(cardHTML).join('');
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      const firstNew = wrapper.firstElementChild;
      while (wrapper.firstChild) grid.appendChild(wrapper.firstChild);

      shown += next.length;
      if (shown >= ALL.length) document.getElementById('lmWrap').style.display = 'none';

      // With scroll-margin-top in CSS, this aligns perfectly under the sticky header
      if (scrollToFirstNew && firstNew) {
        firstNew.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    window.addEventListener('DOMContentLoaded', function(){
      // set initial heart state for featured
      const featuredHeart = document.querySelector('.featured .heart');
      if (featuredHeart) setHeartVisual(featuredHeart, isSaved(featuredHeart.dataset.id));

      renderNextBatch(false); // initial 12
      document.getElementById('loadMoreBtn').addEventListener('click', () => renderNextBatch(true));
    });
  </script>
</body>
</html>
