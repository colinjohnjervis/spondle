<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Venue – Spondle</title>
  <meta name="color-scheme" content="dark" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Sidebar + sticky header -->
  <script type="module" src="./spondle-layout.js"></script>

  <style>
    body { background:#0a0f1a; color:#e5e7eb; font-family:ui-sans-serif, system-ui, -apple-system,"Segoe UI",Roboto,Helvetica,Arial; }
    .panel { background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:1rem; }
    .input { width:100%; background:#111827; border:1px solid #1f2937; border-radius:8px; padding:.6rem .75rem; color:#f3f4f6; font-size:.95rem; }
    .input:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.25); }
    .btn { display:inline-flex; justify-content:center; align-items:center; font-weight:600; border-radius:8px; padding:.75rem 1rem; }
    .btn-green { background:#22c55e; color:#00130a; } .btn-green:hover{filter:brightness(1.1)}
    .btn-ghost { color:#93c5fd; } .btn-ghost:hover{ text-decoration:underline }
    .result-card { background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:.75rem; cursor:pointer; }
    .result-card:hover { background:#0c1526; border-color:#334155; }
    .dropdown { position:relative }
    .menu { position:absolute; z-index:30; top:100%; left:0; right:0; background:#0b1220; border:1px solid #1f2937; border-radius:10px; margin-top:.25rem; max-height:16rem; overflow:auto; }
    .menu button { width:100%; text-align:left; padding:.55rem .75rem; }
    .menu button:hover { background:#0c1526; }
    .hidden{display:none}
    label{display:block;color:#cbd5e1;font-size:.9rem;margin-bottom:.25rem}
  </style>
</head>

<body>
  <div id="main-content" class="max-w-3xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-4">Create a New Venue</h1>
    <p id="connectionStatus" class="mb-5 text-green-400">Connecting to Supabase...</p>

    <!-- Search -->
    <div class="panel mb-6">
      <label for="venueSearch" class="font-semibold">Search for venue first</label>
      <input id="venueSearch" type="text" class="input" placeholder="Type a venue name..." autocomplete="off" />
      <div id="searchResults" class="mt-3 space-y-2 text-sm"></div>

      <div id="createPromptRow" class="mt-4 hidden">
        <p class="text-emerald-400 mb-2">No results found — you can create a new venue.</p>
        <button id="showCreateBtn" class="btn btn-green w-full">Create a new venue</button>
      </div>

      <div id="cantFindRow" class="mt-3 hidden text-right">
        <button id="cantFindBtn" class="btn btn-ghost text-sm">Can’t find it? Create a new venue</button>
      </div>
    </div>

    <!-- Selected venue -->
    <div id="selectedVenuePanel" class="panel mb-6 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Selected venue</h2>
        <button id="clearSelectionBtn" class="btn btn-ghost text-sm">Clear</button>
      </div>
      <div id="selectedVenueBody" class="mt-3 text-sm"></div>
    </div>

    <!-- Add new venue -->
    <div id="venueFormSection" class="panel hidden">
      <h2 class="text-xl font-semibold mb-3">Add new venue</h2>
      <form id="venueForm" class="space-y-4" autocomplete="off">
        <div>
          <label for="venue_name">Venue Name</label>
          <input id="venue_name" class="input" required />
        </div>

        <div>
          <label for="street_name">Street Address</label>
          <input id="street_name" class="input" />
        </div>

        <!-- Town/City Autocomplete -->
        <div class="dropdown">
          <label for="town_city">Town / City</label>
          <input id="town_city" class="input" placeholder="Start typing…" />
          <!-- hidden location_id for submission -->
          <input id="location_id" type="hidden" />
          <!-- suggestions -->
          <div id="townMenu" class="menu hidden"></div>
        </div>

        <!-- County (visible read-only, auto-fills after selection) -->
        <div>
          <label for="county">County</label>
          <input id="county" class="input" readonly />
        </div>

        <div>
          <label for="postcode">Postcode</label>
          <input id="postcode" class="input" />
        </div>

        <div>
          <label for="email_address">Email</label>
          <input id="email_address" type="email" class="input" required />
        </div>

        <div>
          <label for="telephone_number">Telephone</label>
          <input id="telephone_number" class="input" type="tel" />
        </div>

        <div>
          <label for="website_address">Website</label>
          <input id="website_address" class="input" placeholder="www.example.com" />
        </div>

        <button type="submit" class="btn btn-green w-full mt-2">Create Venue</button>
      </form>
      <div id="formFeedback" class="mt-4 text-sm font-medium"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(
      "https://jvuunvnbpdfrttusgelz.supabase.co",
      "sb_publishable_3MgTmkpcR73OVvablohiog_06I0EQsn"
    );

    // Els
    const connectionStatus = document.getElementById("connectionStatus");
    const searchInput = document.getElementById("venueSearch");
    const searchResults = document.getElementById("searchResults");
    const createPromptRow = document.getElementById("createPromptRow");
    const showCreateBtn = document.getElementById("showCreateBtn");
    const cantFindRow = document.getElementById("cantFindRow");
    const cantFindBtn = document.getElementById("cantFindBtn");
    const selectedPanel = document.getElementById("selectedVenuePanel");
    const selectedBody = document.getElementById("selectedVenueBody");
    const clearSelectionBtn = document.getElementById("clearSelectionBtn");

    const formSection = document.getElementById("venueFormSection");
    const form = document.getElementById("venueForm");
    const formFeedback = document.getElementById("formFeedback");

    // Autocomplete els
    const townInput = document.getElementById("town_city");
    const townMenu = document.getElementById("townMenu");
    const locationIdInput = document.getElementById("location_id");
    const countyInput = document.getElementById("county");

    let selectedVenueId = null;

    // Connection test
    (async () => {
      const { error } = await supabase.from("venues").select("id").limit(1);
      if (error) {
        connectionStatus.textContent = "❌ Failed to connect to Supabase";
        connectionStatus.classList.add("text-red-400");
      } else {
        connectionStatus.textContent = "✅ Connected to Supabase successfully";
      }
    })();

    // Utils
    const debounce = (fn, delay=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); } };
    const closeTownMenu = () => townMenu.classList.add("hidden");

    // Search venues (like event form)
    function resultCard(row){
      const el=document.createElement("button");
      el.type="button"; el.className="result-card w-full text-left";
      el.innerHTML = `
        <div class="font-medium">${row.venue_name || "(no name)"}</div>
        <div class="text-sm text-gray-400">${row.street_name || ""} ${row.postcode ? "· "+row.postcode : ""}</div>`;
      el.addEventListener("click",()=>selectVenue(row));
      return el;
    }

    function selectVenue(row){
      selectedVenueId=row.id;
      formSection.classList.add("hidden");
      selectedPanel.classList.remove("hidden");
      selectedBody.innerHTML = `
        <div><b>Name:</b> ${row.venue_name || "-"}</div>
        <div><b>Street:</b> ${row.street_name || "-"}</div>
        <div><b>Postcode:</b> ${row.postcode || "-"}</div>
        <div><b>Email:</b> ${row.email_address || "-"}</div>
        <div><b>Telephone:</b> ${row.telephone_number || "-"}</div>
        <div><b>Website:</b> ${row.website_address || "-"}</div>`;
    }

    clearSelectionBtn.addEventListener("click",()=>{
      selectedVenueId=null;
      selectedPanel.classList.add("hidden");
    });

    showCreateBtn.addEventListener("click",()=>{
      formSection.classList.remove("hidden");
      formFeedback.textContent="";
      const q=searchInput.value.trim();
      if(q) document.getElementById("venue_name").value=q;
    });
    cantFindBtn.addEventListener("click",()=>showCreateBtn.click());

    const runSearch = debounce(async ()=>{
      const q=searchInput.value.trim();
      searchResults.innerHTML="";
      createPromptRow.classList.add("hidden");
      cantFindRow.classList.add("hidden");
      formSection.classList.add("hidden");

      if(q.length<2) return;

      const { data, error } = await supabase
        .from("venues")
        .select("id, venue_name, street_name, postcode, email_address, telephone_number, website_address")
        .ilike("venue_name", `%${q}%`).limit(12);

      if(error){ searchResults.innerHTML=`<p class="text-red-400 text-sm">Error: ${error.message}</p>`; return; }

      if(data && data.length){
        data.forEach(r=>searchResults.appendChild(resultCard(r)));
        cantFindRow.classList.remove("hidden");
      } else {
        searchResults.innerHTML=`<p class="text-emerald-400">No results found.</p>`;
        createPromptRow.classList.remove("hidden");
      }
    },300);
    searchInput.addEventListener("input", runSearch);

    // --- Town/City Autocomplete (location table) ---
    const searchLocation = debounce(async ()=>{
      const q = townInput.value.trim();
      locationIdInput.value = ""; // reset until a selection is made
      if(q.length<2){ closeTownMenu(); return; }

      const { data, error } = await supabase
        .from("location")
        .select("id, town_city, county")
        .ilike("town_city", `%${q}%`)
        .order("town_city")
        .limit(20);

      if(error || !data){ closeTownMenu(); return; }

      // Build menu
      townMenu.innerHTML = "";
      data.forEach(row=>{
        const btn=document.createElement("button");
        btn.type="button";
        btn.className="text-sm";
        btn.textContent = `${row.town_city} — ${row.county}`;
        btn.addEventListener("click", ()=>{
          townInput.value = row.town_city;           // show name only
          countyInput.value = row.county || "";      // show county read-only
          locationIdInput.value = row.id;            // store id for insert
          closeTownMenu();
        });
        townMenu.appendChild(btn);
      });
      townMenu.classList.remove("hidden");
    }, 250);

    townInput.addEventListener("input", searchLocation);
    townInput.addEventListener("focus", ()=>{ if(townInput.value.trim().length>=2) searchLocation(); });
    document.addEventListener("click",(e)=>{ if(!e.target.closest(".dropdown")) closeTownMenu(); });

    // Submit
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      formFeedback.textContent=""; formFeedback.className="mt-4 text-sm font-medium";

      // Require a valid selection from autocomplete
      const location_id = locationIdInput.value.trim();
      if(!location_id){
        formFeedback.textContent="Please choose a Town/City from the list.";
        formFeedback.classList.add("text-amber-300");
        townInput.focus();
        return;
      }

      const payload = {
        venue_name: document.getElementById("venue_name").value.trim(),
        street_name: document.getElementById("street_name").value.trim(),
        location_id, // from hidden input
        postcode: document.getElementById("postcode").value.trim(),
        email_address: document.getElementById("email_address").value.trim(),
        telephone_number: document.getElementById("telephone_number").value.trim(),
        website_address: document.getElementById("website_address").value.trim()
      };

      const { data, error } = await supabase.from("venues").insert([payload]).select("*").single();

      if(error){
        formFeedback.textContent = `❌ ${error.message}`;
        formFeedback.classList.add("text-red-400");
      } else {
        formFeedback.textContent = "✅ Venue created successfully!";
        formFeedback.classList.add("text-green-400");
        form.reset();
        // also clear hidden/location UI
        locationIdInput.value=""; countyInput.value="";
        // show the created venue as selected
        selectVenue(data);
      }
    });
  </script>
</body>
</html>
