<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Venue – Spondle</title>
  <meta name="color-scheme" content="dark" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Shared layout (sticky header + sidebar) -->
  <script type="module" src="./spondle-layout.js"></script>

  <style>
    body {
      background-color: #0a0f1a;
      color: #e5e7eb;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    input, select {
      width: 100%;
      background-color: #111827;
      border: 1px solid #1f2937;
      border-radius: 0.5rem;
      padding: 0.6rem 0.8rem;
      color: #f3f4f6;
      transition: border 0.2s, box-shadow 0.2s;
    }

    input:focus, select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
      outline: none;
    }

    label {
      font-size: 0.9rem;
      color: #cbd5e1;
      display: block;
      margin-bottom: 0.25rem;
    }

    .btn {
      background-color: #22c55e;
      color: #000;
      font-weight: 600;
      border-radius: 0.5rem;
      padding: 0.7rem 1rem;
      width: 100%;
      transition: filter 0.15s;
    }

    .btn:hover {
      filter: brightness(1.1);
    }

    .hidden {
      display: none;
    }

    .form-section {
      background-color: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div id="main-content" class="max-w-2xl mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-4 text-white">Create a New Venue</h1>
    <p id="status" class="text-sm text-emerald-400 mb-4">Connecting to Supabase...</p>

    <!-- Search Section -->
    <div class="form-section">
      <label for="venue_search">Search for venue first</label>
      <input id="venue_search" type="text" placeholder="Start typing a venue name..." autocomplete="off" />
      <div id="venue_search_results" class="mt-3 text-sm text-gray-300"></div>
      <p class="text-xs text-gray-500 mt-2">If nothing matches, the add-venue form will appear below.</p>
    </div>

    <!-- Add Venue Section -->
    <div id="add_venue_block" class="form-section hidden">
      <h2 class="text-lg font-semibold text-white mb-3">Add New Venue</h2>
      <form id="add_venue_form" class="space-y-4">
        <div>
          <label for="venue_name">Venue Name</label>
          <input id="venue_name" type="text" required />
        </div>

        <div>
          <label for="street_name">Street Address</label>
          <input id="street_name" type="text" />
        </div>

        <div>
          <label for="town_city">Town / City</label>
          <input id="town_city" type="text" />
        </div>

        <div>
          <label for="postcode">Postcode</label>
          <input id="postcode" type="text" />
        </div>

        <div>
          <label for="email">Email</label>
          <input id="email" type="email" required />
        </div>

        <div>
          <label for="telephone">Telephone</label>
          <input id="telephone" type="text" />
        </div>

        <div>
          <label for="website">Website</label>
          <input id="website" type="url" placeholder="www.example.com" />
        </div>

        <button type="submit" class="btn mt-2">Create Venue</button>
      </form>
      <div id="form_message" class="mt-3 text-sm"></div>
    </div>
  </div>

  <script>
    // === SUPABASE INIT ===
    const supabaseUrl = 'https://jvuunvnbpdfrttusgelz.supabase.co';
    const supabaseKey = 'PASTE_YOUR_sb_publishable_KEY_HERE'; // your new publishable key
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const statusEl = document.getElementById('status');
    const searchInput = document.getElementById('venue_search');
    const resultsBox = document.getElementById('venue_search_results');
    const addBlock = document.getElementById('add_venue_block');
    const form = document.getElementById('add_venue_form');
    const msg = document.getElementById('form_message');

    // === CONNECTION TEST ===
    (async () => {
      try {
        const { error } = await supabase.from('venues').select('id').limit(1);
        if (error) throw error;
        statusEl.textContent = '✅ Connected to Supabase successfully';
        statusEl.classList.remove('text-rose-400');
        statusEl.classList.add('text-emerald-400');
      } catch (err) {
        statusEl.textContent = '❌ Supabase connection error: ' + err.message;
        statusEl.classList.remove('text-emerald-400');
        statusEl.classList.add('text-rose-400');
      }
    })();

    // === SEARCH ===
    const debounce = (fn, delay = 250) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    };

    const runSearch = debounce(async () => {
      const query = searchInput.value.trim();
      resultsBox.innerHTML = '';
      addBlock.classList.add('hidden');
      msg.textContent = '';

      if (query.length < 2) return;

      const { data, error } = await supabase
        .from('venues')
        .select('venue_name')
        .ilike('venue_name', `%${query}%`)
        .limit(10);

      if (error) {
        resultsBox.innerHTML = `<p class="text-rose-400">Error: ${error.message}</p>`;
        return;
      }

      if (data && data.length > 0) {
        const list = data.map(v => `<li class="text-gray-300">${v.venue_name}</li>`).join('');
        resultsBox.innerHTML = `
          <p class="text-amber-300 mb-2">${data.length} matching venue(s) found — please check before adding:</p>
          <ul class="list-disc list-inside">${list}</ul>`;
      } else {
        resultsBox.innerHTML = `<p class="text-emerald-400">No results — you can add it below.</p>`;
        addBlock.classList.remove('hidden');
        document.getElementById('venue_name').value = query;
      }
    }, 300);

    searchInput.addEventListener('input', runSearch);

    // === SUBMIT VENUE ===
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      msg.className = 'mt-3 text-sm';

      const payload = {
        venue_name: document.getElementById('venue_name').value.trim(),
        street_name: document.getElementById('street_name').value.trim(),
        town_city: document.getElementById('town_city').value.trim(),
        postcode: document.getElementById('postcode').value.trim(),
        email: document.getElementById('email').value.trim(),
        telephone: document.getElementById('telephone').value.trim(),
        website: document.getElementById('website').value.trim(),
      };

      const { error } = await supabase.from('venues').insert([payload]);

      if (error) {
        msg.textContent = '❌ ' + error.message;
        msg.classList.add('text-rose-400');
      } else {
        msg.textContent = '✅ Venue created successfully.';
        msg.classList.add('text-emerald-400');
        form.reset();
        addBlock.classList.add('hidden');
        searchInput.value = '';
        resultsBox.innerHTML = '';
      }
    });
  </script>
</body>
</html>
